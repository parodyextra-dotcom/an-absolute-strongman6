<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#1e3a8a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ì ˆëŒ€ê°•ì">
  <meta name="description" content="ì ˆëŒ€ê°•ì ê°€ê³„ë¶€ - ìŠ¤ë§ˆíŠ¸í•œ ìì‚°ê´€ë¦¬">
  <title>ì ˆëŒ€ê°•ì ê°€ê³„ë¶€</title>
  
  <!-- Luxury App Icon -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cdefs%3E%3ClinearGradient id='bg' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23ffd700'/%3E%3Cstop offset='50%25' style='stop-color:%23ffec8b'/%3E%3Cstop offset='100%25' style='stop-color:%23daa520'/%3E%3C/linearGradient%3E%3ClinearGradient id='pigBody' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23ffd700'/%3E%3Cstop offset='30%25' style='stop-color:%23ffec8b'/%3E%3Cstop offset='70%25' style='stop-color:%23ffd700'/%3E%3Cstop offset='100%25' style='stop-color:%23b8860b'/%3E%3C/linearGradient%3E%3ClinearGradient id='pigNose' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23ffb6c1'/%3E%3Cstop offset='100%25' style='stop-color:%23ff69b4'/%3E%3C/linearGradient%3E%3Cfilter id='shadow'%3E%3CfeDropShadow dx='0' dy='8' stdDeviation='12' flood-color='%23000' flood-opacity='0.3'/%3E%3C/filter%3E%3Cfilter id='glow'%3E%3CfeGaussianBlur stdDeviation='4' result='coloredBlur'/%3E%3CfeMerge%3E%3CfeMergeNode in='coloredBlur'/%3E%3CfeMergeNode in='SourceGraphic'/%3E%3C/feMerge%3E%3C/filter%3E%3C/defs%3E%3Crect width='512' height='512' rx='100' fill='url(%23bg)'/%3E%3Cellipse cx='256' cy='280' rx='140' ry='120' fill='url(%23pigBody)' filter='url(%23shadow)'/%3E%3Cellipse cx='180' cy='180' rx='35' ry='50' fill='url(%23pigBody)' transform='rotate(-20 180 180)'/%3E%3Cellipse cx='332' cy='180' rx='35' ry='50' fill='url(%23pigBody)' transform='rotate(20 332 180)'/%3E%3Cellipse cx='256' cy='300' rx='50' ry='35' fill='url(%23pigNose)'/%3E%3Ccircle cx='240' cy='295' r='8' fill='%23b8860b'/%3E%3Ccircle cx='272' cy='295' r='8' fill='%23b8860b'/%3E%3Ccircle cx='210' cy='240' r='18' fill='%23000'/%3E%3Ccircle cx='302' cy='240' r='18' fill='%23000'/%3E%3Ccircle cx='215' cy='235' r='6' fill='%23fff'/%3E%3Ccircle cx='307' cy='235' r='6' fill='%23fff'/%3E%3Crect x='230' y='120' width='52' height='25' rx='5' fill='%23daa520'/%3E%3Ctext x='256' y='480' text-anchor='middle' font-size='40' font-weight='bold' fill='%23b8860b' filter='url(%23glow)'%3Eì ˆëŒ€ê°•ì%3C/text%3E%3C/svg%3E">
  
  <!-- Apple Touch Icon -->
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cdefs%3E%3ClinearGradient id='bg' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23ffd700'/%3E%3Cstop offset='50%25' style='stop-color:%23ffec8b'/%3E%3Cstop offset='100%25' style='stop-color:%23daa520'/%3E%3C/linearGradient%3E%3ClinearGradient id='pigBody' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23ffd700'/%3E%3Cstop offset='30%25' style='stop-color:%23ffec8b'/%3E%3Cstop offset='70%25' style='stop-color:%23ffd700'/%3E%3Cstop offset='100%25' style='stop-color:%23b8860b'/%3E%3C/linearGradient%3E%3ClinearGradient id='pigNose' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23ffb6c1'/%3E%3Cstop offset='100%25' style='stop-color:%23ff69b4'/%3E%3C/linearGradient%3E%3Cfilter id='shadow'%3E%3CfeDropShadow dx='0' dy='8' stdDeviation='12' flood-color='%23000' flood-opacity='0.3'/%3E%3C/filter%3E%3Cfilter id='glow'%3E%3CfeGaussianBlur stdDeviation='4' result='coloredBlur'/%3E%3CfeMerge%3E%3CfeMergeNode in='coloredBlur'/%3E%3CfeMergeNode in='SourceGraphic'/%3E%3C/feMerge%3E%3C/filter%3E%3C/defs%3E%3Crect width='512' height='512' rx='100' fill='url(%23bg)'/%3E%3Cellipse cx='256' cy='280' rx='140' ry='120' fill='url(%23pigBody)' filter='url(%23shadow)'/%3E%3Cellipse cx='180' cy='180' rx='35' ry='50' fill='url(%23pigBody)' transform='rotate(-20 180 180)'/%3E%3Cellipse cx='332' cy='180' rx='35' ry='50' fill='url(%23pigBody)' transform='rotate(20 332 180)'/%3E%3Cellipse cx='256' cy='300' rx='50' ry='35' fill='url(%23pigNose)'/%3E%3Ccircle cx='240' cy='295' r='8' fill='%23b8860b'/%3E%3Ccircle cx='272' cy='295' r='8' fill='%23b8860b'/%3E%3Ccircle cx='210' cy='240' r='18' fill='%23000'/%3E%3Ccircle cx='302' cy='240' r='18' fill='%23000'/%3E%3Ccircle cx='215' cy='235' r='6' fill='%23fff'/%3E%3Ccircle cx='307' cy='235' r='6' fill='%23fff'/%3E%3Crect x='230' y='120' width='52' height='25' rx='5' fill='%23daa520'/%3E%3Ctext x='256' y='480' text-anchor='middle' font-size='40' font-weight='bold' fill='%23b8860b' filter='url(%23glow)'%3Eì ˆëŒ€ê°•ì%3C/text%3E%3C/svg%3E">
  
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  
  <!-- PWA Manifest -->
  <script>
    const manifest = {
      name: "ì ˆëŒ€ê°•ì ê°€ê³„ë¶€",
      short_name: "ì ˆëŒ€ê°•ì",
      description: "ìŠ¤ë§ˆíŠ¸í•œ ìì‚°ê´€ë¦¬ ì•±",
      start_url: "./",
      display: "standalone",
      background_color: "#ffd700",
      theme_color: "#daa520",
      orientation: "portrait",
      icons: [
        {
          src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cdefs%3E%3ClinearGradient id='bg' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23ffd700'/%3E%3Cstop offset='50%25' style='stop-color:%23ffec8b'/%3E%3Cstop offset='100%25' style='stop-color:%23daa520'/%3E%3C/linearGradient%3E%3ClinearGradient id='pigBody' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23ffd700'/%3E%3Cstop offset='30%25' style='stop-color:%23ffec8b'/%3E%3Cstop offset='70%25' style='stop-color:%23ffd700'/%3E%3Cstop offset='100%25' style='stop-color:%23b8860b'/%3E%3C/linearGradient%3E%3ClinearGradient id='pigNose' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23ffb6c1'/%3E%3Cstop offset='100%25' style='stop-color:%23ff69b4'/%3E%3C/linearGradient%3E%3Cfilter id='shadow'%3E%3CfeDropShadow dx='0' dy='8' stdDeviation='12' flood-color='%23000' flood-opacity='0.3'/%3E%3C/filter%3E%3C/defs%3E%3Crect width='512' height='512' rx='100' fill='url(%23bg)'/%3E%3Cellipse cx='256' cy='280' rx='140' ry='120' fill='url(%23pigBody)' filter='url(%23shadow)'/%3E%3Cellipse cx='180' cy='180' rx='35' ry='50' fill='url(%23pigBody)' transform='rotate(-20 180 180)'/%3E%3Cellipse cx='332' cy='180' rx='35' ry='50' fill='url(%23pigBody)' transform='rotate(20 332 180)'/%3E%3Cellipse cx='256' cy='300' rx='50' ry='35' fill='url(%23pigNose)'/%3E%3Ccircle cx='240' cy='295' r='8' fill='%23b8860b'/%3E%3Ccircle cx='272' cy='295' r='8' fill='%23b8860b'/%3E%3Ccircle cx='210' cy='240' r='18' fill='%23000'/%3E%3Ccircle cx='302' cy='240' r='18' fill='%23000'/%3E%3Ccircle cx='215' cy='235' r='6' fill='%23fff'/%3E%3Ccircle cx='307' cy='235' r='6' fill='%23fff'/%3E%3Crect x='230' y='120' width='52' height='25' rx='5' fill='%23daa520'/%3E%3Ctext x='256' y='480' text-anchor='middle' font-size='40' font-weight='bold' fill='%23b8860b'%3Eì ˆëŒ€ê°•ì%3C/text%3E%3C/svg%3E",
          sizes: "512x512",
          type: "image/svg+xml",
          purpose: "any maskable"
        },
        {
          src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Cdefs%3E%3ClinearGradient id='bg' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23ffd700'/%3E%3Cstop offset='50%25' style='stop-color:%23ffec8b'/%3E%3Cstop offset='100%25' style='stop-color:%23daa520'/%3E%3C/linearGradient%3E%3ClinearGradient id='pigBody' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23ffd700'/%3E%3Cstop offset='50%25' style='stop-color:%23ffec8b'/%3E%3Cstop offset='100%25' style='stop-color:%23b8860b'/%3E%3C/linearGradient%3E%3ClinearGradient id='pigNose' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23ffb6c1'/%3E%3Cstop offset='100%25' style='stop-color:%23ff69b4'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='192' height='192' rx='40' fill='url(%23bg)'/%3E%3Cellipse cx='96' cy='105' rx='52' ry='45' fill='url(%23pigBody)'/%3E%3Cellipse cx='68' cy='65' rx='13' ry='18' fill='url(%23pigBody)' transform='rotate(-20 68 65)'/%3E%3Cellipse cx='124' cy='65' rx='13' ry='18' fill='url(%23pigBody)' transform='rotate(20 124 65)'/%3E%3Cellipse cx='96' cy='115' rx='18' ry='13' fill='url(%23pigNose)'/%3E%3Ccircle cx='90' cy='112' r='3' fill='%23b8860b'/%3E%3Ccircle cx='102' cy='112' r='3' fill='%23b8860b'/%3E%3Ccircle cx='78' cy='92' r='7' fill='%23000'/%3E%3Ccircle cx='114' cy='92' r='7' fill='%23000'/%3E%3Ccircle cx='80' cy='90' r='2' fill='%23fff'/%3E%3Ccircle cx='116' cy='90' r='2' fill='%23fff'/%3E%3Crect x='84' y='42' width='24' height='12' rx='3' fill='%23daa520'/%3E%3C/svg%3E",
          sizes: "192x192",
          type: "image/svg+xml",
          purpose: "any maskable"
        }
      ]
    };
    const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
    const manifestURL = URL.createObjectURL(manifestBlob);
    const link = document.createElement('link');
    link.rel = 'manifest';
    link.href = manifestURL;
    document.head.appendChild(link);
  </script>
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body class="bg-gray-50">
  <div id="app" class="max-w-md mx-auto bg-gray-50 min-h-screen pb-20"></div>

  <script>
    // State Management
    var state = {
      activeTab: 'home',
      transactions: [],
      memos: [],
      events: [],
      goals: { year7: '', year5: '', year3: '', thisYear: '' },
      bankBalances: [],
      investments: [],
      dividends: [],
      investmentJournals: [],
      loans: [],
      showAddDividend: false,
      showAddJournal: false,
      dividendPeriod: 'all',
      dividendSearchKeyword: '',
      exchangeTab: 'USD',
      usdPhases: [],
      jpyPhases: [],
      usdRate: 1380,
      jpyRate: 920,
      usdNextId: 1,
      jpyNextId: 1,
      expandedPhase: null,
      showExchangeStats: false,
      exchangeStatsPeriod: 'yearly',
      exchangeStatsStartDate: '',
      exchangeStatsEndDate: '',
      soldItemsVisible: 10,
      usdInitialBudget: 10000000,
      jpyInitialBudget: 10000000,
      categories: {
        expense: ['ì‹ë¹„', 'êµí†µë¹„', 'í†µì‹ ë¹„', 'ìƒí™œìš©í’ˆ', 'ì˜ë£Œë¹„', 'êµìœ¡ë¹„', 'ë¬¸í™”ìƒí™œ', 'ì•„ë²„ì§€', 'ì§€í™˜', 'ë‹¤í˜œ', 'ë‹¤ì—°', 'ë³´í—˜ë£Œ', 'ì™¸ì‹ë¹„', 'ì„¸ê¸ˆê³µê³¼ê¸ˆ', 'ì£¼ìœ ë¹„', 'ëŒ€ì¶œìƒí™˜', 'ê¸°íƒ€ë¹„'],
        income: ['ê¸‰ì—¬', 'ì´ì', 'ëŒ€ë¦¬ì—…ë¬´', 'ë°°ë‹¹ê¸ˆ', 'ê¸°íƒ€ìˆ˜ì…'],
        fixedExpense: ['ë³´í—˜ë£Œ', 'ì§€í™˜', 'ë‹¤í˜œ', 'ë¶€ëª¨ë‹˜', 'ê¸°íƒ€ë¹„']
      },
      fixedExpenses: [],
      undoStack: [],
      showAddTransaction: false,
      showCompoundCalc: false,
      showSettings: false,
      showAddInvestment: false,
      showRankInfo: false,
      showIframeModal: false,
      isLoading: true
    };

    // Storage helpers
    var storage = {
      get: function(key) {
        try {
          var value = localStorage.getItem(key);
          return value ? JSON.parse(value) : null;
        } catch (e) { return null; }
      },
      set: function(key, value) {
        try {
          localStorage.setItem(key, JSON.stringify(value));
        } catch (e) { console.error('Storage error:', e); }
      }
    };

    // Check and add automatic installment payments
    function checkAutoInstallments() {
      var today = new Date();
      var currentYear = today.getFullYear();
      var currentMonth = today.getMonth();
      
      // ê³ ìœ í•œ í• ë¶€ ì‹œë¦¬ì¦ˆ ì°¾ê¸° (startDate + originalAmount ì¡°í•©ìœ¼ë¡œ ê·¸ë£¹í™”)
      var uniqueInstallments = {};
      state.transactions.filter(function(t) {
        return t.installmentInfo && t.installmentInfo.total > 1 && t.installmentInfo.startDate;
      }).forEach(function(t) {
        var key = t.installmentInfo.startDate + '_' + t.installmentInfo.originalAmount;
        if (!uniqueInstallments[key]) {
          uniqueInstallments[key] = {
            info: t.installmentInfo,
            isNecessary: t.isNecessary,
            existingMonths: []
          };
        }
        // ì´ë¯¸ ì…ë ¥ëœ íšŒì°¨ ê¸°ë¡
        uniqueInstallments[key].existingMonths.push(t.installmentInfo.current);
      });
      
      var totalAdded = 0;
      
      // ê° ê³ ìœ  í• ë¶€ ì‹œë¦¬ì¦ˆì— ëŒ€í•´ ì²˜ë¦¬
      Object.keys(uniqueInstallments).forEach(function(key) {
        var data = uniqueInstallments[key];
        var info = data.info;
        var startDate = new Date(info.startDate);
        var startYear = startDate.getFullYear();
        var startMonth = startDate.getMonth();
        var startDay = startDate.getDate();
        var totalInstallments = info.total;
        var monthlyAmount = info.monthlyAmount;
        var originalMemo = info.originalMemo;
        var originalCategory = info.originalCategory;
        
        // ì‹œì‘ì›”ë¶€í„° í˜„ì¬ì›”ê¹Œì§€ ëª‡ ê°œì›” ê²½ê³¼í–ˆëŠ”ì§€ ê³„ì‚°
        var monthsPassed = (currentYear - startYear) * 12 + (currentMonth - startMonth);
        
        // í˜„ì¬ ë‹¬ê¹Œì§€ ì…ë ¥í•´ì•¼ í•  íšŒì°¨ (ìµœëŒ€ totalê¹Œì§€)
        // monthsPassedê°€ 0ì´ë©´ ì²« ë‹¬, 1ì´ë©´ 2ë²ˆì§¸ ë‹¬...
        var shouldHaveInstallments = Math.min(monthsPassed + 1, totalInstallments);
        
        // 1íšŒì°¨ë¶€í„° shouldHaveInstallmentsê¹Œì§€ ê° íšŒì°¨ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ì—†ìœ¼ë©´ ì¶”ê°€
        for (var i = 1; i <= shouldHaveInstallments; i++) {
          if (data.existingMonths.indexOf(i) === -1) {
            // í•´ë‹¹ íšŒì°¨ê°€ ì—†ìœ¼ë©´ ì¶”ê°€
            var installmentDate = new Date(startYear, startMonth + (i - 1), startDay);
            var dateStr = installmentDate.getFullYear() + '-' + 
                          String(installmentDate.getMonth() + 1).padStart(2, '0') + '-' + 
                          String(installmentDate.getDate()).padStart(2, '0');
            
            var newTransaction = {
              id: Date.now() + Math.random() + i,
              type: 'expense',
              date: dateStr,
              amount: monthlyAmount,
              category: originalCategory,
              memo: originalMemo ? originalMemo + ' (' + i + '/' + totalInstallments + 'íšŒì°¨)' : 'í• ë¶€ ' + i + '/' + totalInstallments + 'íšŒì°¨',
              paymentMethod: 'card',
              installment: totalInstallments,
              installmentInfo: {
                current: i,
                total: totalInstallments,
                originalAmount: info.originalAmount,
                startDate: info.startDate,
                monthlyAmount: monthlyAmount,
                originalMemo: originalMemo,
                originalCategory: originalCategory
              },
              isNecessary: data.isNecessary
            };
            
            state.transactions.push(newTransaction);
            totalAdded++;
          }
        }
      });
      
      if (totalAdded > 0) {
        saveData();
        showToast(totalAdded + 'ê±´ì˜ í• ë¶€ê¸ˆì´ ìë™ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    }

    // Check and add automatic fixed expenses
    function checkAutoFixedExpenses() {
      var today = new Date();
      var currentYear = today.getFullYear();
      var currentMonth = today.getMonth();
      var currentDay = today.getDate();
      var totalAdded = 0;
      
      state.fixedExpenses.forEach(function(fe) {
        if (!fe.active) return;
        
        var startDate = new Date(fe.startDate);
        var endDate = fe.endDate ? new Date(fe.endDate) : new Date('2099-12-31');
        
        // ì‹œì‘ì¼ë¶€í„° í˜„ì¬ê¹Œì§€ ë˜ëŠ” ì¢…ë£Œì¼ê¹Œì§€ì˜ ëª¨ë“  ì›” ì²´í¬
        var checkDate = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
        var endCheckDate = new Date(Math.min(today.getTime(), endDate.getTime()));
        
        while (checkDate <= endCheckDate) {
          var checkYear = checkDate.getFullYear();
          var checkMonth = checkDate.getMonth();
          
          // í˜„ì¬ ë‹¬ì´ê±°ë‚˜ ì§€ë‚œ ë‹¬ì¸ ê²½ìš°ì—ë§Œ ì²˜ë¦¬
          if (checkYear < currentYear || (checkYear === currentYear && checkMonth <= currentMonth)) {
            // í•´ë‹¹ ì›”ì˜ ì¶œê¸ˆì¼
            var paymentDate = new Date(checkYear, checkMonth, fe.payDay);
            
            // ì‹œì‘ì¼ ì´í›„ì´ê³  ì¢…ë£Œì¼ ì´ì „ì¸ ê²½ìš°ì—ë§Œ
            if (paymentDate >= startDate && paymentDate <= endDate) {
              var dateString = paymentDate.toISOString().split('T')[0];
              
              // ì´ë¯¸ ì…ë ¥ëœ ê±°ë˜ê°€ ìˆëŠ”ì§€ í™•ì¸
              var existingTransaction = state.transactions.find(function(t) {
                return t.fixedExpenseId === fe.id && t.date === dateString;
              });
              
              if (!existingTransaction) {
                // ì˜¤ëŠ˜ ì´ì „ì´ê±°ë‚˜ ì˜¤ëŠ˜ì´ê³  ì¶œê¸ˆì¼ì´ ì§€ë‚¬ìœ¼ë©´ ì…ë ¥
                if (paymentDate < today || (checkYear === currentYear && checkMonth === currentMonth && currentDay >= fe.payDay)) {
                  var newTransaction = {
                    id: Date.now() + Math.random(),
                    type: 'expense',
                    date: dateString,
                    amount: fe.amount,
                    category: fe.category,
                    memo: fe.memo ? fe.memo + ' (ê³ ì •ë¹„)' : 'ê³ ì •ë¹„',
                    paymentMethod: fe.paymentMethod,
                    installment: 0,
                    isNecessary: true,
                    fixedExpenseId: fe.id
                  };
                  state.transactions.push(newTransaction);
                  totalAdded++;
                }
              }
            }
          }
          
          // ë‹¤ìŒ ë‹¬ë¡œ ì´ë™
          checkDate.setMonth(checkDate.getMonth() + 1);
        }
      });
      
      if (totalAdded > 0) {
        saveData();
        showToast(totalAdded + 'ê±´ì˜ ê³ ì •ë¹„ê°€ ìë™ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    }

    // Check and add automatic loan repayments
    function checkAutoLoanRepayments() {
      var today = new Date();
      var currentYear = today.getFullYear();
      var currentMonth = today.getMonth();
      var currentDay = today.getDate();
      
      state.loans.forEach(function(loan) {
        if (!loan.monthlyPayment || loan.monthlyPayment <= 0) return;
        if (!loan.payDay) return;
        
        // Check if repayment date has passed
        if (loan.repayDate) {
          var repayEnd = new Date(loan.repayDate);
          if (today > repayEnd) return; // Loan already fully repaid
        }
        
        // Check if loan start date has passed
        if (loan.loanDate) {
          var loanStart = new Date(loan.loanDate);
          if (today < loanStart) return; // Loan hasn't started yet
        }
        
        // Check if today is the payment day or has passed this month
        if (currentDay >= loan.payDay) {
          var repaymentDate = new Date(currentYear, currentMonth, loan.payDay);
          var dateString = repaymentDate.toISOString().split('T')[0];
          
          // Check if transaction already exists for this month
          var existingTransaction = state.transactions.find(function(t) {
            return t.type === 'expense' && 
                   t.category === 'ëŒ€ì¶œìƒí™˜' && 
                   t.date === dateString && 
                   t.memo && t.memo.indexOf(loan.name) >= 0;
          });
          
          if (!existingTransaction) {
            // Add automatic repayment transaction
            var newTransaction = {
              id: Date.now() + Math.random(),
              type: 'expense',
              date: dateString,
              amount: loan.monthlyPayment,
              category: 'ëŒ€ì¶œìƒí™˜',
              memo: loan.name + ' ì›”ìƒí™˜ê¸ˆ (ìë™)',
              paymentMethod: 'cash',
              installment: 0,
              isNecessary: true
            };
            state.transactions.push(newTransaction);
            saveData();
            showToast(loan.name + ' ì›”ìƒí™˜ê¸ˆì´ ìë™ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
          }
        }
      });
    }

    // Load data
    function loadData() {
      state.transactions = storage.get('transactions') || [];
      state.memos = storage.get('memos') || [];
      state.events = storage.get('events') || [];
      state.goals = storage.get('goals') || { year7: '', year5: '', year3: '', thisYear: '' };
      state.bankBalances = storage.get('bankBalances') || [];
      state.investments = storage.get('investments') || [];
      state.dividends = storage.get('dividends') || [];
      state.investmentJournals = storage.get('investmentJournals') || [];
      state.loans = storage.get('loans') || [];
      state.fixedExpenses = storage.get('fixedExpenses') || [];
      state.categories = storage.get('categories') || state.categories;
      var exchangeData = storage.get('exchangeData');
      if (exchangeData) {
        state.usdPhases = exchangeData.usdPhases || [];
        state.jpyPhases = exchangeData.jpyPhases || [];
        state.usdRate = exchangeData.usdRate || 1380;
        state.jpyRate = exchangeData.jpyRate || 920;
        state.usdNextId = exchangeData.usdNextId || 1;
        state.jpyNextId = exchangeData.jpyNextId || 1;
        state.usdInitialBudget = exchangeData.usdInitialBudget || 10000000;
        state.jpyInitialBudget = exchangeData.jpyInitialBudget || 10000000;
      }
      state.isLoading = false;
      
      // Check for automatic installment payments
      checkAutoInstallments();
      
      // Check for automatic loan repayments
      checkAutoLoanRepayments();
      
      // Check for automatic fixed expenses
      checkAutoFixedExpenses();
      
      render();
    }

    // Save data
    function saveData() {
      storage.set('transactions', state.transactions);
      storage.set('memos', state.memos);
      storage.set('events', state.events);
      storage.set('goals', state.goals);
      storage.set('bankBalances', state.bankBalances);
      storage.set('investments', state.investments);
      storage.set('dividends', state.dividends);
      storage.set('investmentJournals', state.investmentJournals);
      storage.set('loans', state.loans);
      storage.set('fixedExpenses', state.fixedExpenses);
      storage.set('categories', state.categories);
      storage.set('exchangeData', {
        usdPhases: state.usdPhases,
        jpyPhases: state.jpyPhases,
        usdRate: state.usdRate,
        jpyRate: state.jpyRate,
        usdNextId: state.usdNextId,
        jpyNextId: state.jpyNextId,
        usdInitialBudget: state.usdInitialBudget,
        jpyInitialBudget: state.jpyInitialBudget
      });
    }

    // Toast notification
    var toastTimeout;
    function showToast(message, type) {
      type = type || 'success';
      var existing = document.getElementById('toast');
      if (existing) existing.remove();
      
      var toast = document.createElement('div');
      toast.id = 'toast';
      toast.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 px-4 py-3 rounded-lg shadow-lg z-50 ' + 
        (type === 'error' ? 'bg-red-500' : 'bg-green-500') + ' text-white font-medium animate-fade-in';
      toast.textContent = message;
      document.body.appendChild(toast);
      
      clearTimeout(toastTimeout);
      toastTimeout = setTimeout(function() { toast.remove(); }, 3000);
    }

    // Utility functions
    function formatNumber(num) {
      return num.toLocaleString();
    }

    // Format input with commas
    function formatAmountInput(input) {
      var value = input.value.replace(/[^\d]/g, '');
      if (value === '') {
        input.value = '';
        return;
      }
      var num = parseInt(value, 10);
      input.value = num.toLocaleString();
    }

    // Get numeric value from formatted input
    function getAmountValue(inputId) {
      var input = document.getElementById(inputId);
      if (!input) return 0;
      var value = input.value.replace(/[^\d]/g, '');
      return parseInt(value, 10) || 0;
    }

    // Format quantity input (allows decimal)
    function formatQuantityInput(input) {
      var value = input.value.replace(/[^\d.]/g, '');
      // Only allow one decimal point
      var parts = value.split('.');
      if (parts.length > 2) {
        value = parts[0] + '.' + parts.slice(1).join('');
      }
      input.value = value;
    }

    // Get quantity value (allows decimal)
    function getQuantityValue(inputId) {
      var input = document.getElementById(inputId);
      if (!input) return 0;
      var value = input.value.replace(/[^\d.]/g, '');
      return parseFloat(value) || 0;
    }

    function getRankInfo(balance) {
      if (balance >= 500000000) return { rank: 'ì ˆëŒ€ê°•ì', color: 'text-purple-600', bgColor: 'bg-purple-100', icon: 'ğŸ‘‘' };
      if (balance >= 200000000) return { rank: 'ì†Œë¶€ì', color: 'text-blue-600', bgColor: 'bg-blue-100', icon: 'ğŸ’' };
      if (balance >= 100000000) return { rank: 'ì¤‘ì‚°ì¸µ', color: 'text-green-600', bgColor: 'bg-green-100', icon: 'ğŸ†' };
      if (balance >= 50000000) return { rank: 'ì„œë¯¼', color: 'text-yellow-600', bgColor: 'bg-yellow-100', icon: 'â­' };
      if (balance >= 10000000) return { rank: 'ì°¨ìƒìœ„ì', color: 'text-orange-600', bgColor: 'bg-orange-100', icon: 'ğŸ”¶' };
      return { rank: 'ê¸°ì´ˆìˆ˜ê¸‰ì', color: 'text-gray-600', bgColor: 'bg-gray-100', icon: 'ğŸŒ±' };
    }

    function getInvestGrade(totalProfit, totalInvested) {
      if (totalInvested === 0) return { grade: 'ì´ˆë³´', color: 'text-gray-600', bg: 'bg-gray-100' };
      var rate = (totalProfit / totalInvested) * 100;
      if (rate < 0) return { grade: 'ì†ì‹¤', color: 'text-gray-700', bg: 'bg-gray-200' };
      if (rate < 10) return { grade: 'í•˜ìˆ˜', color: 'text-blue-700', bg: 'bg-blue-100' };
      if (rate < 20) return { grade: 'ì¤‘ìˆ˜', color: 'text-green-700', bg: 'bg-green-100' };
      if (rate < 30) return { grade: 'ê³ ìˆ˜', color: 'text-purple-700', bg: 'bg-purple-100' };
      if (rate < 50) return { grade: 'ì‹¤ë²„', color: 'text-slate-700', bg: 'bg-slate-200' };
      if (rate < 60) return { grade: 'ê³¨ë“œ', color: 'text-yellow-700', bg: 'bg-yellow-100' };
      return { grade: 'íˆ¬ìì˜ ì‹ ', color: 'text-red-700', bg: 'bg-gradient-to-r from-yellow-200 to-red-200' };
    }

    function addToUndoStack(action, data) {
      state.undoStack.push({ action: action, data: data, timestamp: Date.now() });
      if (state.undoStack.length > 10) state.undoStack.shift();
    }

    function handleUndo() {
      if (state.undoStack.length === 0) return;
      var lastAction = state.undoStack.pop();
      
      if (lastAction.action === 'deleteTransaction') {
        state.transactions.push(lastAction.data);
        showToast('ê±°ë˜ ì‚­ì œë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤');
      } else if (lastAction.action === 'deleteMemo') {
        state.memos.push(lastAction.data);
        showToast('ë©”ëª¨ ì‚­ì œë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤');
      }
      saveData();
      render();
    }

    // Export/Import functions
    function exportData() {
      var data = {
        transactions: state.transactions,
        memos: state.memos,
        goals: state.goals,
        bankBalances: state.bankBalances,
        investments: state.investments,
        dividends: state.dividends,
        investmentJournals: state.investmentJournals,
        loans: state.loans,
        events: state.events,
        categories: state.categories,
        exchangeData: {
          usdPhases: state.usdPhases,
          jpyPhases: state.jpyPhases,
          usdRate: state.usdRate,
          jpyRate: state.jpyRate,
          usdNextId: state.usdNextId,
          jpyNextId: state.jpyNextId
        },
        exportDate: new Date().toISOString()
      };
      
      var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      var url = URL.createObjectURL(blob);
      var link = document.createElement('a');
      link.href = url;
      link.download = 'budget_backup_' + new Date().toISOString().split('T')[0] + '.json';
      link.click();
      URL.revokeObjectURL(url);
      showToast('ë°ì´í„°ê°€ ë°±ì—…ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function exportToCSV() {
      var headers = ['ë‚ ì§œ', 'ìœ í˜•', 'ì¹´í…Œê³ ë¦¬', 'ê¸ˆì•¡', 'ê²°ì œìˆ˜ë‹¨', 'í• ë¶€', 'í•„ìš”ì§€ì¶œ', 'ë©”ëª¨'];
      var rows = state.transactions.map(function(t) {
        return [
          t.date,
          t.type === 'income' ? 'ìˆ˜ì…' : 'ì§€ì¶œ',
          t.category,
          t.amount,
          t.paymentMethod === 'card' ? 'ì¹´ë“œ' : 'í˜„ê¸ˆ',
          t.installment || 'ì¼ì‹œë¶ˆ',
          t.isNecessary ? 'í•„ìš”' : 'ë¶ˆí•„ìš”',
          t.memo || ''
        ];
      });

      var csvContent = [headers].concat(rows)
        .map(function(row) { return row.map(function(cell) { return '"' + cell + '"'; }).join(','); })
        .join('\n');

      var BOM = '\uFEFF';
      var blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
      var url = URL.createObjectURL(blob);
      var link = document.createElement('a');
      link.href = url;
      link.download = 'ê±°ë˜ë‚´ì—­_' + new Date().toISOString().split('T')[0] + '.csv';
      link.click();
      URL.revokeObjectURL(url);
      showToast('CSV íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function importData(event) {
      var file = event.target.files[0];
      if (!file) return;

      var reader = new FileReader();
      reader.onload = function(e) {
        try {
          var data = JSON.parse(e.target.result);
          if (!data.transactions || !Array.isArray(data.transactions)) {
            throw new Error('ì˜ëª»ëœ ë°ì´í„° í˜•ì‹');
          }

          if (confirm('í˜„ì¬ ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ê³  ê°€ì ¸ì˜¨ ë°ì´í„°ë¡œ êµì²´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            state.transactions = data.transactions || [];
            state.memos = data.memos || [];
            state.goals = data.goals || { year7: '', year5: '', year3: '', thisYear: '' };
            state.bankBalances = data.bankBalances || [];
            state.investments = data.investments || [];
            state.dividends = data.dividends || [];
            state.investmentJournals = data.investmentJournals || [];
            state.loans = data.loans || [];
            state.events = data.events || [];
            if (data.categories) state.categories = data.categories;
            if (data.exchangeData) {
              state.usdPhases = data.exchangeData.usdPhases || [];
              state.jpyPhases = data.exchangeData.jpyPhases || [];
              state.usdRate = data.exchangeData.usdRate || 1380;
              state.jpyRate = data.exchangeData.jpyRate || 920;
              state.usdNextId = data.exchangeData.usdNextId || 1;
              state.jpyNextId = data.exchangeData.jpyNextId || 1;
            }
            saveData();
            render();
            showToast('ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤');
          }
        } catch (error) {
          showToast('ë°ì´í„° ê°€ì ¸ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    // Render Header
    function renderHeader() {
      var totalBankBalance = state.bankBalances.reduce(function(sum, b) { return sum + b.balance; }, 0);
      var rankInfo = getRankInfo(totalBankBalance);
      
      return '<div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-4 sticky top-0 z-10 shadow-lg">' +
        '<div class="flex justify-between items-center">' +
          '<h1 class="text-xl font-bold">ì ˆëŒ€ê°•ì ê°€ê³„ë¶€</h1>' +
          '<div class="flex items-center gap-2">' +
            '<button onclick="state.showIframeModal=true;render()" class="bg-white text-blue-600 px-3 py-1 rounded-full text-sm font-bold hover:bg-blue-50 transition shadow-md">ê³„ì‚°</button>' +
            '<button onclick="state.showSettings=true;render()" class="bg-white text-blue-600 p-2 rounded-full hover:bg-blue-50 transition shadow-md">' +
              '<i data-lucide="settings" class="w-4 h-4"></i>' +
            '</button>' +
            '<button onclick="state.showRankInfo=true;render()" class="' + rankInfo.bgColor + ' px-3 py-1 rounded-full flex items-center gap-1 shadow-md hover:scale-105 transition cursor-pointer">' +
              '<span class="text-base">' + rankInfo.icon + '</span>' +
              '<span class="text-sm font-bold ' + rankInfo.color + '">' + rankInfo.rank + '</span>' +
            '</button>' +
          '</div>' +
        '</div>' +
      '</div>';
    }
    
    // Rank Info Modal
    function renderRankInfoModal() {
      var totalBankBalance = state.bankBalances.reduce(function(sum, b) { return sum + b.balance; }, 0);
      var currentRankInfo = getRankInfo(totalBankBalance);
      
      var ranks = [
        { rank: 'ì ˆëŒ€ê°•ì', min: 500000000, icon: 'ğŸ‘‘', color: 'from-purple-500 to-indigo-600', textColor: 'text-purple-700', bgColor: 'bg-purple-100', desc: '5ì–µ ì´ìƒì˜ ìì‚°ì„ ë³´ìœ í•œ ìµœìƒìœ„ ë“±ê¸‰ì…ë‹ˆë‹¤. ì§„ì •í•œ ìì‚°ê°€ì˜ ë°˜ì—´ì— ì˜¬ëìŠµë‹ˆë‹¤!', benefit: 'ì¬ì •ì  ììœ  ë‹¬ì„±! ì–´ë–¤ ìƒí™©ì—ì„œë„ í”ë“¤ë¦¬ì§€ ì•ŠëŠ” ë“ ë“ í•œ ìì‚°' },
        { rank: 'ì†Œë¶€ì', min: 200000000, icon: 'ğŸ’', color: 'from-blue-500 to-cyan-500', textColor: 'text-blue-700', bgColor: 'bg-blue-100', desc: '2ì–µ ì´ìƒì˜ ìì‚°ìœ¼ë¡œ ì†Œë¶€ì ë“±ê¸‰ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤. ì•ˆì •ì ì¸ ìì‚° ê¸°ë°˜ì„ ê°–ì¶”ì—ˆìŠµë‹ˆë‹¤.', benefit: 'íˆ¬ì í¬íŠ¸í´ë¦¬ì˜¤ ë‹¤ê°í™” ê°€ëŠ¥, ë¶€ë™ì‚° íˆ¬ì ê¸°íšŒ' },
        { rank: 'ì¤‘ì‚°ì¸µ', min: 100000000, icon: 'ğŸ†', color: 'from-green-500 to-emerald-500', textColor: 'text-green-700', bgColor: 'bg-green-100', desc: '1ì–µ ì´ìƒì˜ ìì‚°ì„ ëª¨ì•„ ì¤‘ì‚°ì¸µì— ì§„ì…í–ˆìŠµë‹ˆë‹¤. ê¾¸ì¤€í•œ ë…¸ë ¥ì˜ ê²°ê³¼ì…ë‹ˆë‹¤!', benefit: 'ì£¼íƒ êµ¬ë§¤ ìê¸ˆ ë§ˆë ¨, ìë…€ êµìœ¡ë¹„ ì¤€ë¹„ ê°€ëŠ¥' },
        { rank: 'ì„œë¯¼', min: 50000000, icon: 'â­', color: 'from-yellow-500 to-orange-500', textColor: 'text-yellow-700', bgColor: 'bg-yellow-100', desc: '5ì²œë§Œì› ì´ìƒì˜ ìì‚°ì„ ë³´ìœ í•˜ê³  ìˆìŠµë‹ˆë‹¤. ëª©í‘œë¥¼ í–¥í•´ ê¾¸ì¤€íˆ ì „ì§„ ì¤‘ì…ë‹ˆë‹¤.', benefit: 'ë¹„ìƒê¸ˆ í™•ë³´ ì™„ë£Œ, íˆ¬ì ì‹œì‘ ê°€ëŠ¥ ìê¸ˆ' },
        { rank: 'ì°¨ìƒìœ„ì', min: 10000000, icon: 'ğŸ”¶', color: 'from-orange-500 to-red-500', textColor: 'text-orange-700', bgColor: 'bg-orange-100', desc: '1ì²œë§Œì› ì´ìƒì˜ ìì‚°ìœ¼ë¡œ ì„±ì¥ ì¤‘ì…ë‹ˆë‹¤. ì €ì¶• ìŠµê´€ì´ ì˜ ê°–ì¶°ì ¸ ìˆìŠµë‹ˆë‹¤.', benefit: 'ê¸°ì´ˆ ë¹„ìƒê¸ˆ ë§ˆë ¨, ì¬í…Œí¬ ì‹œì‘ ë‹¨ê³„' },
        { rank: 'ê¸°ì´ˆìˆ˜ê¸‰ì', min: 0, icon: 'ğŸŒ±', color: 'from-gray-500 to-slate-500', textColor: 'text-gray-700', bgColor: 'bg-gray-100', desc: 'ìì‚° í˜•ì„±ì˜ ì‹œì‘ ë‹¨ê³„ì…ë‹ˆë‹¤. ì‘ì€ ê¸ˆì•¡ë¶€í„° ì°¨ê·¼ì°¨ê·¼ ëª¨ì•„ê°€ì„¸ìš”!', benefit: 'ì„±ì¥ ê°€ëŠ¥ì„± ë¬´í•œëŒ€! ì§€ê¸ˆë¶€í„° ì‹œì‘í•˜ë©´ ë©ë‹ˆë‹¤' }
      ];
      
      // í˜„ì¬ ë“±ê¸‰ ì¸ë±ìŠ¤ ì°¾ê¸°
      var currentRankIndex = ranks.findIndex(function(r) { return r.rank === currentRankInfo.rank; });
      
      // ë‹¤ìŒ ë“±ê¸‰ ì •ë³´
      var nextRank = currentRankIndex > 0 ? ranks[currentRankIndex - 1] : null;
      var amountToNext = nextRank ? nextRank.min - totalBankBalance : 0;
      var progressToNext = nextRank ? Math.min((totalBankBalance / nextRank.min) * 100, 100) : 100;
      
      var ranksHtml = ranks.map(function(r, idx) {
        var isCurrent = r.rank === currentRankInfo.rank;
        var isAchieved = totalBankBalance >= r.min;
        
        return '<div class="' + (isCurrent ? 'ring-2 ring-offset-2 ring-purple-500 transform scale-[1.02]' : '') + ' ' + (isAchieved ? 'opacity-100' : 'opacity-50') + ' bg-gradient-to-r ' + r.color + ' rounded-2xl p-4 text-white relative overflow-hidden transition-all">' +
          (isCurrent ? '<div class="absolute top-2 right-2 bg-yellow-400 text-yellow-900 text-xs font-bold px-2 py-1 rounded-full shadow">í˜„ì¬ ë“±ê¸‰</div>' : '') +
          (isAchieved && !isCurrent ? '<div class="absolute top-2 right-2 bg-green-400 text-green-900 text-xs font-bold px-2 py-1 rounded-full">âœ“ ë‹¬ì„±</div>' : '') +
          '<div class="flex items-center gap-3 mb-3">' +
            '<div class="text-4xl">' + r.icon + '</div>' +
            '<div>' +
              '<div class="text-xl font-bold text-white drop-shadow">' + r.rank + '</div>' +
              '<div class="text-sm text-white font-medium">' + (r.min > 0 ? formatNumber(r.min) + 'ì› ì´ìƒ' : 'ì‹œì‘ ë“±ê¸‰') + '</div>' +
            '</div>' +
          '</div>' +
          '<div class="text-sm text-white font-medium mb-3 drop-shadow">' + r.desc + '</div>' +
          '<div class="bg-yellow-100 rounded-lg p-3 text-sm border border-yellow-300">' +
            '<span class="text-yellow-700 font-bold">ğŸ’¡ í˜œíƒ:</span> <span class="text-yellow-800 font-medium">' + r.benefit + '</span>' +
          '</div>' +
        '</div>';
      }).join('');
      
      return '<div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50" onclick="if(event.target===this){state.showRankInfo=false;render();}">' +
        '<div class="bg-white rounded-3xl w-full max-w-lg max-h-[95vh] overflow-hidden shadow-2xl">' +
          // í—¤ë”
          '<div class="bg-gradient-to-r ' + ranks[currentRankIndex].color + ' p-6 text-white relative">' +
            '<button onclick="state.showRankInfo=false;render()" class="absolute top-4 right-4 text-white text-2xl hover:bg-white hover:bg-opacity-20 rounded-full w-8 h-8 flex items-center justify-center transition">âœ•</button>' +
            '<div class="text-center">' +
              '<div class="text-6xl mb-3">' + currentRankInfo.icon + '</div>' +
              '<div class="text-2xl font-bold mb-1">' + currentRankInfo.rank + '</div>' +
              '<div class="text-white text-opacity-90">í˜„ì¬ ì´ ìì‚°: ' + formatNumber(totalBankBalance) + 'ì›</div>' +
            '</div>' +
          '</div>' +
          
          // ë‹¤ìŒ ë“±ê¸‰ê¹Œì§€ ì§„í–‰ë¥ 
          (nextRank ? 
          '<div class="p-4 bg-gradient-to-r from-purple-50 to-indigo-50 border-b">' +
            '<div class="flex justify-between items-center mb-2">' +
              '<span class="text-sm font-medium text-purple-700">ë‹¤ìŒ ë“±ê¸‰: ' + nextRank.icon + ' ' + nextRank.rank + '</span>' +
              '<span class="text-sm font-bold text-purple-600">' + progressToNext.toFixed(1) + '%</span>' +
            '</div>' +
            '<div class="w-full bg-purple-200 rounded-full h-4 overflow-hidden">' +
              '<div class="bg-gradient-to-r from-purple-500 to-indigo-500 h-4 rounded-full transition-all duration-500 flex items-center justify-end pr-2" style="width: ' + progressToNext + '%">' +
                (progressToNext > 20 ? '<span class="text-white text-xs font-bold">' + progressToNext.toFixed(0) + '%</span>' : '') +
              '</div>' +
            '</div>' +
            '<div class="text-center mt-2 text-sm text-purple-600">' +
              '<span class="font-bold">' + formatNumber(amountToNext) + 'ì›</span> ë” ëª¨ìœ¼ë©´ <span class="font-bold">' + nextRank.rank + '</span> ë‹¬ì„±!' +
            '</div>' +
          '</div>' : 
          '<div class="p-4 bg-gradient-to-r from-yellow-50 to-amber-50 border-b text-center">' +
            '<div class="text-2xl mb-1">ğŸŠ</div>' +
            '<div class="text-amber-700 font-bold">ì¶•í•˜í•©ë‹ˆë‹¤! ìµœê³  ë“±ê¸‰ì— ë„ë‹¬í•˜ì…¨ìŠµë‹ˆë‹¤!</div>' +
          '</div>') +
          
          // ë“±ê¸‰ ëª©ë¡
          '<div class="p-4 overflow-y-auto" style="max-height: 50vh">' +
            '<h3 class="font-bold text-gray-800 mb-1 flex items-center gap-2"><span>ğŸ…</span> ì „ì²´ ë“±ê¸‰ ì•ˆë‚´</h3>' +
            '<p class="text-xs text-gray-500 mb-3">(ì „ì²´ í†µì¥ ì”ê³  ê¸°ì¤€)</p>' +
            '<div class="space-y-3">' +
              ranksHtml +
            '</div>' +
          '</div>' +
        '</div>' +
      '</div>';
    }

    // Render Home Screen
    function renderHomeScreen() {
      var today = new Date();
      var currentMonth = today.getMonth();
      var currentYear = today.getFullYear();

      var monthlyTx = state.transactions.filter(function(t) {
        var d = new Date(t.date);
        return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
      });

      var totalIncome = monthlyTx.filter(function(t) { return t.type === 'income'; }).reduce(function(s, t) { return s + t.amount; }, 0);
      var totalExpense = monthlyTx.filter(function(t) { return t.type === 'expense'; }).reduce(function(s, t) { return s + t.amount; }, 0);
      var necessaryExpense = monthlyTx.filter(function(t) { return t.type === 'expense' && t.isNecessary; }).reduce(function(s, t) { return s + t.amount; }, 0);
      var unnecessaryExpense = monthlyTx.filter(function(t) { return t.type === 'expense' && !t.isNecessary; }).reduce(function(s, t) { return s + t.amount; }, 0);

      // ì´ë²ˆ ë‹¬ í• ë¶€ê¸ˆ ê³„ì‚° (installmentInfoê°€ ìˆëŠ” ê±°ë˜ ê¸°ì¤€)
      var monthlyInstallment = monthlyTx.filter(function(t) {
        return t.installmentInfo && t.installmentInfo.total > 1;
      }).reduce(function(sum, t) {
        return sum + t.amount;
      }, 0);

      // ë‚¨ì€ í• ë¶€ê¸ˆ ê³„ì‚°
      // installmentInfoê°€ ìˆëŠ” ê³ ìœ í•œ í• ë¶€ ê±°ë˜ ì°¾ê¸°
      var uniqueInstallments = {};
      state.transactions.filter(function(t) {
        return t.installmentInfo && t.installmentInfo.total > 1 && t.installmentInfo.startDate;
      }).forEach(function(t) {
        var key = t.installmentInfo.startDate + '_' + t.installmentInfo.originalAmount;
        if (!uniqueInstallments[key]) {
          uniqueInstallments[key] = t.installmentInfo;
        }
      });

      var remainingInstallment = Object.values(uniqueInstallments).reduce(function(sum, info) {
        var startDate = new Date(info.startDate);
        var startYear = startDate.getFullYear();
        var startMonth = startDate.getMonth();
        var monthlyAmount = info.monthlyAmount;
        var totalInstallments = info.total;
        
        // í˜„ì¬ê¹Œì§€ ê²½ê³¼í•œ ê°œì›” ìˆ˜
        var monthsPassed = (currentYear - startYear) * 12 + (currentMonth - startMonth) + 1;
        // ë‚¨ì€ ê°œì›” ìˆ˜
        var remainingMonths = Math.max(0, totalInstallments - monthsPassed);
        
        return sum + (monthlyAmount * remainingMonths);
      }, 0);

      var totalBalance = totalIncome - totalExpense;
      var recentTx = state.transactions.slice().sort(function(a, b) { return new Date(b.date) - new Date(a.date); }).slice(0, 10);

      var recentTxHtml = '';
      if (recentTx.length === 0) {
        recentTxHtml = '<div class="text-center text-gray-400 py-4">ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>';
      } else {
        recentTxHtml = recentTx.map(function(t) {
          return '<div class="flex justify-between items-center py-2 border-b last:border-b-0">' +
            '<div>' +
              '<div class="font-medium">' + t.category + '</div>' +
              '<div class="text-xs text-gray-500">' + t.date + '</div>' +
            '</div>' +
            '<div class="font-bold ' + (t.type === 'income' ? 'text-green-600' : 'text-red-600') + '">' +
              (t.type === 'income' ? '+' : '-') + formatNumber(t.amount) + 'ì›' +
            '</div>' +
          '</div>';
        }).join('');
      }

      return '<div class="p-4 space-y-4">' +
        '<div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 rounded-xl shadow-lg">' +
          '<div class="text-sm opacity-90 mb-1">ì´ ì”ì•¡</div>' +
          '<div class="text-3xl font-bold mb-1">' + formatNumber(totalBalance) + 'ì›</div>' +
          '<div id="current-datetime" class="text-xs opacity-75 mb-3"></div>' +
          (state.undoStack.length > 0 ? 
            '<button onclick="handleUndo()" class="bg-white text-blue-600 px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 hover:bg-blue-50 transition">' +
              '<i data-lucide="undo-2" class="w-4 h-4"></i> ì‹¤í–‰ ì·¨ì†Œ' +
            '</button>' : '') +
        '</div>' +
        '<div class="grid grid-cols-2 gap-4">' +
          '<div class="bg-green-50 p-4 rounded-lg border border-green-200 shadow-sm">' +
            '<div class="text-xs text-green-600 mb-1">ì´ë²ˆ ë‹¬ ìˆ˜ì…</div>' +
            '<div class="text-xl font-bold text-green-700">' + formatNumber(totalIncome) + 'ì›</div>' +
          '</div>' +
          '<div class="bg-red-50 p-4 rounded-lg border border-red-200 shadow-sm">' +
            '<div class="text-xs text-red-600 mb-1">ì´ë²ˆ ë‹¬ ì§€ì¶œ</div>' +
            '<div class="text-xl font-bold text-red-700">' + formatNumber(totalExpense) + 'ì›</div>' +
          '</div>' +
        '</div>' +
        '<div class="grid grid-cols-2 gap-4">' +
          '<div class="bg-purple-50 p-4 rounded-lg border border-purple-200 shadow-sm">' +
            '<div class="text-xs text-purple-600 mb-1">ì´ë²ˆ ë‹¬ í• ë¶€</div>' +
            '<div class="text-lg font-bold text-purple-700">' + formatNumber(Math.round(monthlyInstallment)) + 'ì›</div>' +
          '</div>' +
          '<div class="bg-orange-50 p-4 rounded-lg border border-orange-200 shadow-sm">' +
            '<div class="text-xs text-orange-600 mb-1">ë‚¨ì€ í• ë¶€</div>' +
            '<div class="text-lg font-bold text-orange-700">' + formatNumber(Math.round(remainingInstallment)) + 'ì›</div>' +
          '</div>' +
        '</div>' +
        '<div class="grid grid-cols-2 gap-4">' +
          '<div class="bg-blue-50 p-4 rounded-lg border border-blue-200 shadow-sm">' +
            '<div class="text-xs text-blue-600 mb-1">í•„ìš” ì§€ì¶œ</div>' +
            '<div class="text-lg font-bold text-blue-700">' + formatNumber(necessaryExpense) + 'ì›</div>' +
          '</div>' +
          '<div class="bg-gray-50 p-4 rounded-lg border border-gray-200 shadow-sm">' +
            '<div class="text-xs text-gray-600 mb-1">ë¶ˆí•„ìš” ì§€ì¶œ</div>' +
            '<div class="text-lg font-bold text-gray-700">' + formatNumber(unnecessaryExpense) + 'ì›</div>' +
          '</div>' +
        '</div>' +
        '<div class="bg-white rounded-xl shadow-lg p-4">' +
          '<div class="flex justify-between items-center mb-3">' +
            '<h3 class="font-bold">ìµœê·¼ ê±°ë˜ ë‚´ì—­</h3>' +
            '<div class="flex gap-2">' +
              '<button onclick="exportToCSV()" class="text-blue-600 text-sm flex items-center gap-1">' +
                '<i data-lucide="download" class="w-3.5 h-3.5"></i> CSV' +
              '</button>' +
              '<button onclick="exportData()" class="text-blue-600 text-sm flex items-center gap-1">' +
                '<i data-lucide="share-2" class="w-3.5 h-3.5"></i> ë°±ì—…' +
              '</button>' +
            '</div>' +
          '</div>' +
          '<div class="space-y-2">' + recentTxHtml + '</div>' +
        '</div>' +
      '</div>';
    }

    // Fixed expense expand state
    var fixedExpenseExpanded = false;
    
    function toggleFixedExpenseList() {
      fixedExpenseExpanded = !fixedExpenseExpanded;
      var hiddenItems = document.getElementById('fixed-expense-hidden');
      var toggleBtn = document.getElementById('fixed-expense-toggle-btn');
      
      if (hiddenItems && toggleBtn) {
        if (fixedExpenseExpanded) {
          hiddenItems.classList.remove('hidden');
          toggleBtn.innerHTML = '<i data-lucide="chevron-up" class="w-4 h-4 inline"></i> ì ‘ê¸°';
        } else {
          hiddenItems.classList.add('hidden');
          toggleBtn.innerHTML = '<i data-lucide="chevron-down" class="w-4 h-4 inline"></i> ë”ë³´ê¸° (' + (document.querySelectorAll('#fixed-expense-hidden > div').length) + 'ê±´)';
        }
        lucide.createIcons();
      }
    }

    // History Screen
    function renderHistoryScreen() {
      // ì›” ê³ ì •ë¹„ ì„¹ì…˜ ìƒì„±
      var activeFixedExpenses = state.fixedExpenses.filter(function(fe) { return fe.active; });
      var inactiveFixedExpenses = state.fixedExpenses.filter(function(fe) { return !fe.active; });
      var totalMonthlyFixed = activeFixedExpenses.reduce(function(sum, fe) { return sum + fe.amount; }, 0);
      
      // í‘œì‹œí•  ê³ ì •ë¹„ (ì²˜ìŒ 2ê°œ)
      var visibleFixedExpenses = activeFixedExpenses.slice(0, 2);
      // ìˆ¨ê²¨ì§„ ê³ ì •ë¹„ (3ê°œ ì´ìƒì¼ ë•Œ)
      var hiddenFixedExpenses = activeFixedExpenses.slice(2);
      
      var fixedExpenseHtml = '<div class="bg-white rounded-xl shadow-lg p-4 mb-4">' +
        '<div class="flex justify-between items-center mb-3">' +
          '<h3 class="font-bold text-purple-700">ğŸ“… ì›” ê³ ì •ë¹„</h3>' +
          '<div class="bg-purple-100 px-3 py-1 rounded-lg">' +
            '<span class="text-sm text-purple-600">ì›” í•©ê³„: </span>' +
            '<span class="font-bold text-purple-700">' + formatNumber(totalMonthlyFixed) + 'ì›</span>' +
          '</div>' +
        '</div>';
      
      if (activeFixedExpenses.length === 0 && inactiveFixedExpenses.length === 0) {
        fixedExpenseHtml += '<div class="text-center text-gray-400 py-4">ë“±ë¡ëœ ê³ ì •ë¹„ê°€ ì—†ìŠµë‹ˆë‹¤.<br><span class="text-sm">ê±°ë˜ ì¶”ê°€ì—ì„œ "ê³ ì •ë¹„" ì²´í¬ í›„ ë“±ë¡í•˜ì„¸ìš”.</span></div>';
      } else {
        if (activeFixedExpenses.length > 0) {
          // í•­ìƒ ë³´ì´ëŠ” í•­ëª©ë“¤ (ìµœëŒ€ 2ê°œ)
          fixedExpenseHtml += '<div class="space-y-2 mb-3">';
          visibleFixedExpenses.forEach(function(fe) {
            var payMethodLabel = fe.paymentMethod === 'card' ? 'ì¹´ë“œ' : fe.paymentMethod === 'cash' ? 'í˜„ê¸ˆ' : 'ê¸°íƒ€';
            fixedExpenseHtml += '<div class="flex justify-between items-center p-3 bg-purple-50 rounded-lg border border-purple-200">' +
              '<div class="flex-1">' +
                '<div class="font-medium text-gray-800">' + fe.category + ' <span class="text-xs text-gray-500">(' + payMethodLabel + ')</span></div>' +
                '<div class="text-xs text-gray-500">ë§¤ì›” ' + fe.payDay + 'ì¼ | ' + fe.startDate + ' ~ ' + (fe.endDate || 'ë¬´ê¸°í•œ') + '</div>' +
                (fe.memo ? '<div class="text-xs text-gray-400 mt-1">' + fe.memo + '</div>' : '') +
              '</div>' +
              '<div class="text-right">' +
                '<div class="font-bold text-purple-600">' + formatNumber(fe.amount) + 'ì›</div>' +
                '<div class="flex gap-1 mt-1">' +
                  '<button onclick="editFixedExpense(' + fe.id + ')" class="text-xs text-blue-500 px-2 py-0.5 hover:bg-blue-50 rounded">ìˆ˜ì •</button>' +
                  '<button onclick="deleteFixedExpense(' + fe.id + ')" class="text-xs text-red-500 px-2 py-0.5 hover:bg-red-50 rounded">ì¢…ë£Œ</button>' +
                '</div>' +
              '</div>' +
            '</div>';
          });
          fixedExpenseHtml += '</div>';
          
          // ìˆ¨ê²¨ì§„ í•­ëª©ë“¤ (3ê°œ ì´ìƒì¼ ë•Œ)
          if (hiddenFixedExpenses.length > 0) {
            fixedExpenseHtml += '<div id="fixed-expense-hidden" class="' + (fixedExpenseExpanded ? '' : 'hidden') + ' space-y-2 mb-3">';
            hiddenFixedExpenses.forEach(function(fe) {
              var payMethodLabel = fe.paymentMethod === 'card' ? 'ì¹´ë“œ' : fe.paymentMethod === 'cash' ? 'í˜„ê¸ˆ' : 'ê¸°íƒ€';
              fixedExpenseHtml += '<div class="flex justify-between items-center p-3 bg-purple-50 rounded-lg border border-purple-200">' +
                '<div class="flex-1">' +
                  '<div class="font-medium text-gray-800">' + fe.category + ' <span class="text-xs text-gray-500">(' + payMethodLabel + ')</span></div>' +
                  '<div class="text-xs text-gray-500">ë§¤ì›” ' + fe.payDay + 'ì¼ | ' + fe.startDate + ' ~ ' + (fe.endDate || 'ë¬´ê¸°í•œ') + '</div>' +
                  (fe.memo ? '<div class="text-xs text-gray-400 mt-1">' + fe.memo + '</div>' : '') +
                '</div>' +
                '<div class="text-right">' +
                  '<div class="font-bold text-purple-600">' + formatNumber(fe.amount) + 'ì›</div>' +
                  '<div class="flex gap-1 mt-1">' +
                    '<button onclick="editFixedExpense(' + fe.id + ')" class="text-xs text-blue-500 px-2 py-0.5 hover:bg-blue-50 rounded">ìˆ˜ì •</button>' +
                    '<button onclick="deleteFixedExpense(' + fe.id + ')" class="text-xs text-red-500 px-2 py-0.5 hover:bg-red-50 rounded">ì¢…ë£Œ</button>' +
                  '</div>' +
                '</div>' +
              '</div>';
            });
            fixedExpenseHtml += '</div>';
            
            // ë”ë³´ê¸°/ì ‘ê¸° ë²„íŠ¼
            fixedExpenseHtml += '<button id="fixed-expense-toggle-btn" onclick="toggleFixedExpenseList()" class="w-full py-2 text-sm text-purple-600 font-medium hover:bg-purple-50 rounded-lg transition flex items-center justify-center gap-1">' +
              (fixedExpenseExpanded ? '<i data-lucide="chevron-up" class="w-4 h-4"></i> ì ‘ê¸°' : '<i data-lucide="chevron-down" class="w-4 h-4"></i> ë”ë³´ê¸° (' + hiddenFixedExpenses.length + 'ê±´)') +
            '</button>';
          }
        }
        
        if (inactiveFixedExpenses.length > 0) {
          fixedExpenseHtml += '<div class="border-t pt-3 mt-3">' +
            '<div class="text-xs text-gray-500 mb-2">ì¢…ë£Œëœ ê³ ì •ë¹„ (' + inactiveFixedExpenses.length + 'ê±´)</div>' +
            '<div class="space-y-1">';
          inactiveFixedExpenses.forEach(function(fe) {
            fixedExpenseHtml += '<div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg opacity-60">' +
              '<div class="text-sm text-gray-600">' + fe.category + ' - ' + formatNumber(fe.amount) + 'ì›</div>' +
              '<button onclick="permanentDeleteFixedExpense(' + fe.id + ')" class="text-xs text-red-400 px-2">ì‚­ì œ</button>' +
            '</div>';
          });
          fixedExpenseHtml += '</div></div>';
        }
      }
      
      fixedExpenseHtml += '</div>';
      
      return '<div class="p-4" id="history-screen">' +
        // ê±°ë˜ë‚´ì—­ í—¤ë” íƒ€ì´í‹€
        '<div class="mb-5">' +
          '<div class="flex items-center gap-3 mb-4">' +
            '<div class="w-12 h-12 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg">' +
              '<i data-lucide="receipt" class="w-6 h-6 text-white"></i>' +
            '</div>' +
            '<div>' +
              '<h2 class="text-xl font-bold text-gray-800">ê±°ë˜ë‚´ì—­</h2>' +
              '<p class="text-sm text-gray-500">ëª¨ë“  ìˆ˜ì…ê³¼ ì§€ì¶œì„ í•œëˆˆì—</p>' +
            '</div>' +
          '</div>' +
        '</div>' +
        // ì›” ê³ ì •ë¹„ ì„¹ì…˜ (ë§¨ ìœ„ë¡œ ì´ë™)
        fixedExpenseHtml +
        // ë‚ ì§œ ë° ê²€ìƒ‰ UI
        '<div class="bg-gradient-to-r from-indigo-50 via-purple-50 to-pink-50 rounded-2xl p-4 mb-4 shadow-sm border border-indigo-100">' +
          '<div class="flex items-center gap-2 mb-3">' +
            '<div class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center">' +
              '<i data-lucide="calendar-range" class="w-4 h-4 text-white"></i>' +
            '</div>' +
            '<span class="font-semibold text-gray-700">ê¸°ê°„ ì„ íƒ</span>' +
          '</div>' +
          '<div class="grid grid-cols-2 gap-3 mb-3">' +
            '<div class="relative">' +
              '<label class="block text-xs font-medium text-indigo-600 mb-1.5">ğŸ“… ì‹œì‘ì¼</label>' +
              '<input type="date" id="startDate" class="w-full px-3 py-2.5 bg-white border-2 border-indigo-200 rounded-xl text-sm font-medium text-gray-700 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all shadow-sm">' +
            '</div>' +
            '<div class="relative">' +
              '<label class="block text-xs font-medium text-purple-600 mb-1.5">ğŸ“… ì¢…ë£Œì¼</label>' +
              '<input type="date" id="endDate" class="w-full px-3 py-2.5 bg-white border-2 border-purple-200 rounded-xl text-sm font-medium text-gray-700 focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all shadow-sm">' +
            '</div>' +
          '</div>' +
          '<div class="relative">' +
            '<div class="flex items-center gap-2 mb-1.5">' +
              '<div class="w-6 h-6 rounded-md bg-gradient-to-br from-pink-500 to-rose-600 flex items-center justify-center">' +
                '<i data-lucide="search" class="w-3 h-3 text-white"></i>' +
              '</div>' +
              '<label class="text-xs font-medium text-pink-600">í‚¤ì›Œë“œ ê²€ìƒ‰</label>' +
            '</div>' +
            '<div class="relative">' +
              '<input type="text" id="searchKeyword" class="w-full pl-10 pr-4 py-2.5 bg-white border-2 border-pink-200 rounded-xl text-sm font-medium placeholder-gray-400 focus:border-pink-500 focus:ring-2 focus:ring-pink-200 transition-all shadow-sm" placeholder="ì¹´í…Œê³ ë¦¬, ë©”ëª¨, ê¸ˆì•¡ ë“± ê²€ìƒ‰...">' +
              '<i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-pink-400"></i>' +
            '</div>' +
          '</div>' +
        '</div>' +
        // ê¸°ê°„ ì„ íƒ ë²„íŠ¼
        '<div class="flex gap-2 mb-4 overflow-x-auto pb-2 no-scrollbar">' +
          '<button onclick="setHistoryPeriod(\'daily\')" class="period-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-blue-500 text-white shadow-md" data-period="daily">ì¼ë³„</button>' +
          '<button onclick="setHistoryPeriod(\'weekly\')" class="period-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-gray-200" data-period="weekly">ì£¼ë³„</button>' +
          '<button onclick="setHistoryPeriod(\'monthly\')" class="period-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-gray-200" data-period="monthly">ì›”ë³„</button>' +
          '<button onclick="setHistoryPeriod(\'yearly\')" class="period-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-gray-200" data-period="yearly">ë…„ë„ë³„</button>' +
          '<button onclick="setHistoryPeriod(\'calendar\')" class="period-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-gray-200" data-period="calendar">ë‹¬ë ¥</button>' +
        '</div>' +
        '<div id="calendar-container" class="hidden"></div>' +
        '<div id="history-list" class="space-y-4"></div>' +
      '</div>';
    }

    var historyPeriod = 'daily';

    var calendarYear = new Date().getFullYear();
    var calendarMonth = new Date().getMonth();

    function setHistoryPeriod(period) {
      historyPeriod = period;
      document.querySelectorAll('.period-btn').forEach(function(btn) {
        if (btn.dataset.period === period) {
          btn.className = 'period-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-blue-500 text-white shadow-md';
        } else {
          btn.className = 'period-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-gray-200';
        }
      });
      
      var calendarContainer = document.getElementById('calendar-container');
      var historyList = document.getElementById('history-list');
      
      if (period === 'calendar') {
        if (calendarContainer) calendarContainer.classList.remove('hidden');
        if (historyList) historyList.classList.add('hidden');
        renderCalendar();
      } else {
        if (calendarContainer) calendarContainer.classList.add('hidden');
        if (historyList) historyList.classList.remove('hidden');
        updateHistoryList();
      }
    }

    function renderCalendar() {
      var container = document.getElementById('calendar-container');
      if (!container) return;

      var year = calendarYear;
      var month = calendarMonth;
      var monthNames = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];
      var dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];

      var firstDay = new Date(year, month, 1);
      var lastDay = new Date(year, month + 1, 0);
      var startDay = firstDay.getDay();
      var totalDays = lastDay.getDate();

      // Get transactions for this month
      var monthTransactions = {};
      state.transactions.forEach(function(t) {
        var tDate = new Date(t.date);
        if (tDate.getFullYear() === year && tDate.getMonth() === month) {
          var day = tDate.getDate();
          if (!monthTransactions[day]) {
            monthTransactions[day] = { income: 0, expense: 0, transactions: [] };
          }
          if (t.type === 'income') {
            monthTransactions[day].income += t.amount;
          } else {
            monthTransactions[day].expense += t.amount;
          }
          monthTransactions[day].transactions.push(t);
        }
      });

      // Calculate monthly totals
      var monthlyIncome = 0;
      var monthlyExpense = 0;
      Object.values(monthTransactions).forEach(function(day) {
        monthlyIncome += day.income;
        monthlyExpense += day.expense;
      });

      var html = '<div class="bg-white rounded-xl shadow-lg p-4 mb-4">' +
        '<div class="flex justify-between items-center mb-4">' +
          '<button onclick="changeCalendarMonth(-1)" class="p-2 hover:bg-gray-100 rounded-lg text-xl font-bold text-gray-600">â—€</button>' +
          '<div class="text-center">' +
            '<h3 class="text-xl font-bold text-gray-800">' + year + 'ë…„ ' + monthNames[month] + '</h3>' +
            '<div class="flex gap-4 justify-center mt-1 text-sm">' +
              '<span class="text-green-600 font-medium">ìˆ˜ì…: ' + formatNumber(monthlyIncome) + 'ì›</span>' +
              '<span class="text-red-600 font-medium">ì§€ì¶œ: ' + formatNumber(monthlyExpense) + 'ì›</span>' +
            '</div>' +
          '</div>' +
          '<button onclick="changeCalendarMonth(1)" class="p-2 hover:bg-gray-100 rounded-lg text-xl font-bold text-gray-600">â–¶</button>' +
        '</div>' +
        '<div class="grid grid-cols-7 gap-1 mb-2">';

      // Day headers
      dayNames.forEach(function(day, idx) {
        var color = idx === 0 ? 'text-red-500' : idx === 6 ? 'text-blue-500' : 'text-gray-700';
        html += '<div class="text-center text-sm font-bold ' + color + ' py-2">' + day + '</div>';
      });

      html += '</div><div class="grid grid-cols-7 gap-1">';

      // Empty cells before first day
      for (var i = 0; i < startDay; i++) {
        html += '<div class="h-20 bg-gray-50 rounded-lg"></div>';
      }

      // Day cells
      var today = new Date();
      for (var day = 1; day <= totalDays; day++) {
        var isToday = today.getFullYear() === year && today.getMonth() === month && today.getDate() === day;
        var dayOfWeek = (startDay + day - 1) % 7;
        var isSunday = dayOfWeek === 0;
        var isSaturday = dayOfWeek === 6;
        var dayData = monthTransactions[day];

        var cellBg = isToday ? 'bg-blue-100 border-2 border-blue-500' : 'bg-gray-50 hover:bg-gray-100';
        var dayColor = isSunday ? 'text-red-500' : isSaturday ? 'text-blue-500' : 'text-gray-700';

        html += '<div onclick="showDayTransactions(' + year + ',' + month + ',' + day + ')" class="h-20 ' + cellBg + ' rounded-lg p-1 cursor-pointer transition relative overflow-hidden">' +
          '<div class="text-xs font-bold ' + dayColor + '">' + day + '</div>';

        if (dayData) {
          if (dayData.income > 0) {
            html += '<div class="text-xs text-green-600 font-medium truncate">+' + (dayData.income >= 10000 ? Math.floor(dayData.income / 10000) + 'ë§Œ' : formatNumber(dayData.income)) + '</div>';
          }
          if (dayData.expense > 0) {
            html += '<div class="text-xs text-red-600 font-medium truncate">-' + (dayData.expense >= 10000 ? Math.floor(dayData.expense / 10000) + 'ë§Œ' : formatNumber(dayData.expense)) + '</div>';
          }
          if (dayData.transactions.length > 2) {
            html += '<div class="text-xs text-gray-400">+' + (dayData.transactions.length - 2) + 'ê±´</div>';
          }
        }

        html += '</div>';
      }

      // Empty cells after last day
      var remainingCells = 7 - ((startDay + totalDays) % 7);
      if (remainingCells < 7) {
        for (var i = 0; i < remainingCells; i++) {
          html += '<div class="h-20 bg-gray-50 rounded-lg"></div>';
        }
      }

      html += '</div></div>' +
        '<div id="day-transactions-popup" class="hidden"></div>';

      container.innerHTML = html;
    }

    function changeCalendarMonth(delta) {
      calendarMonth += delta;
      if (calendarMonth > 11) {
        calendarMonth = 0;
        calendarYear++;
      } else if (calendarMonth < 0) {
        calendarMonth = 11;
        calendarYear--;
      }
      renderCalendar();
    }

    function showDayTransactions(year, month, day) {
      var dateStr = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
      var dayTransactions = state.transactions.filter(function(t) {
        return t.date === dateStr;
      });

      if (dayTransactions.length === 0) {
        var popup = document.getElementById('day-transactions-popup');
        if (popup) {
          popup.innerHTML = '<div class="bg-white rounded-xl shadow-lg p-4 mt-4 border-2 border-blue-200">' +
            '<div class="flex justify-between items-center mb-3">' +
              '<h4 class="font-bold text-gray-800">ğŸ“… ' + dateStr + '</h4>' +
              '<button onclick="closeDayPopup()" class="text-gray-500 text-xl">âœ•</button>' +
            '</div>' +
            '<div class="text-center text-gray-400 py-4">ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>' +
            '<button onclick="openAddTransactionWithDate(\'' + dateStr + '\')" class="w-full bg-blue-500 text-white py-2 rounded-lg font-medium mt-2">+ ê±°ë˜ ì¶”ê°€</button>' +
          '</div>';
          popup.classList.remove('hidden');
        }
        return;
      }

      var income = dayTransactions.filter(function(t) { return t.type === 'income'; }).reduce(function(s, t) { return s + t.amount; }, 0);
      var expense = dayTransactions.filter(function(t) { return t.type === 'expense'; }).reduce(function(s, t) { return s + t.amount; }, 0);

      var txHtml = dayTransactions.map(function(t) {
        return '<div class="flex justify-between items-center py-2 border-b last:border-b-0">' +
          '<div>' +
            '<div class="font-medium">' + t.category + '</div>' +
            '<div class="text-xs text-gray-500">' + (t.memo || '') + '</div>' +
          '</div>' +
          '<div class="flex items-center gap-2">' +
            '<div class="font-bold ' + (t.type === 'income' ? 'text-green-600' : 'text-red-600') + '">' +
              (t.type === 'income' ? '+' : '-') + formatNumber(t.amount) + 'ì›' +
            '</div>' +
            '<button onclick="deleteTransaction(' + t.id + ');renderCalendar();" class="text-red-400 text-xs">ì‚­ì œ</button>' +
          '</div>' +
        '</div>';
      }).join('');

      var popup = document.getElementById('day-transactions-popup');
      if (popup) {
        popup.innerHTML = '<div class="bg-white rounded-xl shadow-lg p-4 mt-4 border-2 border-blue-200">' +
          '<div class="flex justify-between items-center mb-3">' +
            '<h4 class="font-bold text-gray-800">ğŸ“… ' + dateStr + '</h4>' +
            '<button onclick="closeDayPopup()" class="text-gray-500 text-xl">âœ•</button>' +
          '</div>' +
          '<div class="grid grid-cols-2 gap-2 mb-3">' +
            '<div class="bg-green-50 p-2 rounded-lg text-center">' +
              '<div class="text-xs text-green-600">ìˆ˜ì…</div>' +
              '<div class="font-bold text-green-700">' + formatNumber(income) + 'ì›</div>' +
            '</div>' +
            '<div class="bg-red-50 p-2 rounded-lg text-center">' +
              '<div class="text-xs text-red-600">ì§€ì¶œ</div>' +
              '<div class="font-bold text-red-700">' + formatNumber(expense) + 'ì›</div>' +
            '</div>' +
          '</div>' +
          '<div class="max-h-60 overflow-y-auto">' + txHtml + '</div>' +
          '<button onclick="openAddTransactionWithDate(\'' + dateStr + '\')" class="w-full bg-blue-500 text-white py-2 rounded-lg font-medium mt-3">+ ê±°ë˜ ì¶”ê°€</button>' +
        '</div>';
        popup.classList.remove('hidden');
      }
    }

    function closeDayPopup() {
      var popup = document.getElementById('day-transactions-popup');
      if (popup) popup.classList.add('hidden');
    }

    function openAddTransactionWithDate(dateStr) {
      state.showAddTransaction = true;
      render();
      setTimeout(function() {
        var dateInput = document.getElementById('txDate');
        if (dateInput) dateInput.value = dateStr;
      }, 100);
    }

    function updateHistoryList() {
      var startDate = document.getElementById('startDate') ? document.getElementById('startDate').value : '';
      var endDate = document.getElementById('endDate') ? document.getElementById('endDate').value : '';
      var keyword = document.getElementById('searchKeyword') ? document.getElementById('searchKeyword').value : '';

      var filtered = state.transactions.filter(function(t) {
        var tDate = new Date(t.date);
        var start = startDate ? new Date(startDate) : null;
        var end = endDate ? new Date(endDate) : null;
        var dateMatch = (!start || tDate >= start) && (!end || tDate <= end);
        
        // í‚¤ì›Œë“œ ê²€ìƒ‰ (ì¹´í…Œê³ ë¦¬, ë©”ëª¨, ê²°ì œìˆ˜ë‹¨, í• ë¶€, ìœ í˜• ë“± ëª¨ë“  í•„ë“œ ê²€ìƒ‰)
        var keywordMatch = true;
        if (keyword) {
          var kw = keyword.toLowerCase();
          var searchFields = [];
          
          // ì¹´í…Œê³ ë¦¬
          searchFields.push(t.category || '');
          
          // ë©”ëª¨
          searchFields.push(t.memo || '');
          
          // ê²°ì œìˆ˜ë‹¨ (ì¹´ë“œ/í˜„ê¸ˆ)
          if (t.paymentMethod === 'card') {
            searchFields.push('ì¹´ë“œ');
          } else if (t.paymentMethod === 'cash') {
            searchFields.push('í˜„ê¸ˆ');
          }
          
          // í• ë¶€
          if (t.installment && t.installment > 0) {
            searchFields.push('í• ë¶€');
            searchFields.push(t.installment + 'ê°œì›”');
          } else {
            searchFields.push('ì¼ì‹œë¶ˆ');
          }
          
          // ìœ í˜• (ìˆ˜ì…/ì§€ì¶œ)
          if (t.type === 'income') {
            searchFields.push('ìˆ˜ì…');
          } else {
            searchFields.push('ì§€ì¶œ');
          }
          
          // í•„ìš”/ë¶ˆí•„ìš” ì§€ì¶œ
          if (t.type === 'expense') {
            if (t.isNecessary) {
              searchFields.push('í•„ìš”');
              searchFields.push('í•„ìš”ì§€ì¶œ');
            } else {
              searchFields.push('ë¶ˆí•„ìš”');
              searchFields.push('ë¶ˆí•„ìš”ì§€ì¶œ');
            }
          }
          
          // ë‚ ì§œ
          searchFields.push(t.date || '');
          
          // ê¸ˆì•¡
          searchFields.push(String(t.amount || ''));
          
          // ëª¨ë“  í•„ë“œì—ì„œ ê²€ìƒ‰
          keywordMatch = searchFields.some(function(field) {
            return field.toLowerCase().indexOf(kw) >= 0;
          });
        }
        
        return dateMatch && keywordMatch;
      });

      var grouped = {};
      filtered.forEach(function(t) {
        var date = new Date(t.date);
        var key;
        if (historyPeriod === 'daily') key = t.date;
        else if (historyPeriod === 'weekly') {
          var weekStart = new Date(date);
          weekStart.setDate(date.getDate() - date.getDay());
          key = weekStart.toISOString().split('T')[0];
        } else if (historyPeriod === 'monthly') {
          key = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');
        } else {
          key = String(date.getFullYear());
        }
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(t);
      });

      var listEl = document.getElementById('history-list');
      if (!listEl) return;

      if (Object.keys(grouped).length === 0) {
        listEl.innerHTML = '<div class="text-center text-gray-400 py-8">ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
      }

      listEl.innerHTML = Object.keys(grouped).sort().reverse().map(function(period) {
        var txs = grouped[period];
        var income = txs.filter(function(t) { return t.type === 'income'; }).reduce(function(s, t) { return s + t.amount; }, 0);
        var expense = txs.filter(function(t) { return t.type === 'expense'; }).reduce(function(s, t) { return s + t.amount; }, 0);
        var balance = income - expense;

        return '<div class="bg-white rounded-xl shadow-lg p-4">' +
          '<div class="mb-3">' +
            '<h3 class="font-bold text-lg mb-2">' + period + '</h3>' +
            '<div class="grid grid-cols-3 gap-2 bg-gray-50 p-3 rounded-lg">' +
              '<div><div class="text-xs text-green-600">ìˆ˜ì…</div><div class="text-sm font-bold text-green-700">' + formatNumber(income) + 'ì›</div></div>' +
              '<div><div class="text-xs text-red-600">ì§€ì¶œ</div><div class="text-sm font-bold text-red-700">' + formatNumber(expense) + 'ì›</div></div>' +
              '<div><div class="text-xs text-blue-600">ì”ê³ </div><div class="text-sm font-bold ' + (balance >= 0 ? 'text-blue-700' : 'text-red-700') + '">' + formatNumber(balance) + 'ì›</div></div>' +
            '</div>' +
          '</div>' +
          txs.map(function(t) {
            // Calculate payment info with installment progress
            var paymentInfo = '';
            if (t.type === 'expense') {
              if (t.paymentMethod === 'cash') {
                paymentInfo = '(í˜„ê¸ˆ)';
              } else if (t.paymentMethod === 'other') {
                paymentInfo = '(ê¸°íƒ€)';
              } else if (t.paymentMethod === 'card') {
                // Check if this is an auto-split installment transaction
                if (t.installmentInfo) {
                  paymentInfo = '(ì¹´ë“œ' + t.installmentInfo.current + '/' + t.installmentInfo.total + ')';
                } else if (t.installment && t.installment > 1) {
                  // Old style installment - calculate progress
                  var tDate = new Date(t.date);
                  var now = new Date();
                  var monthsPassed = (now.getFullYear() - tDate.getFullYear()) * 12 + (now.getMonth() - tDate.getMonth());
                  var currentInstallment = Math.min(monthsPassed + 1, t.installment);
                  paymentInfo = '(ì¹´ë“œ' + currentInstallment + '/' + t.installment + ')';
                } else {
                  paymentInfo = '(ì¹´ë“œ)';
                }
              }
            }
            
            return '<div class="border-b py-2 last:border-b-0">' +
              '<div class="flex justify-between items-center">' +
                '<div class="flex-1">' +
                  '<div class="font-medium">' + t.category + '<span class="text-gray-500 text-sm ml-1">' + paymentInfo + '</span></div>' +
                  '<div class="text-xs text-gray-500">' + t.date + (t.memo ? ' - ' + t.memo : '') + '</div>' +
                '</div>' +
                '<div class="flex items-center gap-2">' +
                  '<div class="font-bold ' + (t.type === 'income' ? 'text-green-600' : 'text-red-600') + '">' +
                    (t.type === 'income' ? '+' : '-') + formatNumber(t.amount) + 'ì›' +
                  '</div>' +
                  '<button onclick="editTransaction(' + t.id + ')" class="text-blue-500 text-sm px-1">ìˆ˜ì •</button>' +
                  '<button onclick="deleteTransaction(' + t.id + ')" class="text-red-500 text-sm px-1">ì‚­ì œ</button>' +
                '</div>' +
              '</div>' +
            '</div>';
          }).join('') +
        '</div>';
      }).join('');
    }

    function deleteTransaction(id) {
      if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        var tx = state.transactions.find(function(t) { return t.id === id; });
        if (tx) addToUndoStack('deleteTransaction', tx);
        state.transactions = state.transactions.filter(function(t) { return t.id !== id; });
        saveData();
        updateHistoryList();
        showToast('ê±°ë˜ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    }

    function editTransaction(id) {
      var tx = state.transactions.find(function(t) { return t.id === id; });
      if (!tx) return;
      
      var newAmount = prompt('ê¸ˆì•¡:', tx.amount);
      if (newAmount === null) return;
      
      var newCategory = prompt('ì¹´í…Œê³ ë¦¬:', tx.category);
      if (newCategory === null) return;
      
      var newMemo = prompt('ë©”ëª¨:', tx.memo || '');
      if (newMemo === null) return;
      
      tx.amount = Number(newAmount) || tx.amount;
      tx.category = newCategory || tx.category;
      tx.memo = newMemo;
      
      saveData();
      updateHistoryList();
      showToast('ê±°ë˜ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    // Stats Screen
    function renderStatsScreen() {
      return '<div class="p-4" id="stats-screen">' +
        '<div class="flex gap-2 mb-4 overflow-x-auto pb-2 no-scrollbar">' +
          '<button onclick="setStatsPeriod(\'daily\')" class="stats-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-gray-200" data-period="daily">ì¼ë³„</button>' +
          '<button onclick="setStatsPeriod(\'weekly\')" class="stats-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-gray-200" data-period="weekly">ì£¼ë³„</button>' +
          '<button onclick="setStatsPeriod(\'monthly\')" class="stats-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-blue-500 text-white shadow-md" data-period="monthly">ì›”ë³„</button>' +
          '<button onclick="setStatsPeriod(\'yearly\')" class="stats-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-gray-200" data-period="yearly">ë…„ë„ë³„</button>' +
        '</div>' +
        '<button onclick="showComprehensiveAIAnalysis()" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-3 rounded-xl font-bold mb-4 flex items-center justify-center gap-2 hover:from-purple-700 hover:to-indigo-700 transition shadow-lg">' +
          '<span class="text-xl">ğŸ¤–</span><span>AI ì¢…í•© ì¬ì • ë¶„ì„</span>' +
        '</button>' +
        '<div id="stats-content"></div>' +
        '<div id="ai-analysis-content" class="hidden"></div>' +
      '</div>';
    }

    var statsPeriod = 'monthly';
    var showingAIAnalysis = false;

    function setStatsPeriod(period) {
      statsPeriod = period;
      document.querySelectorAll('.stats-btn').forEach(function(btn) {
        if (btn.dataset.period === period) {
          btn.className = 'stats-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-blue-500 text-white shadow-md';
        } else {
          btn.className = 'stats-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-gray-200';
        }
      });
      updateStatsContent();
    }

    function updateStatsContent() {
      var now = new Date();
      var filtered = state.transactions.filter(function(t) {
        var d = new Date(t.date);
        if (statsPeriod === 'daily') return d.toDateString() === now.toDateString();
        if (statsPeriod === 'weekly') return d >= new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        if (statsPeriod === 'monthly') return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
        return d.getFullYear() === now.getFullYear();
      });

      var categoryStats = {};
      filtered.forEach(function(t) {
        if (!categoryStats[t.category]) categoryStats[t.category] = { income: 0, expense: 0 };
        if (t.type === 'income') categoryStats[t.category].income += t.amount;
        else categoryStats[t.category].expense += t.amount;
      });

      var totalIncome = filtered.filter(function(t) { return t.type === 'income'; }).reduce(function(s, t) { return s + t.amount; }, 0);
      var totalExpense = filtered.filter(function(t) { return t.type === 'expense'; }).reduce(function(s, t) { return s + t.amount; }, 0);
      var maxAmount = Math.max(totalIncome, totalExpense, 1);

      var contentEl = document.getElementById('stats-content');
      if (!contentEl) return;

      var categoryHtml = '';
      if (Object.keys(categoryStats).length === 0) {
        categoryHtml = '<div class="text-center text-gray-400 py-4">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
      } else {
        categoryHtml = Object.entries(categoryStats).map(function(entry) {
          var cat = entry[0];
          var amounts = entry[1];
          var html = '<div class="border-b pb-3"><div class="font-medium mb-2">' + cat + '</div>';
          if (amounts.income > 0) {
            html += '<div class="mb-1">' +
              '<div class="flex justify-between text-xs mb-1">' +
                '<span class="text-green-600">ìˆ˜ì…</span>' +
                '<span class="text-green-600 font-bold">' + formatNumber(amounts.income) + 'ì›</span>' +
              '</div>' +
              '<div class="w-full bg-gray-200 rounded-full h-4">' +
                '<div class="bg-green-400 h-4 rounded-full transition-all" style="width: ' + (amounts.income / maxAmount * 100) + '%"></div>' +
              '</div>' +
            '</div>';
          }
          if (amounts.expense > 0) {
            html += '<div>' +
              '<div class="flex justify-between text-xs mb-1">' +
                '<span class="text-red-600">ì§€ì¶œ</span>' +
                '<span class="text-red-600 font-bold">' + formatNumber(amounts.expense) + 'ì›</span>' +
              '</div>' +
              '<div class="w-full bg-gray-200 rounded-full h-4">' +
                '<div class="bg-red-400 h-4 rounded-full transition-all" style="width: ' + (amounts.expense / maxAmount * 100) + '%"></div>' +
              '</div>' +
            '</div>';
          }
          html += '</div>';
          return html;
        }).join('');
      }

      contentEl.innerHTML = '<div class="bg-white rounded-xl shadow-lg p-4 mb-4">' +
        '<h3 class="font-bold mb-4">ìˆ˜ì… / ì§€ì¶œ í•©ê³„</h3>' +
        '<div class="space-y-4">' +
          '<div>' +
            '<div class="flex justify-between text-sm mb-1">' +
              '<span class="text-green-600 font-medium">ìˆ˜ì…</span>' +
              '<span class="text-green-600 font-bold">' + formatNumber(totalIncome) + 'ì›</span>' +
            '</div>' +
            '<div class="w-full bg-gray-200 rounded-full h-6">' +
              '<div class="bg-gradient-to-r from-green-400 to-green-500 h-6 rounded-full flex items-center justify-end pr-2 transition-all" style="width: ' + (totalIncome / maxAmount * 100) + '%">' +
                '<span class="text-xs text-white font-bold">' + Math.round(totalIncome / maxAmount * 100) + '%</span>' +
              '</div>' +
            '</div>' +
          '</div>' +
          '<div>' +
            '<div class="flex justify-between text-sm mb-1">' +
              '<span class="text-red-600 font-medium">ì§€ì¶œ</span>' +
              '<span class="text-red-600 font-bold">' + formatNumber(totalExpense) + 'ì›</span>' +
            '</div>' +
            '<div class="w-full bg-gray-200 rounded-full h-6">' +
              '<div class="bg-gradient-to-r from-red-400 to-red-500 h-6 rounded-full flex items-center justify-end pr-2 transition-all" style="width: ' + (totalExpense / maxAmount * 100) + '%">' +
                '<span class="text-xs text-white font-bold">' + Math.round(totalExpense / maxAmount * 100) + '%</span>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
      '</div>' +
      '<div class="bg-white rounded-xl shadow-lg p-4">' +
        '<h3 class="font-bold mb-4">ì¹´í…Œê³ ë¦¬ë³„ í†µê³„</h3>' +
        '<div class="space-y-3">' + categoryHtml + '</div>' +
      '</div>';
    }

    function showAIAnalysis() {
      showingAIAnalysis = !showingAIAnalysis;
      var statsContent = document.getElementById('stats-content');
      var aiContent = document.getElementById('ai-analysis-content');
      
      if (showingAIAnalysis) {
        if (statsContent) statsContent.classList.add('hidden');
        if (aiContent) {
          aiContent.classList.remove('hidden');
          generateAIAnalysis();
        }
      } else {
        if (statsContent) statsContent.classList.remove('hidden');
        if (aiContent) aiContent.classList.add('hidden');
      }
    }

    function showComprehensiveAIAnalysis() {
      var statsContent = document.getElementById('stats-content');
      var aiContent = document.getElementById('ai-analysis-content');
      
      if (statsContent) statsContent.classList.add('hidden');
      if (aiContent) {
        aiContent.classList.remove('hidden');
        generateComprehensiveAIAnalysis();
      }
    }

    function generateComprehensiveAIAnalysis() {
      var aiContent = document.getElementById('ai-analysis-content');
      if (!aiContent) return;

      var now = new Date();
      var thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
      var lastMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);
      var lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0);
      var threeMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 3, 1);
      var yearStart = new Date(now.getFullYear(), 0, 1);

      // This month data
      var thisMonthTx = state.transactions.filter(function(t) { return new Date(t.date) >= thisMonthStart; });
      var thisMonthIncome = thisMonthTx.filter(function(t) { return t.type === 'income'; }).reduce(function(s, t) { return s + t.amount; }, 0);
      var thisMonthExpense = thisMonthTx.filter(function(t) { return t.type === 'expense'; }).reduce(function(s, t) { return s + t.amount; }, 0);
      var thisMonthNecessary = thisMonthTx.filter(function(t) { return t.type === 'expense' && t.isNecessary; }).reduce(function(s, t) { return s + t.amount; }, 0);
      var thisMonthUnnecessary = thisMonthTx.filter(function(t) { return t.type === 'expense' && !t.isNecessary; }).reduce(function(s, t) { return s + t.amount; }, 0);

      // Last month data
      var lastMonthTx = state.transactions.filter(function(t) {
        var d = new Date(t.date);
        return d >= lastMonthStart && d <= lastMonthEnd;
      });
      var lastMonthIncome = lastMonthTx.filter(function(t) { return t.type === 'income'; }).reduce(function(s, t) { return s + t.amount; }, 0);
      var lastMonthExpense = lastMonthTx.filter(function(t) { return t.type === 'expense'; }).reduce(function(s, t) { return s + t.amount; }, 0);

      // 3 month average
      var threeMonthTx = state.transactions.filter(function(t) { return new Date(t.date) >= threeMonthsAgo; });
      var threeMonthIncome = threeMonthTx.filter(function(t) { return t.type === 'income'; }).reduce(function(s, t) { return s + t.amount; }, 0) / 3;
      var threeMonthExpense = threeMonthTx.filter(function(t) { return t.type === 'expense'; }).reduce(function(s, t) { return s + t.amount; }, 0) / 3;

      // Year data
      var yearTx = state.transactions.filter(function(t) { return new Date(t.date) >= yearStart; });
      var yearIncome = yearTx.filter(function(t) { return t.type === 'income'; }).reduce(function(s, t) { return s + t.amount; }, 0);
      var yearExpense = yearTx.filter(function(t) { return t.type === 'expense'; }).reduce(function(s, t) { return s + t.amount; }, 0);

      // Savings rate
      var savingsRate = thisMonthIncome > 0 ? ((thisMonthIncome - thisMonthExpense) / thisMonthIncome * 100) : 0;
      var lastSavingsRate = lastMonthIncome > 0 ? ((lastMonthIncome - lastMonthExpense) / lastMonthIncome * 100) : 0;

      // Changes
      var incomeChange = lastMonthIncome > 0 ? ((thisMonthIncome - lastMonthIncome) / lastMonthIncome * 100) : 0;
      var expenseChange = lastMonthExpense > 0 ? ((thisMonthExpense - lastMonthExpense) / lastMonthExpense * 100) : 0;

      // Category analysis
      var expenseByCategory = {};
      thisMonthTx.filter(function(t) { return t.type === 'expense'; }).forEach(function(t) {
        if (!expenseByCategory[t.category]) expenseByCategory[t.category] = 0;
        expenseByCategory[t.category] += t.amount;
      });
      var sortedCategories = Object.entries(expenseByCategory).sort(function(a, b) { return b[1] - a[1]; });

      var incomeByCategory = {};
      thisMonthTx.filter(function(t) { return t.type === 'income'; }).forEach(function(t) {
        if (!incomeByCategory[t.category]) incomeByCategory[t.category] = 0;
        incomeByCategory[t.category] += t.amount;
      });
      var sortedIncomeCategories = Object.entries(incomeByCategory).sort(function(a, b) { return b[1] - a[1]; });

      // Bank balance analysis
      var totalBankBalance = state.bankBalances.reduce(function(s, b) { return s + b.balance; }, 0);
      var rankInfo = getRankInfo(totalBankBalance);

      // Investment analysis
      var totalInvested = state.investments.reduce(function(s, i) { return s + i.buyPrice * i.quantity; }, 0);
      var totalCurrentValue = state.investments.reduce(function(s, i) { return s + i.currentPrice * i.quantity; }, 0);
      var investmentProfit = totalCurrentValue - totalInvested;
      var investmentProfitRate = totalInvested > 0 ? (investmentProfit / totalInvested * 100) : 0;
      var totalDividends = state.dividends.reduce(function(s, d) { return s + d.amount; }, 0);

      // Investment by type
      var investmentByType = {};
      state.investments.forEach(function(inv) {
        var typeLabels = { stock: 'ì£¼ì‹', etf: 'ETF', fund: 'í€ë“œ', crypto: 'ì•”í˜¸í™”í', gold: 'ê¸ˆ', realestate: 'ë¶€ë™ì‚°', bond: 'ì±„ê¶Œ', other: 'ê¸°íƒ€' };
        var label = typeLabels[inv.type] || 'ê¸°íƒ€';
        if (!investmentByType[label]) investmentByType[label] = { invested: 0, current: 0 };
        investmentByType[label].invested += inv.buyPrice * inv.quantity;
        investmentByType[label].current += inv.currentPrice * inv.quantity;
      });

      // Exchange rate analysis
      var usdSold = state.usdPhases.filter(function(p) { return p.sold; });
      var jpySold = state.jpyPhases.filter(function(p) { return p.sold; });
      var usdProfit = usdSold.reduce(function(s, p) { return s + ((p.amount / p.buyRate) * p.sellRate - p.amount); }, 0);
      var jpyProfit = jpySold.reduce(function(s, p) { return s + ((p.amount / p.buyRate) * p.sellRate - p.amount); }, 0);
      var usdInvested = usdSold.reduce(function(s, p) { return s + p.amount; }, 0);
      var jpyInvested = jpySold.reduce(function(s, p) { return s + p.amount; }, 0);
      var usdProfitRate = usdInvested > 0 ? (usdProfit / usdInvested * 100) : 0;
      var jpyProfitRate = jpyInvested > 0 ? (jpyProfit / jpyInvested * 100) : 0;

      var usdHolding = state.usdPhases.filter(function(p) { return p.completed && !p.sold; }).reduce(function(s, p) { return s + (p.amount / p.buyRate); }, 0);
      var jpyHolding = state.jpyPhases.filter(function(p) { return p.completed && !p.sold; }).reduce(function(s, p) { return s + (p.amount / p.buyRate); }, 0);

      // Health score calculation
      var healthScore = 100;
      if (savingsRate < 20) healthScore -= 15;
      if (savingsRate < 10) healthScore -= 15;
      if (savingsRate < 0) healthScore -= 20;
      if (expenseChange > 20) healthScore -= 15;
      if (thisMonthUnnecessary > thisMonthNecessary) healthScore -= 10;
      if (investmentProfitRate < 0) healthScore -= 10;
      healthScore = Math.max(0, Math.min(100, healthScore));

      var healthEmoji = healthScore >= 80 ? 'ğŸ˜Š' : healthScore >= 60 ? 'ğŸ™‚' : healthScore >= 40 ? 'ğŸ˜' : 'ğŸ˜Ÿ';
      var healthColor = healthScore >= 80 ? 'from-green-500 to-emerald-500' : healthScore >= 60 ? 'from-blue-500 to-cyan-500' : healthScore >= 40 ? 'from-yellow-500 to-orange-500' : 'from-red-500 to-pink-500';

      // Goal analysis
      var goals = [
        { label: '7ë…„ ëª©í‘œ', value: Number(state.goals.year7) || 0 },
        { label: '5ë…„ ëª©í‘œ', value: Number(state.goals.year5) || 0 },
        { label: '3ë…„ ëª©í‘œ', value: Number(state.goals.year3) || 0 },
        { label: 'ì˜¬í•´ ëª©í‘œ', value: Number(state.goals.thisYear) || 0 }
      ];
      var activeGoal = goals.find(function(g) { return g.value > 0; });
      var goalProgress = activeGoal ? Math.min((totalBankBalance / activeGoal.value) * 100, 100) : 0;

      // Generate recommendations
      var recommendations = [];
      if (savingsRate < 20) {
        recommendations.push({ type: 'warning', icon: 'âš ï¸', text: 'ì €ì¶•ë¥ ì´ ' + savingsRate.toFixed(1) + '%ì…ë‹ˆë‹¤. 20% ì´ìƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.' });
      } else {
        recommendations.push({ type: 'success', icon: 'âœ…', text: 'ì €ì¶•ë¥  ' + savingsRate.toFixed(1) + '%ë¡œ ì–‘í˜¸í•©ë‹ˆë‹¤!' });
      }
      if (expenseChange > 10) {
        recommendations.push({ type: 'warning', icon: 'ğŸš¨', text: 'ì§€ì¶œì´ ì „ì›” ëŒ€ë¹„ ' + expenseChange.toFixed(1) + '% ì¦ê°€í–ˆìŠµë‹ˆë‹¤.' });
      }
      if (thisMonthUnnecessary > thisMonthExpense * 0.3) {
        recommendations.push({ type: 'warning', icon: 'ğŸ’¸', text: 'ë¶ˆí•„ìš” ì§€ì¶œ ë¹„ìœ¨ì´ ' + (thisMonthUnnecessary / thisMonthExpense * 100).toFixed(1) + '%ì…ë‹ˆë‹¤. ì¤„ì—¬ë³´ì„¸ìš”.' });
      }
      if (sortedCategories.length > 0 && sortedCategories[0][1] > thisMonthExpense * 0.4) {
        recommendations.push({ type: 'info', icon: 'ğŸ“Š', text: sortedCategories[0][0] + ' ì¹´í…Œê³ ë¦¬ ì§€ì¶œì´ 40%ë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.' });
      }
      if (investmentProfitRate < 0) {
        recommendations.push({ type: 'warning', icon: 'ğŸ“‰', text: 'íˆ¬ì ìˆ˜ìµë¥ ì´ ë§ˆì´ë„ˆìŠ¤ì…ë‹ˆë‹¤. í¬íŠ¸í´ë¦¬ì˜¤ ì ê²€ì´ í•„ìš”í•©ë‹ˆë‹¤.' });
      } else if (investmentProfitRate > 10) {
        recommendations.push({ type: 'success', icon: 'ğŸ“ˆ', text: 'íˆ¬ì ìˆ˜ìµë¥  +' + investmentProfitRate.toFixed(1) + '%! ì˜ í•˜ê³  ê³„ì‹­ë‹ˆë‹¤.' });
      }
      if (activeGoal && goalProgress < 50) {
        var monthsRemaining = activeGoal.label === 'ì˜¬í•´ ëª©í‘œ' ? (12 - now.getMonth()) : 
                              activeGoal.label === '3ë…„ ëª©í‘œ' ? 36 : 
                              activeGoal.label === '5ë…„ ëª©í‘œ' ? 60 : 84;
        var monthlyNeeded = (activeGoal.value - totalBankBalance) / monthsRemaining;
        recommendations.push({ type: 'info', icon: 'ğŸ¯', text: activeGoal.label + ' ë‹¬ì„±ì„ ìœ„í•´ ì›” ' + formatNumber(Math.round(monthlyNeeded)) + 'ì› ì €ì¶•ì´ í•„ìš”í•©ë‹ˆë‹¤.' });
      }

      // Build HTML
      var html = '<div class="space-y-4 animate-fade-in">' +
        '<button onclick="hideAIAnalysis()" class="w-full bg-gray-200 text-gray-700 py-2 rounded-lg font-medium mb-2 flex items-center justify-center gap-2 hover:bg-gray-300 transition">' +
          '<i data-lucide="arrow-left" class="w-4 h-4"></i> í†µê³„ë¡œ ëŒì•„ê°€ê¸°' +
        '</button>' +

        // Health Score
        '<div class="bg-gradient-to-r ' + healthColor + ' text-white p-5 rounded-xl shadow-lg">' +
          '<div class="flex items-center justify-between mb-3">' +
            '<h3 class="font-bold text-lg">ğŸ¤– AI ì¬ì • ê±´ê°•ë„</h3>' +
            '<span class="text-3xl">' + healthEmoji + '</span>' +
          '</div>' +
          '<div class="text-4xl font-bold mb-2">' + healthScore + 'ì </div>' +
          '<div class="bg-white bg-opacity-30 rounded-full h-4 mb-2">' +
            '<div class="bg-white h-4 rounded-full transition-all" style="width: ' + healthScore + '%"></div>' +
          '</div>' +
          '<div class="text-sm opacity-90">' + 
            (healthScore >= 80 ? 'ë§¤ìš° ê±´ê°•í•œ ì¬ì • ìƒíƒœì…ë‹ˆë‹¤!' : 
             healthScore >= 60 ? 'ì–‘í˜¸í•œ ì¬ì • ìƒíƒœì…ë‹ˆë‹¤.' : 
             healthScore >= 40 ? 'ê°œì„ ì´ í•„ìš”í•œ ë¶€ë¶„ì´ ìˆìŠµë‹ˆë‹¤.' : 'ì¬ì • ê´€ë¦¬ì— ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.') +
          '</div>' +
        '</div>' +

        // Income Pattern Analysis
        '<div class="bg-white rounded-xl shadow-lg p-4">' +
          '<h3 class="font-bold mb-3 flex items-center gap-2"><span>ğŸ’°</span> ìˆ˜ì… íŒ¨í„´ ë¶„ì„</h3>' +
          '<div class="grid grid-cols-2 gap-3 mb-3">' +
            '<div class="bg-green-50 p-3 rounded-lg">' +
              '<div class="text-xs text-green-600">ì´ë²ˆ ë‹¬ ìˆ˜ì…</div>' +
              '<div class="font-bold text-green-700">' + formatNumber(thisMonthIncome) + 'ì›</div>' +
              '<div class="text-xs ' + (incomeChange >= 0 ? 'text-red-500' : 'text-blue-500') + '">' + 
                (incomeChange >= 0 ? 'â–²' : 'â–¼') + ' ' + Math.abs(incomeChange).toFixed(1) + '% ì „ì›”ëŒ€ë¹„</div>' +
            '</div>' +
            '<div class="bg-blue-50 p-3 rounded-lg">' +
              '<div class="text-xs text-blue-600">3ê°œì›” í‰ê· </div>' +
              '<div class="font-bold text-blue-700">' + formatNumber(Math.round(threeMonthIncome)) + 'ì›</div>' +
            '</div>' +
          '</div>' +
          '<div class="text-sm text-gray-600 mb-2">ìˆ˜ì…ì› êµ¬ì„±</div>' +
          (sortedIncomeCategories.length > 0 ? sortedIncomeCategories.slice(0, 5).map(function(cat) {
            var pct = thisMonthIncome > 0 ? (cat[1] / thisMonthIncome * 100) : 0;
            return '<div class="flex items-center gap-2 mb-2">' +
              '<div class="w-20 text-xs text-gray-700 truncate">' + cat[0] + '</div>' +
              '<div class="flex-1 bg-gray-200 rounded-full h-4">' +
                '<div class="bg-green-500 h-4 rounded-full" style="width:' + pct + '%"></div>' +
              '</div>' +
              '<div class="text-xs font-bold text-green-600 w-16 text-right">' + formatNumber(cat[1]) + 'ì›</div>' +
            '</div>';
          }).join('') : '<div class="text-gray-400 text-sm">ìˆ˜ì… ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>') +
        '</div>' +

        // Expense Pattern Analysis
        '<div class="bg-white rounded-xl shadow-lg p-4">' +
          '<h3 class="font-bold mb-3 flex items-center gap-2"><span>ğŸ’¸</span> ì§€ì¶œ íŒ¨í„´ ë¶„ì„</h3>' +
          '<div class="grid grid-cols-2 gap-3 mb-3">' +
            '<div class="bg-red-50 p-3 rounded-lg">' +
              '<div class="text-xs text-red-600">ì´ë²ˆ ë‹¬ ì§€ì¶œ</div>' +
              '<div class="font-bold text-red-700">' + formatNumber(thisMonthExpense) + 'ì›</div>' +
              '<div class="text-xs ' + (expenseChange >= 0 ? 'text-red-500' : 'text-blue-500') + '">' + 
                (expenseChange >= 0 ? 'â–²' : 'â–¼') + ' ' + Math.abs(expenseChange).toFixed(1) + '% ì „ì›”ëŒ€ë¹„</div>' +
            '</div>' +
            '<div class="bg-purple-50 p-3 rounded-lg">' +
              '<div class="text-xs text-purple-600">3ê°œì›” í‰ê· </div>' +
              '<div class="font-bold text-purple-700">' + formatNumber(Math.round(threeMonthExpense)) + 'ì›</div>' +
            '</div>' +
          '</div>' +
          '<div class="grid grid-cols-2 gap-2 mb-3">' +
            '<div class="bg-blue-50 p-2 rounded-lg text-center">' +
              '<div class="text-xs text-blue-600">í•„ìš” ì§€ì¶œ</div>' +
              '<div class="font-bold text-sm text-blue-700">' + formatNumber(thisMonthNecessary) + 'ì›</div>' +
              '<div class="text-xs text-blue-500">' + (thisMonthExpense > 0 ? (thisMonthNecessary / thisMonthExpense * 100).toFixed(0) : 0) + '%</div>' +
            '</div>' +
            '<div class="bg-gray-100 p-2 rounded-lg text-center">' +
              '<div class="text-xs text-gray-600">ë¶ˆí•„ìš” ì§€ì¶œ</div>' +
              '<div class="font-bold text-sm text-gray-700">' + formatNumber(thisMonthUnnecessary) + 'ì›</div>' +
              '<div class="text-xs text-gray-500">' + (thisMonthExpense > 0 ? (thisMonthUnnecessary / thisMonthExpense * 100).toFixed(0) : 0) + '%</div>' +
            '</div>' +
          '</div>' +
          '<div class="text-sm text-gray-600 mb-2">ì§€ì¶œ TOP 5</div>' +
          (sortedCategories.length > 0 ? sortedCategories.slice(0, 5).map(function(cat) {
            var pct = thisMonthExpense > 0 ? (cat[1] / thisMonthExpense * 100) : 0;
            return '<div class="flex items-center gap-2 mb-2">' +
              '<div class="w-20 text-xs text-gray-700 truncate">' + cat[0] + '</div>' +
              '<div class="flex-1 bg-gray-200 rounded-full h-4">' +
                '<div class="bg-red-500 h-4 rounded-full" style="width:' + pct + '%"></div>' +
              '</div>' +
              '<div class="text-xs font-bold text-red-600 w-16 text-right">' + formatNumber(cat[1]) + 'ì›</div>' +
            '</div>';
          }).join('') : '<div class="text-gray-400 text-sm">ì§€ì¶œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>') +
        '</div>' +

        // Bank Balance Analysis
        '<div class="bg-white rounded-xl shadow-lg p-4">' +
          '<h3 class="font-bold mb-3 flex items-center gap-2"><span>ğŸ¦</span> ì€í–‰ ì”ê³  ë¶„ì„</h3>' +
          '<div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg mb-3">' +
            '<div class="flex justify-between items-center">' +
              '<div>' +
                '<div class="text-sm text-blue-600">ì´ ìì‚°</div>' +
                '<div class="text-2xl font-bold text-blue-700">' + formatNumber(totalBankBalance) + 'ì›</div>' +
              '</div>' +
              '<div class="' + rankInfo.bgColor + ' px-3 py-2 rounded-lg">' +
                '<span class="text-lg">' + rankInfo.icon + '</span>' +
                '<span class="font-bold ' + rankInfo.color + ' ml-1">' + rankInfo.rank + '</span>' +
              '</div>' +
            '</div>' +
          '</div>' +
          (state.bankBalances.length > 0 ? '<div class="space-y-2">' + state.bankBalances.map(function(bank) {
            var pct = totalBankBalance > 0 ? (bank.balance / totalBankBalance * 100) : 0;
            return '<div class="flex items-center gap-2">' +
              '<div class="w-20 text-xs text-gray-700 truncate">' + bank.name + '</div>' +
              '<div class="flex-1 bg-gray-200 rounded-full h-4">' +
                '<div class="bg-indigo-500 h-4 rounded-full" style="width:' + pct + '%"></div>' +
              '</div>' +
              '<div class="text-xs font-bold text-indigo-600 w-20 text-right">' + formatNumber(bank.balance) + 'ì›</div>' +
            '</div>';
          }).join('') + '</div>' : '<div class="text-gray-400 text-sm">ë“±ë¡ëœ ì€í–‰ì´ ì—†ìŠµë‹ˆë‹¤</div>') +
        '</div>' +

        // Investment Pattern Analysis
        '<div class="bg-white rounded-xl shadow-lg p-4">' +
          '<h3 class="font-bold mb-3 flex items-center gap-2"><span>ğŸ“ˆ</span> íˆ¬ì íŒ¨í„´ ë¶„ì„</h3>' +
          '<div class="grid grid-cols-3 gap-2 mb-3">' +
            '<div class="bg-indigo-50 p-2 rounded-lg text-center">' +
              '<div class="text-xs text-indigo-600">íˆ¬ì ì›ê¸ˆ</div>' +
              '<div class="font-bold text-sm text-indigo-700">' + formatNumber(totalInvested) + 'ì›</div>' +
            '</div>' +
            '<div class="bg-purple-50 p-2 rounded-lg text-center">' +
              '<div class="text-xs text-purple-600">í‰ê°€ ê¸ˆì•¡</div>' +
              '<div class="font-bold text-sm text-purple-700">' + formatNumber(totalCurrentValue) + 'ì›</div>' +
            '</div>' +
            '<div class="' + (investmentProfit >= 0 ? 'bg-red-50' : 'bg-blue-50') + ' p-2 rounded-lg text-center">' +
              '<div class="text-xs ' + (investmentProfit >= 0 ? 'text-red-600' : 'text-blue-600') + '">ìˆ˜ìµ</div>' +
              '<div class="font-bold text-sm ' + (investmentProfit >= 0 ? 'text-red-700' : 'text-blue-700') + '">' + 
                (investmentProfit >= 0 ? '+' : '') + formatNumber(investmentProfit) + 'ì›</div>' +
              '<div class="text-xs ' + (investmentProfit >= 0 ? 'text-red-500' : 'text-blue-500') + '">' + 
                (investmentProfit >= 0 ? '+' : '') + investmentProfitRate.toFixed(1) + '%</div>' +
            '</div>' +
          '</div>' +
          '<div class="bg-green-50 p-2 rounded-lg mb-3 text-center">' +
            '<div class="text-xs text-green-600">ì´ ë°°ë‹¹ê¸ˆ</div>' +
            '<div class="font-bold text-green-700">' + formatNumber(totalDividends) + 'ì›</div>' +
          '</div>' +
          (Object.keys(investmentByType).length > 0 ? '<div class="text-sm text-gray-600 mb-2">íˆ¬ì ìœ í˜•ë³„ ë¶„í¬</div>' +
            Object.entries(investmentByType).map(function(entry) {
              var type = entry[0];
              var data = entry[1];
              var profit = data.current - data.invested;
              var pct = totalCurrentValue > 0 ? (data.current / totalCurrentValue * 100) : 0;
              return '<div class="flex items-center gap-2 mb-2">' +
                '<div class="w-16 text-xs text-gray-700">' + type + '</div>' +
                '<div class="flex-1 bg-gray-200 rounded-full h-4">' +
                  '<div class="bg-purple-500 h-4 rounded-full" style="width:' + pct + '%"></div>' +
                '</div>' +
                '<div class="text-xs font-bold ' + (profit >= 0 ? 'text-red-600' : 'text-blue-600') + ' w-16 text-right">' + 
                  (profit >= 0 ? '+' : '') + formatNumber(profit) + 'ì›</div>' +
              '</div>';
            }).join('') : '<div class="text-gray-400 text-sm">íˆ¬ì ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>') +
        '</div>' +

        // Exchange Rate Analysis
        '<div class="bg-white rounded-xl shadow-lg p-4">' +
          '<h3 class="font-bold mb-3 flex items-center gap-2"><span>ğŸ’±</span> í™˜ì „ ìˆ˜ìµ ë¶„ì„</h3>' +
          '<div class="grid grid-cols-2 gap-3 mb-3">' +
            '<div class="border rounded-lg p-3">' +
              '<div class="flex items-center gap-2 mb-2">' +
                '<span>ğŸ‡ºğŸ‡¸</span><span class="font-bold">USD ë‹¬ëŸ¬</span>' +
              '</div>' +
              '<div class="text-sm text-gray-600">ë³´ìœ : $' + usdHolding.toFixed(2) + '</div>' +
              '<div class="text-sm text-gray-600">ë§¤ë„: ' + usdSold.length + 'ê±´</div>' +
              '<div class="font-bold ' + (usdProfit >= 0 ? 'text-red-600' : 'text-blue-600') + '">' + 
                (usdProfit >= 0 ? '+' : '') + formatNumber(Math.round(usdProfit)) + 'ì›</div>' +
              '<div class="text-xs ' + (usdProfit >= 0 ? 'text-red-500' : 'text-blue-500') + '">' + 
                (usdProfit >= 0 ? '+' : '') + usdProfitRate.toFixed(2) + '%</div>' +
            '</div>' +
            '<div class="border rounded-lg p-3">' +
              '<div class="flex items-center gap-2 mb-2">' +
                '<span>ğŸ‡¯ğŸ‡µ</span><span class="font-bold">JPY ì—”í™”</span>' +
              '</div>' +
              '<div class="text-sm text-gray-600">ë³´ìœ : Â¥' + jpyHolding.toFixed(0) + '</div>' +
              '<div class="text-sm text-gray-600">ë§¤ë„: ' + jpySold.length + 'ê±´</div>' +
              '<div class="font-bold ' + (jpyProfit >= 0 ? 'text-red-600' : 'text-blue-600') + '">' + 
                (jpyProfit >= 0 ? '+' : '') + formatNumber(Math.round(jpyProfit)) + 'ì›</div>' +
              '<div class="text-xs ' + (jpyProfit >= 0 ? 'text-red-500' : 'text-blue-500') + '">' + 
                (jpyProfit >= 0 ? '+' : '') + jpyProfitRate.toFixed(2) + '%</div>' +
            '</div>' +
          '</div>' +
          '<div class="bg-gradient-to-r from-green-50 to-emerald-50 p-3 rounded-lg text-center">' +
            '<div class="text-sm text-green-600">í™˜ì „ ì´ ìˆ˜ìµ</div>' +
            '<div class="text-xl font-bold ' + (usdProfit + jpyProfit >= 0 ? 'text-green-700' : 'text-red-700') + '">' + 
              (usdProfit + jpyProfit >= 0 ? '+' : '') + formatNumber(Math.round(usdProfit + jpyProfit)) + 'ì›</div>' +
          '</div>' +
        '</div>' +

        // Period Comparison
        '<div class="bg-white rounded-xl shadow-lg p-4">' +
          '<h3 class="font-bold mb-3 flex items-center gap-2"><span>ğŸ“…</span> ê¸°ê°„ë³„ ë¹„êµ</h3>' +
          '<div class="overflow-x-auto">' +
            '<table class="w-full text-sm">' +
              '<thead class="bg-gray-50">' +
                '<tr>' +
                  '<th class="p-2 text-left">ê¸°ê°„</th>' +
                  '<th class="p-2 text-right">ìˆ˜ì…</th>' +
                  '<th class="p-2 text-right">ì§€ì¶œ</th>' +
                  '<th class="p-2 text-right">ì €ì¶•ë¥ </th>' +
                '</tr>' +
              '</thead>' +
              '<tbody>' +
                '<tr class="border-b">' +
                  '<td class="p-2 font-medium">ì´ë²ˆ ë‹¬</td>' +
                  '<td class="p-2 text-right text-green-600">' + formatNumber(thisMonthIncome) + '</td>' +
                  '<td class="p-2 text-right text-red-600">' + formatNumber(thisMonthExpense) + '</td>' +
                  '<td class="p-2 text-right font-bold">' + savingsRate.toFixed(1) + '%</td>' +
                '</tr>' +
                '<tr class="border-b">' +
                  '<td class="p-2 font-medium">ì§€ë‚œ ë‹¬</td>' +
                  '<td class="p-2 text-right text-green-600">' + formatNumber(lastMonthIncome) + '</td>' +
                  '<td class="p-2 text-right text-red-600">' + formatNumber(lastMonthExpense) + '</td>' +
                  '<td class="p-2 text-right font-bold">' + lastSavingsRate.toFixed(1) + '%</td>' +
                '</tr>' +
                '<tr class="border-b">' +
                  '<td class="p-2 font-medium">3ê°œì›” í‰ê· </td>' +
                  '<td class="p-2 text-right text-green-600">' + formatNumber(Math.round(threeMonthIncome)) + '</td>' +
                  '<td class="p-2 text-right text-red-600">' + formatNumber(Math.round(threeMonthExpense)) + '</td>' +
                  '<td class="p-2 text-right font-bold">' + (threeMonthIncome > 0 ? ((threeMonthIncome - threeMonthExpense) / threeMonthIncome * 100).toFixed(1) : 0) + '%</td>' +
                '</tr>' +
                '<tr>' +
                  '<td class="p-2 font-medium">ì˜¬í•´ ëˆ„ì </td>' +
                  '<td class="p-2 text-right text-green-600">' + formatNumber(yearIncome) + '</td>' +
                  '<td class="p-2 text-right text-red-600">' + formatNumber(yearExpense) + '</td>' +
                  '<td class="p-2 text-right font-bold">' + (yearIncome > 0 ? ((yearIncome - yearExpense) / yearIncome * 100).toFixed(1) : 0) + '%</td>' +
                '</tr>' +
              '</tbody>' +
            '</table>' +
          '</div>' +
        '</div>' +

        // AI Recommendations
        '<div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl shadow-lg p-4">' +
          '<h3 class="font-bold mb-3 flex items-center gap-2"><span>ğŸ’¡</span> AI ê¶Œì¥ì‚¬í•­</h3>' +
          '<div class="space-y-2">' +
            recommendations.map(function(rec) {
              var bgColor = rec.type === 'success' ? 'bg-green-100 border-green-300' : 
                           rec.type === 'warning' ? 'bg-yellow-100 border-yellow-300' : 'bg-blue-100 border-blue-300';
              return '<div class="p-3 rounded-lg border ' + bgColor + '">' +
                '<span class="mr-2">' + rec.icon + '</span>' +
                '<span class="text-sm">' + rec.text + '</span>' +
              '</div>';
            }).join('') +
          '</div>' +
        '</div>' +

      '</div>';

      aiContent.innerHTML = html;
      lucide.createIcons();
    }

    function hideAIAnalysis() {
      var statsContent = document.getElementById('stats-content');
      var aiContent = document.getElementById('ai-analysis-content');
      if (statsContent) statsContent.classList.remove('hidden');
      if (aiContent) aiContent.classList.add('hidden');
    }

    function generateAIAnalysis() {
      var aiContent = document.getElementById('ai-analysis-content');
      if (!aiContent) return;

      var now = new Date();
      var thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
      var lastMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);
      var lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0);

      var thisMonthTx = state.transactions.filter(function(t) { return new Date(t.date) >= thisMonthStart; });
      var lastMonthTx = state.transactions.filter(function(t) {
        var d = new Date(t.date);
        return d >= lastMonthStart && d <= lastMonthEnd;
      });

      var thisMonthIncome = thisMonthTx.filter(function(t) { return t.type === 'income'; }).reduce(function(s, t) { return s + t.amount; }, 0);
      var thisMonthExpense = thisMonthTx.filter(function(t) { return t.type === 'expense'; }).reduce(function(s, t) { return s + t.amount; }, 0);
      var lastMonthIncome = lastMonthTx.filter(function(t) { return t.type === 'income'; }).reduce(function(s, t) { return s + t.amount; }, 0);
      var lastMonthExpense = lastMonthTx.filter(function(t) { return t.type === 'expense'; }).reduce(function(s, t) { return s + t.amount; }, 0);

      var savingsRate = thisMonthIncome > 0 ? ((thisMonthIncome - thisMonthExpense) / thisMonthIncome * 100).toFixed(1) : 0;
      var expenseChange = lastMonthExpense > 0 ? ((thisMonthExpense - lastMonthExpense) / lastMonthExpense * 100).toFixed(1) : 0;

      var healthScore = 100;
      if (savingsRate < 20) healthScore -= 20;
      if (savingsRate < 10) healthScore -= 20;
      if (savingsRate < 0) healthScore -= 30;
      if (expenseChange > 20) healthScore -= 20;

      aiContent.innerHTML = '<div class="space-y-4 animate-fade-in">' +
        '<button onclick="showAIAnalysis()" class="w-full bg-gray-200 text-gray-700 py-2 rounded-lg font-medium mb-2 flex items-center justify-center gap-2 hover:bg-gray-300 transition">' +
          '<i data-lucide="arrow-left" class="w-4 h-4"></i> í†µê³„ë¡œ ëŒì•„ê°€ê¸°' +
        '</button>' +
        '<div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-5 rounded-xl shadow-lg">' +
          '<h3 class="font-bold text-lg mb-3">ğŸ¤– AI ì¬ì • ê±´ê°•ë„: ' + healthScore + 'ì </h3>' +
          '<div class="bg-white bg-opacity-20 rounded-full h-4 mb-2">' +
            '<div class="bg-white h-4 rounded-full" style="width: ' + healthScore + '%"></div>' +
          '</div>' +
        '</div>' +
        '<div class="bg-white rounded-xl shadow-lg p-4">' +
          '<h3 class="font-bold mb-3">ğŸ“Š ì´ë²ˆ ë‹¬ ìš”ì•½</h3>' +
          '<div class="grid grid-cols-2 gap-3">' +
            '<div class="bg-green-50 p-3 rounded-lg">' +
              '<div class="text-xs text-green-600">ìˆ˜ì…</div>' +
              '<div class="font-bold text-green-700">' + formatNumber(thisMonthIncome) + 'ì›</div>' +
            '</div>' +
            '<div class="bg-red-50 p-3 rounded-lg">' +
              '<div class="text-xs text-red-600">ì§€ì¶œ</div>' +
              '<div class="font-bold text-red-700">' + formatNumber(thisMonthExpense) + 'ì›</div>' +
            '</div>' +
            '<div class="bg-blue-50 p-3 rounded-lg">' +
              '<div class="text-xs text-blue-600">ì €ì¶•ë¥ </div>' +
              '<div class="font-bold text-blue-700">' + savingsRate + '%</div>' +
            '</div>' +
            '<div class="bg-purple-50 p-3 rounded-lg">' +
              '<div class="text-xs text-purple-600">ì§€ì¶œë³€í™”</div>' +
              '<div class="font-bold ' + (expenseChange > 0 ? 'text-red-700' : 'text-green-700') + '">' + (expenseChange > 0 ? '+' : '') + expenseChange + '%</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
        '<div class="bg-white rounded-xl shadow-lg p-4">' +
          '<h3 class="font-bold mb-3">ğŸ’¡ AI ê¶Œì¥ì‚¬í•­</h3>' +
          '<div class="space-y-2">' +
            (savingsRate < 20 ? '<div class="p-2 bg-yellow-50 rounded-lg text-sm text-yellow-700">âš ï¸ ì €ì¶•ë¥ ì„ 20% ì´ìƒìœ¼ë¡œ ë†’ì´ì„¸ìš”</div>' : '<div class="p-2 bg-green-50 rounded-lg text-sm text-green-700">âœ… ì €ì¶•ë¥ ì´ ì–‘í˜¸í•©ë‹ˆë‹¤</div>') +
            (expenseChange > 10 ? '<div class="p-2 bg-red-50 rounded-lg text-sm text-red-700">ğŸš¨ ì§€ì¶œì´ ì¦ê°€í–ˆìŠµë‹ˆë‹¤. ì ê²€ì´ í•„ìš”í•©ë‹ˆë‹¤</div>' : '') +
          '</div>' +
        '</div>' +
      '</div>';

      lucide.createIcons();
    }

    // Goal Screen
    function renderGoalScreen() {
      var totalBank = state.bankBalances.reduce(function(s, b) { return s + b.balance; }, 0);
      
      var bankListHtml = state.bankBalances.map(function(b) {
        return '<div class="flex justify-between items-center p-3 border rounded-lg bg-gray-50">' +
          '<div><div class="font-medium">' + b.name + '</div><div class="text-sm text-gray-600">' + formatNumber(b.balance) + 'ì›</div></div>' +
          '<div class="flex gap-1">' +
            '<button onclick="editBank(' + b.id + ')" class="text-blue-500 text-sm px-2 py-1 hover:bg-blue-50 rounded">ìˆ˜ì •</button>' +
            '<button onclick="deleteBank(' + b.id + ')" class="text-red-500 text-sm px-2 py-1 hover:bg-red-50 rounded">ì‚­ì œ</button>' +
          '</div>' +
        '</div>';
      }).join('');

      // Calculate goal achievements
      var goals = [
        { label: '7ë…„ ëª©í‘œ', value: Number(state.goals.year7) || 0, icon: 'ğŸ‘‘', color: 'purple' },
        { label: '5ë…„ ëª©í‘œ', value: Number(state.goals.year5) || 0, icon: 'ğŸ’', color: 'blue' },
        { label: '3ë…„ ëª©í‘œ', value: Number(state.goals.year3) || 0, icon: 'ğŸ†', color: 'green' },
        { label: 'ì˜¬í•´ ëª©í‘œ', value: Number(state.goals.thisYear) || 0, icon: 'â­', color: 'yellow' }
      ];

      var goalAchievementHtml = goals.map(function(goal) {
        if (goal.value === 0) return '';
        var percentage = Math.min((totalBank / goal.value) * 100, 100);
        var remaining = Math.max(goal.value - totalBank, 0);
        var isAchieved = totalBank >= goal.value;
        
        var barColor = goal.color === 'purple' ? 'from-purple-400 to-purple-600' :
                       goal.color === 'blue' ? 'from-blue-400 to-blue-600' :
                       goal.color === 'green' ? 'from-green-400 to-green-600' :
                       'from-yellow-400 to-yellow-600';
        
        var textColor = goal.color === 'purple' ? 'text-purple-700' :
                        goal.color === 'blue' ? 'text-blue-700' :
                        goal.color === 'green' ? 'text-green-700' :
                        'text-yellow-700';
        
        var bgColor = goal.color === 'purple' ? 'bg-purple-50 border-purple-200' :
                      goal.color === 'blue' ? 'bg-blue-50 border-blue-200' :
                      goal.color === 'green' ? 'bg-green-50 border-green-200' :
                      'bg-yellow-50 border-yellow-200';

        return '<div class="p-4 rounded-xl border ' + bgColor + ' mb-3">' +
          '<div class="flex justify-between items-center mb-2">' +
            '<div class="flex items-center gap-2">' +
              '<span class="text-xl">' + goal.icon + '</span>' +
              '<span class="font-bold ' + textColor + '">' + goal.label + '</span>' +
            '</div>' +
            '<div class="text-right">' +
              '<div class="text-sm text-gray-600">' + formatNumber(totalBank) + ' / ' + formatNumber(goal.value) + 'ì›</div>' +
            '</div>' +
          '</div>' +
          '<div class="relative w-full bg-gray-200 rounded-full h-8 overflow-hidden">' +
            '<div class="absolute inset-0 bg-gradient-to-r ' + barColor + ' h-8 rounded-full transition-all duration-500 flex items-center justify-end pr-2" style="width: ' + percentage + '%">' +
              (percentage > 15 ? '<span class="text-white font-bold text-sm drop-shadow">' + percentage.toFixed(1) + '%</span>' : '') +
            '</div>' +
            (percentage <= 15 ? '<span class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-600 font-bold text-sm">' + percentage.toFixed(1) + '%</span>' : '') +
          '</div>' +
          '<div class="flex justify-between items-center mt-2 text-sm">' +
            (isAchieved ? 
              '<span class="text-green-600 font-bold">ğŸ‰ ëª©í‘œ ë‹¬ì„±!</span><span></span>' :
              '<span class="text-gray-600">ë‹¬ì„±ë¥ : ' + percentage.toFixed(1) + '%</span>' +
              '<span class="text-red-600 font-medium">ë‚¨ì€ ê¸ˆì•¡: ' + formatNumber(remaining) + 'ì›</span>') +
          '</div>' +
        '</div>';
      }).join('');

      // Bank distribution chart
      var maxBankBalance = Math.max.apply(null, state.bankBalances.map(function(b) { return b.balance; }).concat([1]));
      var bankChartHtml = state.bankBalances.length > 0 ? state.bankBalances.map(function(b, index) {
        var percentage = (b.balance / totalBank) * 100;
        var barWidth = (b.balance / maxBankBalance) * 100;
        var colors = ['from-blue-400 to-blue-600', 'from-green-400 to-green-600', 'from-purple-400 to-purple-600', 'from-orange-400 to-orange-600', 'from-pink-400 to-pink-600', 'from-teal-400 to-teal-600'];
        var color = colors[index % colors.length];
        
        return '<div class="mb-3">' +
          '<div class="flex justify-between items-center mb-1">' +
            '<span class="text-sm font-medium text-gray-700">' + b.name + '</span>' +
            '<span class="text-sm text-gray-600">' + formatNumber(b.balance) + 'ì› (' + percentage.toFixed(1) + '%)</span>' +
          '</div>' +
          '<div class="w-full bg-gray-200 rounded-full h-6 overflow-hidden">' +
            '<div class="bg-gradient-to-r ' + color + ' h-6 rounded-full transition-all duration-500 flex items-center justify-end pr-2" style="width: ' + barWidth + '%">' +
              (barWidth > 20 ? '<span class="text-white text-xs font-bold">' + percentage.toFixed(0) + '%</span>' : '') +
            '</div>' +
          '</div>' +
        '</div>';
      }).join('') : '<div class="text-center text-gray-400 py-4">ë“±ë¡ëœ ì€í–‰ì´ ì—†ìŠµë‹ˆë‹¤</div>';

      return '<div class="p-4 space-y-6">' +
        // Goal Achievement Status
        '<div class="bg-white rounded-xl shadow-lg p-4">' +
          '<h3 class="font-bold mb-4 flex items-center gap-2">ğŸ“Š ëª©í‘œ ë‹¬ì„± í˜„í™©</h3>' +
          '<div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-4 rounded-xl mb-4">' +
            '<div class="text-sm opacity-90">í˜„ì¬ ì´ ìì‚°</div>' +
            '<div class="text-3xl font-bold">' + formatNumber(totalBank) + 'ì›</div>' +
          '</div>' +
          (goalAchievementHtml || '<div class="text-center text-gray-400 py-4">ëª©í‘œë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”</div>') +
        '</div>' +
        // Bank Distribution Chart
        '<div class="bg-white rounded-xl shadow-lg p-4">' +
          '<h3 class="font-bold mb-4 flex items-center gap-2">ğŸ“ˆ ì€í–‰ë³„ ìì‚° ë¶„í¬</h3>' +
          '<div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-xl mb-4">' +
            '<div class="text-sm text-blue-600 font-medium">ì´ ìì‚°</div>' +
            '<div class="text-2xl font-bold text-blue-700">' + formatNumber(totalBank) + 'ì›</div>' +
            '<div class="text-xs text-gray-500 mt-1">' + state.bankBalances.length + 'ê°œ ì€í–‰</div>' +
          '</div>' +
          bankChartHtml +
        '</div>' +
        '<div class="bg-white rounded-xl shadow-lg p-4">' +
          '<h3 class="font-bold mb-4">ğŸ¯ ìˆ˜ì… ëª©í‘œ</h3>' +
          '<div class="space-y-3">' +
            '<div><label class="block text-sm font-medium mb-1 text-purple-700">ğŸ‘‘ 7ë…„ ëª©í‘œ</label>' +
              '<input type="text" id="goal-year7" value="' + (state.goals.year7 ? Number(state.goals.year7).toLocaleString() : '') + '" class="w-full p-2 border rounded-lg" placeholder="ê¸ˆì•¡ ì…ë ¥" oninput="formatAmountInput(this)"></div>' +
            '<div><label class="block text-sm font-medium mb-1 text-blue-700">ğŸ’ 5ë…„ ëª©í‘œ</label>' +
              '<input type="text" id="goal-year5" value="' + (state.goals.year5 ? Number(state.goals.year5).toLocaleString() : '') + '" class="w-full p-2 border rounded-lg" placeholder="ê¸ˆì•¡ ì…ë ¥" oninput="formatAmountInput(this)"></div>' +
            '<div><label class="block text-sm font-medium mb-1 text-green-700">ğŸ† 3ë…„ ëª©í‘œ</label>' +
              '<input type="text" id="goal-year3" value="' + (state.goals.year3 ? Number(state.goals.year3).toLocaleString() : '') + '" class="w-full p-2 border rounded-lg" placeholder="ê¸ˆì•¡ ì…ë ¥" oninput="formatAmountInput(this)"></div>' +
            '<div><label class="block text-sm font-medium mb-1 text-yellow-700">â­ ì˜¬í•´ ëª©í‘œ</label>' +
              '<input type="text" id="goal-thisYear" value="' + (state.goals.thisYear ? Number(state.goals.thisYear).toLocaleString() : '') + '" class="w-full p-2 border rounded-lg" placeholder="ê¸ˆì•¡ ì…ë ¥" oninput="formatAmountInput(this)"></div>' +
            '<button onclick="saveGoals()" class="w-full bg-blue-500 text-white py-2 rounded-lg font-medium">ëª©í‘œ ì €ì¥</button>' +
          '</div>' +
        '</div>' +
        '<div class="bg-white rounded-xl shadow-lg p-4">' +
          '<h3 class="font-bold mb-4">ì€í–‰ë³„ í†µí•©ì”ê³ </h3>' +
          '<div class="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-lg mb-4">' +
            '<div class="text-sm text-blue-600">ì´ ì”ê³ </div>' +
            '<div class="text-2xl font-bold text-blue-700">' + formatNumber(totalBank) + 'ì›</div>' +
          '</div>' +
          '<div class="space-y-2 mb-4">' + bankListHtml + '</div>' +
          '<div class="space-y-2">' +
            '<input type="text" id="newBankName" class="w-full p-2 border rounded-lg" placeholder="ì€í–‰ëª…">' +
            '<input type="text" id="newBankBalance" class="w-full p-2 border rounded-lg" placeholder="ì”ê³ " oninput="formatAmountInput(this)">' +
            '<button onclick="addBank()" class="w-full bg-green-500 text-white py-2 rounded-lg">ì€í–‰ ì¶”ê°€</button>' +
          '</div>' +
        '</div>' +
        // Loan Section
        renderLoanSection() +
      '</div>';
    }

    function saveGoals() {
      state.goals = {
        year7: getAmountValue('goal-year7') || '',
        year5: getAmountValue('goal-year5') || '',
        year3: getAmountValue('goal-year3') || '',
        thisYear: getAmountValue('goal-thisYear') || ''
      };
      saveData();
      render();
      showToast('ëª©í‘œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function addBank() {
      var name = document.getElementById('newBankName') ? document.getElementById('newBankName').value.trim() : '';
      var balanceStr = document.getElementById('newBankBalance') ? document.getElementById('newBankBalance').value : '0';
      var balance = parseInt(balanceStr.replace(/[^\d]/g, ''), 10) || 0;
      if (!name) { alert('ì€í–‰ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
      if (balance <= 0) { alert('ì”ê³ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
      state.bankBalances.push({ id: Date.now(), name: name, balance: balance });
      saveData();
      render();
      showToast('ì€í–‰ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function editBank(id) {
      var bank = state.bankBalances.find(function(b) { return b.id === id; });
      if (!bank) return;
      
      var newName = prompt('ì€í–‰ëª…:', bank.name);
      if (newName === null) return;
      
      var newBalanceStr = prompt('ì”ê³ :', bank.balance.toLocaleString());
      if (newBalanceStr === null) return;
      
      var newBalance = parseInt(newBalanceStr.replace(/[^\d]/g, ''), 10);
      if (isNaN(newBalance) || newBalance < 0) {
        alert('ì˜¬ë°”ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }
      
      bank.name = newName.trim() || bank.name;
      bank.balance = newBalance;
      
      saveData();
      render();
      showToast('ì€í–‰ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function deleteBank(id) {
      if (confirm('ì€í–‰ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        state.bankBalances = state.bankBalances.filter(function(b) { return b.id !== id; });
        saveData();
        render();
        showToast('ì€í–‰ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    }

    // Investment Screen
    var investmentSearchKeyword = '';
    var isComposingInvestment = false;
    var investmentListExpanded = false;
    
    function updateInvestmentSearch(keyword) {
      investmentSearchKeyword = keyword;
      updateInvestmentList();
    }
    
    function toggleInvestmentList() {
      investmentListExpanded = !investmentListExpanded;
      updateInvestmentList();
    }
    
    function updateInvestmentList() {
      var listContainer = document.getElementById('investment-list-container');
      if (!listContainer) return;
      
      var typeLabels = { stock: 'ì£¼ì‹', etf: 'ETF', fund: 'í€ë“œ', crypto: 'ì•”í˜¸í™”í', gold: 'ê¸ˆ', realestate: 'ë¶€ë™ì‚°', bond: 'ì±„ê¶Œ', other: 'ê¸°íƒ€' };
      var typeIcons = { stock: 'ğŸ“Š', etf: 'ğŸ“¦', fund: 'ğŸ’¼', crypto: 'ğŸª™', gold: 'ğŸ¥‡', realestate: 'ğŸ ', bond: 'ğŸ“ƒ', other: 'ğŸ“„' };
      
      var filteredInvestments = state.investments.filter(function(inv) {
        if (!investmentSearchKeyword) return true;
        var keyword = investmentSearchKeyword.toLowerCase();
        var name = inv.name.toLowerCase();
        var typeLabel = (typeLabels[inv.type] || 'ê¸°íƒ€').toLowerCase();
        return name.indexOf(keyword) >= 0 || typeLabel.indexOf(keyword) >= 0;
      });
      
      var countText = document.getElementById('investment-count');
      if (countText) {
        countText.textContent = 'ì´ ' + state.investments.length + 'ê°œ ì¢…ëª© ì¤‘ ' + filteredInvestments.length + 'ê°œ í‘œì‹œ';
      }
      
      // íˆ¬ì ìœ í˜•ë³„ ê·¸ë¼ë°ì´ì…˜ ìƒ‰ìƒ
      var typeGradients = { 
        stock: 'from-blue-500 to-indigo-600', 
        etf: 'from-purple-500 to-pink-600', 
        fund: 'from-emerald-500 to-teal-600', 
        crypto: 'from-orange-500 to-amber-600', 
        gold: 'from-yellow-500 to-orange-500', 
        realestate: 'from-green-500 to-emerald-600', 
        bond: 'from-gray-500 to-slate-600', 
        other: 'from-indigo-500 to-purple-600' 
      };
      
      // íˆ¬ì ìœ í˜•ë³„ ìˆ˜ëŸ‰ ë‹¨ìœ„
      var typeUnits = { 
        stock: 'ì£¼', 
        etf: 'ì£¼', 
        fund: 'ì£¼', 
        crypto: 'ì£¼', 
        gold: 'ëˆ', 
        realestate: 'ê°œ', 
        bond: 'ê°œ', 
        other: 'ê°œ' 
      };
      
      var investListHtml = '';
      if (state.investments.length === 0) {
        investListHtml = '<div class="text-center py-12">' +
          '<div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-indigo-100 to-purple-100 rounded-full flex items-center justify-center">' +
            '<span class="text-3xl">ğŸ“Š</span>' +
          '</div>' +
          '<p class="text-gray-500 font-medium">ì•„ì§ ë“±ë¡ëœ íˆ¬ì ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤</p>' +
          '<p class="text-gray-400 text-sm mt-1">ì¢…ëª©ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>' +
        '</div>';
      } else if (filteredInvestments.length === 0) {
        investListHtml = '<div class="text-center py-8">' +
          '<div class="w-12 h-12 mx-auto mb-3 bg-gray-100 rounded-full flex items-center justify-center">' +
            '<i data-lucide="search-x" class="w-6 h-6 text-gray-400"></i>' +
          '</div>' +
          '<p class="text-gray-500">"' + investmentSearchKeyword + '" ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>' +
        '</div>';
      } else {
        // í‘œì‹œí•  í•­ëª© ê²°ì • (1ê°œ ë˜ëŠ” ì „ì²´)
        var visibleInvestments = investmentListExpanded ? filteredInvestments : filteredInvestments.slice(0, 1);
        var hiddenCount = filteredInvestments.length - 1;
        
        function renderInvestmentCard(inv) {
          var invested = inv.buyPrice * inv.quantity;
          var current = inv.currentPrice * inv.quantity;
          var profit = current - invested;
          var profitRate = invested > 0 ? ((profit / invested) * 100).toFixed(2) : 0;
          var icon = typeIcons[inv.type] || 'ğŸ“„';
          var label = typeLabels[inv.type] || 'ê¸°íƒ€';
          var gradient = typeGradients[inv.type] || 'from-indigo-500 to-purple-600';
          var unit = typeUnits[inv.type] || 'ê°œ';
          
          return '<div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-lg transition-all duration-300">' +
            '<div class="bg-gradient-to-r ' + gradient + ' p-4">' +
              '<div class="flex justify-between items-start">' +
                '<div class="flex items-center gap-3">' +
                  '<div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center shadow-md">' +
                    '<span class="text-2xl">' + icon + '</span>' +
                  '</div>' +
                  '<div>' +
                    '<div class="font-bold text-white text-lg drop-shadow-sm">' + inv.name + '</div>' +
                    '<div class="flex items-center gap-2 mt-1">' +
                      '<span class="text-xs bg-white px-2 py-0.5 rounded-full font-semibold text-gray-700 shadow-sm">' + label + '</span>' +
                      '<span class="text-white text-opacity-90 text-xs">' + (Number.isInteger(inv.quantity) ? inv.quantity : inv.quantity.toFixed(4)) + unit + '</span>' +
                    '</div>' +
                  '</div>' +
                '</div>' +
                '<div class="text-right bg-white px-3 py-2 rounded-xl shadow-md">' +
                  '<div class="font-bold ' + (profit >= 0 ? 'text-red-600' : 'text-blue-600') + ' text-lg">' + (profit >= 0 ? '+' : '') + formatNumber(profit) + '</div>' +
                  '<div class="text-xs ' + (profit >= 0 ? 'text-red-500' : 'text-blue-500') + ' font-semibold">' + (profit >= 0 ? 'â–²' : 'â–¼') + ' ' + Math.abs(profitRate) + '%</div>' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="p-4">' +
              '<div class="grid grid-cols-2 gap-3 mb-3">' +
                '<div class="bg-gray-50 p-3 rounded-xl border border-gray-100">' +
                  '<div class="text-xs text-gray-500 font-medium mb-1">ğŸ“Š ë§¤ì…ê°€ (1ì£¼)</div>' +
                  '<div class="font-bold text-gray-800">' + formatNumber(inv.buyPrice) + 'ì›</div>' +
                '</div>' +
                '<div class="bg-gray-50 p-3 rounded-xl border border-gray-100">' +
                  '<div class="text-xs text-gray-500 font-medium mb-1">ğŸ’¹ í˜„ì¬ê°€ (1ì£¼)</div>' +
                  '<div class="font-bold text-gray-800">' + formatNumber(inv.currentPrice) + 'ì›</div>' +
                '</div>' +
              '</div>' +
              '<div class="grid grid-cols-2 gap-3 mb-4">' +
                '<div class="bg-gradient-to-br from-indigo-50 to-blue-50 p-3 rounded-xl border border-indigo-200">' +
                  '<div class="text-xs text-indigo-600 font-semibold mb-1">ğŸ’° ì´ë§¤ì…ê°€</div>' +
                  '<div class="font-bold text-indigo-700 text-lg">' + formatNumber(invested) + 'ì›</div>' +
                '</div>' +
                '<div class="bg-gradient-to-br from-purple-50 to-pink-50 p-3 rounded-xl border border-purple-200">' +
                  '<div class="text-xs text-purple-600 font-semibold mb-1">ğŸ’ ì´í˜„ì¬ê°€</div>' +
                  '<div class="font-bold text-purple-700 text-lg">' + formatNumber(current) + 'ì›</div>' +
                '</div>' +
              '</div>' +
              '<div class="flex gap-2">' +
                '<button onclick="editInvestmentPrice(' + inv.id + ')" class="flex-1 bg-gradient-to-r from-blue-500 to-indigo-500 text-white py-2.5 rounded-xl font-medium text-sm hover:shadow-md transition-all duration-200 flex items-center justify-center gap-2">' +
                  '<i data-lucide="edit-3" class="w-4 h-4"></i>' +
                  '<span>í˜„ì¬ê°€ ìˆ˜ì •</span>' +
                '</button>' +
                '<button onclick="deleteInvestment(' + inv.id + ')" class="flex-1 bg-gray-100 text-gray-600 py-2.5 rounded-xl font-medium text-sm hover:bg-red-50 hover:text-red-600 transition-all duration-200 flex items-center justify-center gap-2">' +
                  '<i data-lucide="trash-2" class="w-4 h-4"></i>' +
                  '<span>ì‚­ì œ</span>' +
                '</button>' +
              '</div>' +
            '</div>' +
          '</div>';
        }
        
        investListHtml = visibleInvestments.map(renderInvestmentCard).join('');
        
        // ë”ë³´ê¸°/ì ‘ê¸° ë²„íŠ¼ ì¶”ê°€ (2ê°œ ì´ìƒì¼ ë•Œë§Œ)
        if (filteredInvestments.length > 1) {
          investListHtml += '<button onclick="toggleInvestmentList()" class="w-full py-3 mt-3 bg-gradient-to-r from-indigo-100 to-purple-100 text-indigo-700 font-semibold rounded-xl hover:from-indigo-200 hover:to-purple-200 transition-all duration-200 flex items-center justify-center gap-2">' +
            (investmentListExpanded ? 
              '<i data-lucide="chevron-up" class="w-5 h-5"></i><span>ì ‘ê¸°</span>' : 
              '<i data-lucide="chevron-down" class="w-5 h-5"></i><span>ë”ë³´ê¸° (' + hiddenCount + 'ê°œ)</span>') +
          '</button>';
        }
      }
      
      listContainer.innerHTML = investListHtml;
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }
    
    function setDividendPeriod(period) {
      state.dividendPeriod = period;
      updateDividendList();
    }
    
    var isComposingDividend = false;
    var dividendListExpanded = false;
    
    function updateDividendSearch(keyword) {
      state.dividendSearchKeyword = keyword;
      updateDividendList();
    }
    
    function toggleDividendList() {
      dividendListExpanded = !dividendListExpanded;
      updateDividendList();
    }
    
    function updateDividendList() {
      var listContainer = document.getElementById('dividend-list-container');
      var countText = document.getElementById('dividend-count');
      var periodButtons = document.querySelectorAll('.dividend-period-btn');
      
      if (!listContainer) return;
      
      var dividendSearchKeyword = state.dividendSearchKeyword || '';
      var dividendPeriod = state.dividendPeriod || 'all';
      
      // Update period buttons
      periodButtons.forEach(function(btn) {
        var period = btn.dataset.period;
        if (period === dividendPeriod) {
          btn.className = 'dividend-period-btn px-3 py-1 rounded-lg text-xs font-medium whitespace-nowrap bg-green-500 text-white';
        } else {
          btn.className = 'dividend-period-btn px-3 py-1 rounded-lg text-xs font-medium whitespace-nowrap bg-gray-200 text-gray-700';
        }
      });
      
      var filteredDividends = state.dividends.filter(function(d) {
        if (!dividendSearchKeyword) return true;
        return d.stockName.toLowerCase().indexOf(dividendSearchKeyword.toLowerCase()) >= 0;
      });
      
      if (countText) {
        countText.textContent = 'ì´ ' + state.dividends.length + 'ê±´ ì¤‘ ' + filteredDividends.length + 'ê±´ í‘œì‹œ';
      }
      
      // Group dividends by period
      var groupedDividends = {};
      filteredDividends.forEach(function(d) {
        var date = new Date(d.date);
        var key;
        if (dividendPeriod === 'weekly') {
          var weekStart = new Date(date);
          weekStart.setDate(date.getDate() - date.getDay());
          key = weekStart.toISOString().split('T')[0] + ' ì£¼';
        } else if (dividendPeriod === 'monthly') {
          key = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');
        } else if (dividendPeriod === 'yearly') {
          key = date.getFullYear() + 'ë…„';
        } else {
          key = 'all';
        }
        if (!groupedDividends[key]) groupedDividends[key] = [];
        groupedDividends[key].push(d);
      });
      
      var dividendListHtml = '';
      if (state.dividends.length === 0) {
        dividendListHtml = '<div class="text-center py-12">' +
          '<div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-green-100 to-emerald-100 rounded-full flex items-center justify-center">' +
            '<span class="text-3xl">ğŸ’¸</span>' +
          '</div>' +
          '<p class="text-gray-500 font-medium">ì•„ì§ ë°°ë‹¹ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p>' +
          '<p class="text-gray-400 text-sm mt-1">ë°°ë‹¹ê¸ˆì„ ë°›ìœ¼ë©´ ê¸°ë¡í•´ë³´ì„¸ìš”!</p>' +
        '</div>';
      } else if (filteredDividends.length === 0) {
        dividendListHtml = '<div class="text-center py-8">' +
          '<div class="w-12 h-12 mx-auto mb-3 bg-gray-100 rounded-full flex items-center justify-center">' +
            '<i data-lucide="search-x" class="w-6 h-6 text-gray-400"></i>' +
          '</div>' +
          '<p class="text-gray-500">"' + dividendSearchKeyword + '" ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>' +
        '</div>';
      } else {
        if (dividendPeriod === 'all') {
          var sortedDividends = filteredDividends.slice().sort(function(a, b) { return new Date(b.date) - new Date(a.date); });
          // í‘œì‹œí•  í•­ëª© ê²°ì • (10ê°œ ë˜ëŠ” ì „ì²´)
          var visibleDividends = dividendListExpanded ? sortedDividends : sortedDividends.slice(0, 10);
          var hiddenDivCount = sortedDividends.length - 10;
          
          function renderDividendCard(d) {
            return '<div class="bg-white rounded-xl p-3 shadow-sm border border-green-100 hover:shadow-md hover:border-green-200 transition-all duration-200">' +
              '<div class="flex items-center justify-between">' +
                '<div class="flex items-center gap-3">' +
                  '<div class="w-10 h-10 bg-gradient-to-br from-emerald-400 to-green-500 rounded-lg flex items-center justify-center shadow-sm">' +
                    '<span class="text-white font-bold text-sm">' + (d.stockName.charAt(0)) + '</span>' +
                  '</div>' +
                  '<div>' +
                    '<div class="font-semibold text-gray-800">' + d.stockName + '</div>' +
                    '<div class="text-xs text-gray-400 flex items-center gap-1">' +
                      '<i data-lucide="calendar" class="w-3 h-3"></i>' + d.date +
                    '</div>' +
                  '</div>' +
                '</div>' +
                '<div class="flex items-center gap-3">' +
                  '<div class="text-right">' +
                    '<div class="font-bold text-green-600 text-lg">+' + formatNumber(d.amount) + '</div>' +
                    '<div class="text-xs text-gray-400">ì›</div>' +
                  '</div>' +
                  '<button onclick="deleteDividend(' + d.id + ')" class="w-8 h-8 flex items-center justify-center rounded-lg text-gray-400 hover:text-red-500 hover:bg-red-50 transition-colors">' +
                    '<i data-lucide="trash-2" class="w-4 h-4"></i>' +
                  '</button>' +
                '</div>' +
              '</div>' +
            '</div>';
          }
          
          dividendListHtml = '<div class="space-y-2">' +
            visibleDividends.map(renderDividendCard).join('') +
          '</div>';
          
          // ë”ë³´ê¸°/ì ‘ê¸° ë²„íŠ¼ ì¶”ê°€ (11ê°œ ì´ìƒì¼ ë•Œë§Œ)
          if (sortedDividends.length > 10) {
            dividendListHtml += '<button onclick="toggleDividendList()" class="w-full py-3 mt-3 bg-gradient-to-r from-emerald-100 to-green-100 text-green-700 font-semibold rounded-xl hover:from-emerald-200 hover:to-green-200 transition-all duration-200 flex items-center justify-center gap-2">' +
              (dividendListExpanded ? 
                '<i data-lucide="chevron-up" class="w-5 h-5"></i><span>ì ‘ê¸°</span>' : 
                '<i data-lucide="chevron-down" class="w-5 h-5"></i><span>ë”ë³´ê¸° (' + hiddenDivCount + 'ê±´)</span>') +
            '</button>';
          }
        } else {
          dividendListHtml = '<div class="space-y-4">' +
            Object.keys(groupedDividends).sort().reverse().map(function(period) {
              var periodDividends = groupedDividends[period];
              var periodTotal = periodDividends.reduce(function(s, d) { return s + d.amount; }, 0);
              
              return '<div class="bg-white rounded-xl overflow-hidden shadow-sm border border-green-100">' +
                '<div class="bg-gradient-to-r from-emerald-500 to-green-500 px-4 py-3 flex justify-between items-center">' +
                  '<div class="flex items-center gap-2">' +
                    '<i data-lucide="calendar-days" class="w-4 h-4 text-green-100"></i>' +
                    '<span class="font-bold text-white">' + period + '</span>' +
                  '</div>' +
                  '<div class="bg-yellow-300 px-3 py-1.5 rounded-lg shadow-sm">' +
                    '<span class="font-bold text-green-800">+' + formatNumber(periodTotal) + 'ì›</span>' +
                  '</div>' +
                '</div>' +
                '<div class="divide-y divide-gray-100">' +
                  periodDividends.sort(function(a, b) { return new Date(b.date) - new Date(a.date); }).map(function(d) {
                    return '<div class="flex items-center justify-between p-3 hover:bg-green-50 transition-colors">' +
                      '<div class="flex items-center gap-3">' +
                        '<div class="w-8 h-8 bg-gradient-to-br from-green-100 to-emerald-100 rounded-lg flex items-center justify-center">' +
                          '<span class="text-green-600 font-semibold text-xs">' + (d.stockName.charAt(0)) + '</span>' +
                        '</div>' +
                        '<div>' +
                          '<div class="font-medium text-gray-800 text-sm">' + d.stockName + '</div>' +
                          '<div class="text-xs text-gray-400">' + d.date + '</div>' +
                        '</div>' +
                      '</div>' +
                      '<div class="flex items-center gap-2">' +
                        '<span class="font-bold text-green-600">+' + formatNumber(d.amount) + 'ì›</span>' +
                        '<button onclick="deleteDividend(' + d.id + ')" class="w-7 h-7 flex items-center justify-center rounded-lg text-gray-400 hover:text-red-500 hover:bg-red-50 transition-colors">' +
                          '<i data-lucide="trash-2" class="w-3.5 h-3.5"></i>' +
                        '</button>' +
                      '</div>' +
                    '</div>';
                  }).join('') +
                '</div>' +
              '</div>';
            }).join('') +
          '</div>';
        }
      }
      
      listContainer.innerHTML = dividendListHtml;
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }
    
    function renderInvestmentScreen() {
      var totalInvested = state.investments.reduce(function(s, i) { return s + i.buyPrice * i.quantity; }, 0);
      var totalCurrentValue = state.investments.reduce(function(s, i) { return s + i.currentPrice * i.quantity; }, 0);
      var totalProfit = totalCurrentValue - totalInvested;
      var totalDividends = state.dividends.reduce(function(s, d) { return s + d.amount; }, 0);

      var typeLabels = { stock: 'ì£¼ì‹', etf: 'ETF', fund: 'í€ë“œ', crypto: 'ì•”í˜¸í™”í', gold: 'ê¸ˆ', realestate: 'ë¶€ë™ì‚°', bond: 'ì±„ê¶Œ', other: 'ê¸°íƒ€' };
      var typeIcons = { stock: 'ğŸ“Š', etf: 'ğŸ“¦', fund: 'ğŸ’¼', crypto: 'ğŸª™', gold: 'ğŸ¥‡', realestate: 'ğŸ ', bond: 'ğŸ“ƒ', other: 'ğŸ“„' };

      // Filter investments by search keyword
      var filteredInvestments = state.investments.filter(function(inv) {
        if (!investmentSearchKeyword) return true;
        var keyword = investmentSearchKeyword.toLowerCase();
        var name = inv.name.toLowerCase();
        var typeLabel = (typeLabels[inv.type] || 'ê¸°íƒ€').toLowerCase();
        return name.indexOf(keyword) >= 0 || typeLabel.indexOf(keyword) >= 0;
      });

      // íˆ¬ì ìœ í˜•ë³„ ê·¸ë¼ë°ì´ì…˜ ìƒ‰ìƒ
      var typeGradients = { 
        stock: 'from-blue-500 to-indigo-600', 
        etf: 'from-purple-500 to-pink-600', 
        fund: 'from-emerald-500 to-teal-600', 
        crypto: 'from-orange-500 to-amber-600', 
        gold: 'from-yellow-500 to-orange-500', 
        realestate: 'from-green-500 to-emerald-600', 
        bond: 'from-gray-500 to-slate-600', 
        other: 'from-indigo-500 to-purple-600' 
      };
      
      // íˆ¬ì ìœ í˜•ë³„ ìˆ˜ëŸ‰ ë‹¨ìœ„
      var typeUnits = { 
        stock: 'ì£¼', 
        etf: 'ì£¼', 
        fund: 'ì£¼', 
        crypto: 'ì£¼', 
        gold: 'ëˆ', 
        realestate: 'ê°œ', 
        bond: 'ê°œ', 
        other: 'ê°œ' 
      };
      
      var investListHtml = '';
      if (state.investments.length === 0) {
        investListHtml = '<div class="text-center py-12">' +
          '<div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-indigo-100 to-purple-100 rounded-full flex items-center justify-center">' +
            '<span class="text-3xl">ğŸ“Š</span>' +
          '</div>' +
          '<p class="text-gray-500 font-medium">ì•„ì§ ë“±ë¡ëœ íˆ¬ì ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤</p>' +
          '<p class="text-gray-400 text-sm mt-1">ì¢…ëª©ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>' +
        '</div>';
      } else if (filteredInvestments.length === 0) {
        investListHtml = '<div class="text-center py-8">' +
          '<div class="w-12 h-12 mx-auto mb-3 bg-gray-100 rounded-full flex items-center justify-center">' +
            '<i data-lucide="search-x" class="w-6 h-6 text-gray-400"></i>' +
          '</div>' +
          '<p class="text-gray-500">"' + investmentSearchKeyword + '" ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>' +
        '</div>';
      } else {
        // í‘œì‹œí•  í•­ëª© ê²°ì • (1ê°œ ë˜ëŠ” ì „ì²´)
        var visibleInvestments = investmentListExpanded ? filteredInvestments : filteredInvestments.slice(0, 1);
        var hiddenCount = filteredInvestments.length - 1;
        
        function renderInvCard(inv) {
          var invested = inv.buyPrice * inv.quantity;
          var current = inv.currentPrice * inv.quantity;
          var profit = current - invested;
          var profitRate = invested > 0 ? ((profit / invested) * 100).toFixed(2) : 0;
          var icon = typeIcons[inv.type] || 'ğŸ“„';
          var label = typeLabels[inv.type] || 'ê¸°íƒ€';
          var gradient = typeGradients[inv.type] || 'from-indigo-500 to-purple-600';
          var unit = typeUnits[inv.type] || 'ê°œ';
          
          return '<div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-lg transition-all duration-300">' +
            '<div class="bg-gradient-to-r ' + gradient + ' p-4">' +
              '<div class="flex justify-between items-start">' +
                '<div class="flex items-center gap-3">' +
                  '<div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center shadow-md">' +
                    '<span class="text-2xl">' + icon + '</span>' +
                  '</div>' +
                  '<div>' +
                    '<div class="font-bold text-white text-lg drop-shadow-sm">' + inv.name + '</div>' +
                    '<div class="flex items-center gap-2 mt-1">' +
                      '<span class="text-xs bg-white px-2 py-0.5 rounded-full font-semibold text-gray-700 shadow-sm">' + label + '</span>' +
                      '<span class="text-white text-opacity-90 text-xs">' + (Number.isInteger(inv.quantity) ? inv.quantity : inv.quantity.toFixed(4)) + unit + '</span>' +
                    '</div>' +
                  '</div>' +
                '</div>' +
                '<div class="text-right bg-white px-3 py-2 rounded-xl shadow-md">' +
                  '<div class="font-bold ' + (profit >= 0 ? 'text-red-600' : 'text-blue-600') + ' text-lg">' + (profit >= 0 ? '+' : '') + formatNumber(profit) + '</div>' +
                  '<div class="text-xs ' + (profit >= 0 ? 'text-red-500' : 'text-blue-500') + ' font-semibold">' + (profit >= 0 ? 'â–²' : 'â–¼') + ' ' + Math.abs(profitRate) + '%</div>' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="p-4">' +
              '<div class="grid grid-cols-2 gap-3 mb-3">' +
                '<div class="bg-gray-50 p-3 rounded-xl border border-gray-100">' +
                  '<div class="text-xs text-gray-500 font-medium mb-1">ğŸ“Š ë§¤ì…ê°€ (1ì£¼)</div>' +
                  '<div class="font-bold text-gray-800">' + formatNumber(inv.buyPrice) + 'ì›</div>' +
                '</div>' +
                '<div class="bg-gray-50 p-3 rounded-xl border border-gray-100">' +
                  '<div class="text-xs text-gray-500 font-medium mb-1">ğŸ’¹ í˜„ì¬ê°€ (1ì£¼)</div>' +
                  '<div class="font-bold text-gray-800">' + formatNumber(inv.currentPrice) + 'ì›</div>' +
                '</div>' +
              '</div>' +
              '<div class="grid grid-cols-2 gap-3 mb-4">' +
                '<div class="bg-gradient-to-br from-indigo-50 to-blue-50 p-3 rounded-xl border border-indigo-200">' +
                  '<div class="text-xs text-indigo-600 font-semibold mb-1">ğŸ’° ì´ë§¤ì…ê°€</div>' +
                  '<div class="font-bold text-indigo-700 text-lg">' + formatNumber(invested) + 'ì›</div>' +
                '</div>' +
                '<div class="bg-gradient-to-br from-purple-50 to-pink-50 p-3 rounded-xl border border-purple-200">' +
                  '<div class="text-xs text-purple-600 font-semibold mb-1">ğŸ’ ì´í˜„ì¬ê°€</div>' +
                  '<div class="font-bold text-purple-700 text-lg">' + formatNumber(current) + 'ì›</div>' +
                '</div>' +
              '</div>' +
              '<div class="flex gap-2">' +
                '<button onclick="editInvestmentPrice(' + inv.id + ')" class="flex-1 bg-gradient-to-r from-blue-500 to-indigo-500 text-white py-2.5 rounded-xl font-medium text-sm hover:shadow-md transition-all duration-200 flex items-center justify-center gap-2">' +
                  '<i data-lucide="edit-3" class="w-4 h-4"></i>' +
                  '<span>í˜„ì¬ê°€ ìˆ˜ì •</span>' +
                '</button>' +
                '<button onclick="deleteInvestment(' + inv.id + ')" class="flex-1 bg-gray-100 text-gray-600 py-2.5 rounded-xl font-medium text-sm hover:bg-red-50 hover:text-red-600 transition-all duration-200 flex items-center justify-center gap-2">' +
                  '<i data-lucide="trash-2" class="w-4 h-4"></i>' +
                  '<span>ì‚­ì œ</span>' +
                '</button>' +
              '</div>' +
            '</div>' +
          '</div>';
        }
        
        investListHtml = visibleInvestments.map(renderInvCard).join('');
        
        // ë”ë³´ê¸°/ì ‘ê¸° ë²„íŠ¼ ì¶”ê°€ (2ê°œ ì´ìƒì¼ ë•Œë§Œ)
        if (filteredInvestments.length > 1) {
          investListHtml += '<button onclick="toggleInvestmentList()" class="w-full py-3 mt-3 bg-gradient-to-r from-indigo-100 to-purple-100 text-indigo-700 font-semibold rounded-xl hover:from-indigo-200 hover:to-purple-200 transition-all duration-200 flex items-center justify-center gap-2">' +
            (investmentListExpanded ? 
              '<i data-lucide="chevron-up" class="w-5 h-5"></i><span>ì ‘ê¸°</span>' : 
              '<i data-lucide="chevron-down" class="w-5 h-5"></i><span>ë”ë³´ê¸° (' + hiddenCount + 'ê°œ)</span>') +
          '</button>';
        }
      }

      // Dividend filtering and grouping
      var dividendSearchKeyword = state.dividendSearchKeyword || '';
      var dividendPeriod = state.dividendPeriod || 'all';
      
      var filteredDividends = state.dividends.filter(function(d) {
        if (!dividendSearchKeyword) return true;
        return d.stockName.toLowerCase().indexOf(dividendSearchKeyword.toLowerCase()) >= 0;
      });
      
      // Group dividends by period
      var groupedDividends = {};
      filteredDividends.forEach(function(d) {
        var date = new Date(d.date);
        var key;
        if (dividendPeriod === 'weekly') {
          var weekStart = new Date(date);
          weekStart.setDate(date.getDate() - date.getDay());
          key = weekStart.toISOString().split('T')[0] + ' ì£¼';
        } else if (dividendPeriod === 'monthly') {
          key = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');
        } else if (dividendPeriod === 'yearly') {
          key = date.getFullYear() + 'ë…„';
        } else {
          key = 'all';
        }
        if (!groupedDividends[key]) groupedDividends[key] = [];
        groupedDividends[key].push(d);
      });
      
      var dividendListHtml = '';
      if (state.dividends.length === 0) {
        dividendListHtml = '<div class="text-center py-12">' +
          '<div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-green-100 to-emerald-100 rounded-full flex items-center justify-center">' +
            '<span class="text-3xl">ğŸ’¸</span>' +
          '</div>' +
          '<p class="text-gray-500 font-medium">ì•„ì§ ë°°ë‹¹ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p>' +
          '<p class="text-gray-400 text-sm mt-1">ë°°ë‹¹ê¸ˆì„ ë°›ìœ¼ë©´ ê¸°ë¡í•´ë³´ì„¸ìš”!</p>' +
        '</div>';
      } else if (filteredDividends.length === 0) {
        dividendListHtml = '<div class="text-center py-8">' +
          '<div class="w-12 h-12 mx-auto mb-3 bg-gray-100 rounded-full flex items-center justify-center">' +
            '<i data-lucide="search-x" class="w-6 h-6 text-gray-400"></i>' +
          '</div>' +
          '<p class="text-gray-500">"' + dividendSearchKeyword + '" ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>' +
        '</div>';
      } else {
        if (dividendPeriod === 'all') {
          var sortedDividends = filteredDividends.slice().sort(function(a, b) { return new Date(b.date) - new Date(a.date); });
          // í‘œì‹œí•  í•­ëª© ê²°ì • (10ê°œ ë˜ëŠ” ì „ì²´)
          var visibleDividends = dividendListExpanded ? sortedDividends : sortedDividends.slice(0, 10);
          var hiddenDivCount = sortedDividends.length - 10;
          
          function renderDivCard(d) {
            return '<div class="bg-white rounded-xl p-3 shadow-sm border border-green-100 hover:shadow-md hover:border-green-200 transition-all duration-200">' +
              '<div class="flex items-center justify-between">' +
                '<div class="flex items-center gap-3">' +
                  '<div class="w-10 h-10 bg-gradient-to-br from-emerald-400 to-green-500 rounded-lg flex items-center justify-center shadow-sm">' +
                    '<span class="text-white font-bold text-sm">' + (d.stockName.charAt(0)) + '</span>' +
                  '</div>' +
                  '<div>' +
                    '<div class="font-semibold text-gray-800">' + d.stockName + '</div>' +
                    '<div class="text-xs text-gray-400 flex items-center gap-1">' +
                      '<i data-lucide="calendar" class="w-3 h-3"></i>' + d.date +
                    '</div>' +
                  '</div>' +
                '</div>' +
                '<div class="flex items-center gap-3">' +
                  '<div class="text-right">' +
                    '<div class="font-bold text-green-600 text-lg">+' + formatNumber(d.amount) + '</div>' +
                    '<div class="text-xs text-gray-400">ì›</div>' +
                  '</div>' +
                  '<button onclick="deleteDividend(' + d.id + ')" class="w-8 h-8 flex items-center justify-center rounded-lg text-gray-400 hover:text-red-500 hover:bg-red-50 transition-colors">' +
                    '<i data-lucide="trash-2" class="w-4 h-4"></i>' +
                  '</button>' +
                '</div>' +
              '</div>' +
            '</div>';
          }
          
          dividendListHtml = '<div class="space-y-2">' +
            visibleDividends.map(renderDivCard).join('') +
          '</div>';
          
          // ë”ë³´ê¸°/ì ‘ê¸° ë²„íŠ¼ ì¶”ê°€ (11ê°œ ì´ìƒì¼ ë•Œë§Œ)
          if (sortedDividends.length > 10) {
            dividendListHtml += '<button onclick="toggleDividendList()" class="w-full py-3 mt-3 bg-gradient-to-r from-emerald-100 to-green-100 text-green-700 font-semibold rounded-xl hover:from-emerald-200 hover:to-green-200 transition-all duration-200 flex items-center justify-center gap-2">' +
              (dividendListExpanded ? 
                '<i data-lucide="chevron-up" class="w-5 h-5"></i><span>ì ‘ê¸°</span>' : 
                '<i data-lucide="chevron-down" class="w-5 h-5"></i><span>ë”ë³´ê¸° (' + hiddenDivCount + 'ê±´)</span>') +
            '</button>';
          }
        } else {
          dividendListHtml = '<div class="space-y-4">' +
            Object.keys(groupedDividends).sort().reverse().map(function(period) {
              var periodDividends = groupedDividends[period];
              var periodTotal = periodDividends.reduce(function(s, d) { return s + d.amount; }, 0);
              
              return '<div class="bg-white rounded-xl overflow-hidden shadow-sm border border-green-100">' +
                '<div class="bg-gradient-to-r from-emerald-500 to-green-500 px-4 py-3 flex justify-between items-center">' +
                  '<div class="flex items-center gap-2">' +
                    '<i data-lucide="calendar-days" class="w-4 h-4 text-green-100"></i>' +
                    '<span class="font-bold text-white">' + period + '</span>' +
                  '</div>' +
                  '<div class="bg-yellow-300 px-3 py-1.5 rounded-lg shadow-sm">' +
                    '<span class="font-bold text-green-800">+' + formatNumber(periodTotal) + 'ì›</span>' +
                  '</div>' +
                '</div>' +
                '<div class="divide-y divide-gray-100">' +
                  periodDividends.sort(function(a, b) { return new Date(b.date) - new Date(a.date); }).map(function(d) {
                    return '<div class="flex items-center justify-between p-3 hover:bg-green-50 transition-colors">' +
                      '<div class="flex items-center gap-3">' +
                        '<div class="w-8 h-8 bg-gradient-to-br from-green-100 to-emerald-100 rounded-lg flex items-center justify-center">' +
                          '<span class="text-green-600 font-semibold text-xs">' + (d.stockName.charAt(0)) + '</span>' +
                        '</div>' +
                        '<div>' +
                          '<div class="font-medium text-gray-800 text-sm">' + d.stockName + '</div>' +
                          '<div class="text-xs text-gray-400">' + d.date + '</div>' +
                        '</div>' +
                      '</div>' +
                      '<div class="flex items-center gap-2">' +
                        '<span class="font-bold text-green-600">+' + formatNumber(d.amount) + 'ì›</span>' +
                        '<button onclick="deleteDividend(' + d.id + ')" class="w-7 h-7 flex items-center justify-center rounded-lg text-gray-400 hover:text-red-500 hover:bg-red-50 transition-colors">' +
                          '<i data-lucide="trash-2" class="w-3.5 h-3.5"></i>' +
                        '</button>' +
                      '</div>' +
                    '</div>';
                  }).join('') +
                '</div>' +
              '</div>';
            }).join('') +
          '</div>';
        }
      }

      // Journal list
      var journalListHtml = '';
      if (state.investmentJournals.length === 0) {
        journalListHtml = '<div class="text-center text-gray-400 py-4">íˆ¬ìì¼ì§€ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
      } else {
        var sortedJournals = state.investmentJournals.slice().sort(function(a, b) { return new Date(b.date) - new Date(a.date); });
        journalListHtml = sortedJournals.slice(0, 5).map(function(j) {
          return '<div class="border rounded-lg p-3 bg-yellow-50">' +
            '<div class="flex justify-between items-start mb-2">' +
              '<div class="text-sm text-gray-600">' + j.date + '</div>' +
              '<button onclick="deleteJournal(' + j.id + ')" class="text-red-400 text-xs">ì‚­ì œ</button>' +
            '</div>' +
            '<div class="text-gray-800 text-sm whitespace-pre-wrap">' + j.content + '</div>' +
          '</div>';
        }).join('');
      }

      return '<div class="p-4 space-y-6">' +
        '<div class="bg-gradient-to-r from-indigo-600 to-purple-700 text-white p-6 rounded-xl shadow-lg">' +
          '<div class="text-sm font-medium mb-1">ğŸ“Š ì´ íˆ¬ì í˜„í™©</div>' +
          '<div class="text-3xl font-bold mb-2">' + formatNumber(totalCurrentValue) + 'ì›</div>' +
          '<div class="grid grid-cols-3 gap-3 mt-4">' +
            '<div class="bg-white rounded-lg p-3 shadow">' +
              '<div class="text-xs text-gray-600 font-medium">íˆ¬ì ì›ê¸ˆ</div><div class="font-bold text-sm text-indigo-700">' + formatNumber(totalInvested) + 'ì›</div>' +
            '</div>' +
            '<div class="bg-white rounded-lg p-3 shadow">' +
              '<div class="text-xs text-gray-600 font-medium">í‰ê°€ ì†ìµ</div>' +
              '<div class="font-bold text-sm ' + (totalProfit >= 0 ? 'text-red-600' : 'text-blue-600') + '">' + (totalProfit >= 0 ? '+' : '') + formatNumber(totalProfit) + 'ì›</div>' +
            '</div>' +
            '<div class="bg-white rounded-lg p-3 shadow">' +
              '<div class="text-xs text-gray-600 font-medium">ì´ ë°°ë‹¹ê¸ˆ</div>' +
              '<div class="font-bold text-sm text-green-600">' + formatNumber(totalDividends) + 'ì›</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
        // ë‚´ í¬íŠ¸í´ë¦¬ì˜¤ ì„¹ì…˜ - ë©‹ì§„ UI
        '<div class="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 rounded-2xl shadow-lg overflow-hidden border border-indigo-100">' +
          // í¬íŠ¸í´ë¦¬ì˜¤ í—¤ë”
          '<div class="bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 p-4">' +
            '<div class="flex justify-between items-center">' +
              '<div class="flex items-center gap-3">' +
                '<div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center shadow-md">' +
                  '<span class="text-2xl">ğŸ“ˆ</span>' +
                '</div>' +
                '<div>' +
                  '<h3 class="font-bold text-white text-lg drop-shadow-sm">ë‚´ í¬íŠ¸í´ë¦¬ì˜¤</h3>' +
                  '<p class="text-indigo-100 text-xs">My Portfolio</p>' +
                '</div>' +
              '</div>' +
              '<button onclick="state.showAddInvestment=true;render()" class="bg-white text-indigo-600 px-4 py-2 rounded-xl text-sm font-semibold shadow-md hover:shadow-lg transition-all duration-200 flex items-center gap-2">' +
                '<i data-lucide="plus-circle" class="w-4 h-4"></i>' +
                '<span>ì¢…ëª© ì¶”ê°€</span>' +
              '</button>' +
            '</div>' +
          '</div>' +
          // ê²€ìƒ‰ ë° í•„í„° ì˜ì—­
          '<div class="p-4">' +
            '<div class="bg-white rounded-xl p-3 shadow-sm border border-indigo-100 mb-4">' +
              '<div class="relative">' +
                '<input type="text" id="investmentSearch" value="' + investmentSearchKeyword + '" ' +
                  'oncompositionstart="isComposingInvestment=true" ' +
                  'oncompositionend="isComposingInvestment=false;updateInvestmentSearch(this.value)" ' +
                  'oninput="if(!isComposingInvestment)updateInvestmentSearch(this.value)" ' +
                  'class="w-full py-2.5 pl-10 pr-4 bg-gray-50 border-2 border-transparent rounded-xl text-sm font-medium placeholder-gray-400 focus:border-indigo-400 focus:bg-white focus:ring-2 focus:ring-indigo-100 transition-all" placeholder="ğŸ” ì¢…ëª©ëª… ë˜ëŠ” ìœ í˜•ìœ¼ë¡œ ê²€ìƒ‰...">' +
                '<i data-lucide="search" class="w-4 h-4 absolute left-3.5 top-1/2 transform -translate-y-1/2 text-indigo-500"></i>' +
              '</div>' +
              '<div id="investment-count" class="text-xs text-gray-500 mt-2 flex items-center gap-1">' +
                (state.investments.length > 0 ? '<i data-lucide="briefcase" class="w-3 h-3"></i> ì´ ' + state.investments.length + 'ê°œ ì¢…ëª© ì¤‘ <span class="font-semibold text-indigo-600">' + filteredInvestments.length + 'ê°œ</span> í‘œì‹œ' : '') +
              '</div>' +
            '</div>' +
            '<div id="investment-list-container" class="space-y-3">' + investListHtml + '</div>' +
          '</div>' +
        '</div>' +
        // ë°°ë‹¹ ë‚´ì—­ ì„¹ì…˜ - ë©‹ì§„ UI
        '<div class="bg-gradient-to-br from-emerald-50 via-green-50 to-teal-50 rounded-2xl shadow-lg overflow-hidden border border-green-100">' +
          // í—¤ë” ì˜ì—­
          '<div class="bg-gradient-to-r from-emerald-500 via-green-500 to-teal-500 p-4">' +
            '<div class="flex justify-between items-center">' +
              '<div class="flex items-center gap-3">' +
                '<div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center shadow-md">' +
                  '<span class="text-2xl">ğŸ’°</span>' +
                '</div>' +
                '<div>' +
                  '<h3 class="font-bold text-white text-lg drop-shadow-sm">ë°°ë‹¹ ë‚´ì—­</h3>' +
                  '<p class="text-green-100 text-xs">Dividend History</p>' +
                '</div>' +
              '</div>' +
              '<div class="text-right">' +
                '<div class="bg-white px-4 py-2 rounded-xl shadow-md">' +
                  '<div class="text-green-600 text-xs font-medium">ì´ ë°°ë‹¹ê¸ˆ</div>' +
                  '<div class="font-bold text-green-700 text-lg">' + formatNumber(totalDividends) + 'ì›</div>' +
                '</div>' +
              '</div>' +
            '</div>' +
          '</div>' +
          // ì»¨íŠ¸ë¡¤ ì˜ì—­
          '<div class="p-4">' +
            '<div class="flex flex-wrap items-center justify-between gap-3 mb-4">' +
              // ê¸°ê°„ í•„í„° ë²„íŠ¼ë“¤
              '<div class="flex gap-1.5 overflow-x-auto pb-1">' +
                '<button onclick="setDividendPeriod(\'all\')" data-period="all" class="dividend-period-btn px-4 py-2 rounded-xl text-xs font-semibold whitespace-nowrap transition-all duration-200 ' + (dividendPeriod === 'all' ? 'bg-gradient-to-r from-emerald-500 to-green-500 text-white shadow-md' : 'bg-white text-gray-600 hover:bg-green-50 border border-gray-200') + '">ğŸ“‹ ì „ì²´</button>' +
                '<button onclick="setDividendPeriod(\'weekly\')" data-period="weekly" class="dividend-period-btn px-4 py-2 rounded-xl text-xs font-semibold whitespace-nowrap transition-all duration-200 ' + (dividendPeriod === 'weekly' ? 'bg-gradient-to-r from-emerald-500 to-green-500 text-white shadow-md' : 'bg-white text-gray-600 hover:bg-green-50 border border-gray-200') + '">ğŸ“… ì£¼ë³„</button>' +
                '<button onclick="setDividendPeriod(\'monthly\')" data-period="monthly" class="dividend-period-btn px-4 py-2 rounded-xl text-xs font-semibold whitespace-nowrap transition-all duration-200 ' + (dividendPeriod === 'monthly' ? 'bg-gradient-to-r from-emerald-500 to-green-500 text-white shadow-md' : 'bg-white text-gray-600 hover:bg-green-50 border border-gray-200') + '">ğŸ—“ï¸ ì›”ë³„</button>' +
                '<button onclick="setDividendPeriod(\'yearly\')" data-period="yearly" class="dividend-period-btn px-4 py-2 rounded-xl text-xs font-semibold whitespace-nowrap transition-all duration-200 ' + (dividendPeriod === 'yearly' ? 'bg-gradient-to-r from-emerald-500 to-green-500 text-white shadow-md' : 'bg-white text-gray-600 hover:bg-green-50 border border-gray-200') + '">ğŸ“Š ë…„ë„ë³„</button>' +
              '</div>' +
              // ë°°ë‹¹ ì¶”ê°€ ë²„íŠ¼
              '<button onclick="state.showAddDividend=true;render()" class="bg-gradient-to-r from-emerald-500 to-green-600 text-white px-4 py-2 rounded-xl text-sm font-semibold shadow-md hover:shadow-lg transition-all duration-200 flex items-center gap-2">' +
                '<i data-lucide="plus-circle" class="w-4 h-4"></i>' +
                '<span>ë°°ë‹¹ ì¶”ê°€</span>' +
              '</button>' +
            '</div>' +
            // ê²€ìƒ‰ ì˜ì—­
            '<div class="bg-white rounded-xl p-3 shadow-sm border border-green-100 mb-4">' +
              '<div class="relative">' +
                '<input type="text" id="dividendSearch" value="' + dividendSearchKeyword + '" ' +
                  'oncompositionstart="isComposingDividend=true" ' +
                  'oncompositionend="isComposingDividend=false;updateDividendSearch(this.value)" ' +
                  'oninput="if(!isComposingDividend)updateDividendSearch(this.value)" ' +
                  'class="w-full py-2.5 pl-10 pr-4 bg-gray-50 border-2 border-transparent rounded-xl text-sm font-medium placeholder-gray-400 focus:border-green-400 focus:bg-white focus:ring-2 focus:ring-green-100 transition-all" placeholder="ğŸ” ì¢…ëª©ëª…ìœ¼ë¡œ ê²€ìƒ‰...">' +
                '<i data-lucide="search" class="w-4 h-4 absolute left-3.5 top-1/2 transform -translate-y-1/2 text-green-500"></i>' +
              '</div>' +
              '<div id="dividend-count" class="text-xs text-gray-500 mt-2 flex items-center gap-1">' +
                (state.dividends.length > 0 ? '<i data-lucide="list" class="w-3 h-3"></i> ì´ ' + state.dividends.length + 'ê±´ ì¤‘ <span class="font-semibold text-green-600">' + filteredDividends.length + 'ê±´</span> í‘œì‹œ' : '') +
              '</div>' +
            '</div>' +
            // ë°°ë‹¹ ë¦¬ìŠ¤íŠ¸
            '<div id="dividend-list-container" class="max-h-96 overflow-y-auto rounded-xl">' + dividendListHtml + '</div>' +
          '</div>' +
        '</div>' +
        '<div class="bg-white rounded-xl shadow-lg p-4">' +
          '<div class="flex justify-between items-center mb-4">' +
            '<h3 class="font-bold">ğŸ“ íˆ¬ì ì¼ì§€</h3>' +
            '<button onclick="state.showAddJournal=true;render()" class="bg-yellow-500 text-white px-3 py-1 rounded-lg text-sm">+ ì¼ì§€ ì‘ì„±</button>' +
          '</div>' +
          '<div class="space-y-3">' + journalListHtml + '</div>' +
        '</div>' +
      '</div>';
    }

    function addInvestment() {
      var name = document.getElementById('invName') ? document.getElementById('invName').value : '';
      var type = document.getElementById('invType') ? document.getElementById('invType').value : 'stock';
      var quantity = getQuantityValue('invQuantity');
      var buyPrice = getAmountValue('invBuyPrice');
      var currentPrice = getAmountValue('invCurrentPrice') || buyPrice;

      if (!name || !quantity || !buyPrice) {
        alert('ì¢…ëª©ëª…, ìˆ˜ëŸ‰, ë§¤ì…ê°€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }

      state.investments.push({ id: Date.now(), name: name, type: type, quantity: quantity, buyPrice: buyPrice, currentPrice: currentPrice });
      state.showAddInvestment = false;
      saveData();
      render();
      showToast('íˆ¬ì ì¢…ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function editInvestmentPrice(id) {
      var inv = state.investments.find(function(i) { return i.id === id; });
      if (!inv) return;
      var newPrice = prompt('í˜„ì¬ê°€ë¥¼ ì…ë ¥í•˜ì„¸ìš”:', inv.currentPrice);
      if (newPrice === null) return;
      inv.currentPrice = Number(newPrice) || inv.currentPrice;
      saveData();
      render();
      showToast('í˜„ì¬ê°€ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function deleteInvestment(id) {
      if (confirm('ì´ íˆ¬ì ì¢…ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        state.investments = state.investments.filter(function(i) { return i.id !== id; });
        saveData();
        render();
        showToast('íˆ¬ì ì¢…ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    }

    // Dividend functions
    function addDividend() {
      var stockNameEl = document.getElementById('divStockName');
      var dateEl = document.getElementById('divDate');
      
      var stockName = stockNameEl ? stockNameEl.value.trim() : '';
      var amount = getAmountValue('divAmount');
      var date = dateEl ? dateEl.value : '';

      if (!stockName) {
        alert('ì¢…ëª©ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }
      if (!amount || amount <= 0) {
        alert('ë°°ë‹¹ê¸ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }
      if (!date) {
        alert('ë°°ë‹¹ì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
        return;
      }

      var dividendId = Date.now();
      
      // ë°°ë‹¹ ë‚´ì—­ ì¶”ê°€
      state.dividends.push({
        id: dividendId,
        stockName: stockName,
        amount: amount,
        date: date
      });
      
      // ê±°ë˜ë‚´ì—­ ìˆ˜ì…ì— ìë™ ì¶”ê°€ (ë°°ë‹¹ê¸ˆ ì¹´í…Œê³ ë¦¬)
      state.transactions.push({
        id: dividendId + 1,
        type: 'income',
        date: date,
        amount: amount,
        category: 'ë°°ë‹¹ê¸ˆ',
        memo: stockName + ' ë°°ë‹¹ê¸ˆ',
        paymentMethod: 'other',
        installment: 0,
        isNecessary: false,
        dividendId: dividendId  // ë°°ë‹¹ ë‚´ì—­ê³¼ ì—°ê²°
      });

      state.showAddDividend = false;
      saveData();
      render();
      showToast('ë°°ë‹¹ ë‚´ì—­ì´ ì¶”ê°€ë˜ê³  ê±°ë˜ë‚´ì—­ì— ìˆ˜ì…ìœ¼ë¡œ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function deleteDividend(id) {
      if (confirm('ë°°ë‹¹ ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì—°ê²°ëœ ê±°ë˜ë‚´ì—­ ìˆ˜ì…ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤)')) {
        // ë°°ë‹¹ ë‚´ì—­ ì‚­ì œ
        state.dividends = state.dividends.filter(function(d) { return d.id !== id; });
        // ì—°ê²°ëœ ê±°ë˜ë‚´ì—­ë„ ì‚­ì œ
        state.transactions = state.transactions.filter(function(t) { return t.dividendId !== id; });
        saveData();
        render();
        showToast('ë°°ë‹¹ ë‚´ì—­ê³¼ ê±°ë˜ë‚´ì—­ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    }

    // Investment Journal functions
    function addJournal() {
      var content = document.getElementById('journalContent') ? document.getElementById('journalContent').value : '';
      var date = document.getElementById('journalDate') ? document.getElementById('journalDate').value : '';

      if (!content || !date) {
        alert('ë‚ ì§œì™€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }

      state.investmentJournals.push({
        id: Date.now(),
        date: date,
        content: content
      });

      state.showAddJournal = false;
      saveData();
      render();
      showToast('íˆ¬ìì¼ì§€ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function deleteJournal(id) {
      if (confirm('íˆ¬ìì¼ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        state.investmentJournals = state.investmentJournals.filter(function(j) { return j.id !== id; });
        saveData();
        render();
        showToast('íˆ¬ìì¼ì§€ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    }

    // Loan management functions
    function addLoan() {
      var nameEl = document.getElementById('loanName');
      var amountEl = document.getElementById('loanAmount');
      var loanDateEl = document.getElementById('loanDate');
      var repayDateEl = document.getElementById('loanRepayDate');
      var rateEl = document.getElementById('loanRate');
      var rateTypeEl = document.getElementById('loanRateType');
      var monthlyEl = document.getElementById('loanMonthlyPayment');
      var payDayEl = document.getElementById('loanPayDay');
      var lenderTypeEl = document.getElementById('loanLenderType');

      var name = nameEl ? nameEl.value.trim() : '';
      var amount = Number(amountEl ? amountEl.value : 0);
      var loanDate = loanDateEl ? loanDateEl.value : '';
      var repayDate = repayDateEl ? repayDateEl.value : '';
      var rate = Number(rateEl ? rateEl.value : 0);
      var rateType = rateTypeEl ? rateTypeEl.value : 'fixed';
      var monthly = Number(monthlyEl ? monthlyEl.value : 0);
      var payDay = Number(payDayEl ? payDayEl.value : 1);
      var lenderType = lenderTypeEl ? lenderTypeEl.value : 'bank';

      if (!name) { alert('ëŒ€ì¶œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
      if (!amount || amount <= 0) { alert('ëŒ€ì¶œê¸ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
      if (!loanDate) { alert('ëŒ€ì¶œë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”'); return; }

      state.loans.push({
        id: Date.now(),
        name: name,
        amount: amount,
        loanDate: loanDate,
        repayDate: repayDate,
        rate: rate,
        rateType: rateType,
        monthlyPayment: monthly,
        payDay: payDay,
        lenderType: lenderType
      });

      saveData();
      render();
      showToast('ëŒ€ì¶œì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function deleteLoan(id) {
      if (confirm('ëŒ€ì¶œ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        state.loans = state.loans.filter(function(l) { return l.id !== id; });
        saveData();
        render();
        showToast('ëŒ€ì¶œì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    }

    function editLoan(id) {
      var loan = state.loans.find(function(l) { return l.id === id; });
      if (!loan) return;

      var newAmountStr = prompt('ëŒ€ì¶œ ì”ì•¡:', loan.amount.toLocaleString());
      if (newAmountStr === null) return;
      
      var newMonthlyStr = prompt('ì›” ìƒí™˜ê¸ˆ:', loan.monthlyPayment.toLocaleString());
      if (newMonthlyStr === null) return;

      var newAmount = parseInt(newAmountStr.replace(/[^\d]/g, ''), 10);
      var newMonthly = parseInt(newMonthlyStr.replace(/[^\d]/g, ''), 10);

      loan.amount = isNaN(newAmount) ? loan.amount : newAmount;
      loan.monthlyPayment = isNaN(newMonthly) ? loan.monthlyPayment : newMonthly;

      saveData();
      render();
      showToast('ëŒ€ì¶œ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function calculateLoanInterest(amount, rate, months) {
      if (months <= 0) return 0;
      return amount * (rate / 100) * (months / 12);
    }

    // Manual trigger for auto loan repayments
    function triggerAutoLoanRepayments() {
      var addedCount = 0;
      var today = new Date();
      var currentYear = today.getFullYear();
      var currentMonth = today.getMonth();
      
      state.loans.forEach(function(loan) {
        if (!loan.monthlyPayment || loan.monthlyPayment <= 0) return;
        if (!loan.payDay) return;
        
        if (loan.repayDate) {
          var repayEnd = new Date(loan.repayDate);
          if (today > repayEnd) return;
        }
        
        if (loan.loanDate) {
          var loanStart = new Date(loan.loanDate);
          if (today < loanStart) return;
        }
        
        var repaymentDate = new Date(currentYear, currentMonth, loan.payDay);
        var dateString = repaymentDate.toISOString().split('T')[0];
        
        var existingTransaction = state.transactions.find(function(t) {
          return t.type === 'expense' && 
                 t.category === 'ëŒ€ì¶œìƒí™˜' && 
                 t.date === dateString && 
                 t.memo && t.memo.indexOf(loan.name) >= 0;
        });
        
        if (!existingTransaction) {
          var newTransaction = {
            id: Date.now() + Math.random(),
            type: 'expense',
            date: dateString,
            amount: loan.monthlyPayment,
            category: 'ëŒ€ì¶œìƒí™˜',
            memo: loan.name + ' ì›”ìƒí™˜ê¸ˆ (ìë™)',
            paymentMethod: 'cash',
            installment: 0,
            isNecessary: true
          };
          state.transactions.push(newTransaction);
          addedCount++;
        }
      });
      
      if (addedCount > 0) {
        saveData();
        showToast(addedCount + 'ê±´ì˜ ëŒ€ì¶œìƒí™˜ì´ ìë™ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
        render();
      } else {
        showToast('ì´ë²ˆ ë‹¬ ë“±ë¡í•  ëŒ€ì¶œìƒí™˜ì´ ì—†ìŠµë‹ˆë‹¤');
      }
    }

    function renderLoanSection() {
      var totalLoan = state.loans.reduce(function(s, l) { return s + l.amount; }, 0);
      var totalMonthlyPayment = state.loans.reduce(function(s, l) { return s + l.monthlyPayment; }, 0);
      
      var lenderTypeLabels = { bank: 'ğŸ¦ ì€í–‰', card: 'ğŸ’³ ì¹´ë“œ', insurance: 'ğŸ›¡ï¸ ë³´í—˜', other: 'ğŸ“„ ê¸°íƒ€' };
      var lenderTypeColors = { bank: 'bg-blue-100 text-blue-700', card: 'bg-purple-100 text-purple-700', insurance: 'bg-green-100 text-green-700', other: 'bg-gray-100 text-gray-700' };
      
      var loanListHtml = '';
      if (state.loans.length === 0) {
        loanListHtml = '<div class="text-center text-gray-400 py-4">ë“±ë¡ëœ ëŒ€ì¶œì´ ì—†ìŠµë‹ˆë‹¤</div>';
      } else {
        loanListHtml = state.loans.map(function(loan) {
          var lenderLabel = lenderTypeLabels[loan.lenderType] || 'ğŸ“„ ê¸°íƒ€';
          var lenderColor = lenderTypeColors[loan.lenderType] || 'bg-gray-100 text-gray-700';
          var rateTypeLabel = loan.rateType === 'fixed' ? 'ê³ ì •' : 'ë³€ë™';
          var rateTypeColor = loan.rateType === 'fixed' ? 'bg-blue-50 text-blue-600' : 'bg-orange-50 text-orange-600';
          
          // Calculate remaining months
          var remainingMonths = 0;
          var progress = 0;
          if (loan.repayDate && loan.loanDate) {
            var loanStart = new Date(loan.loanDate);
            var repayEnd = new Date(loan.repayDate);
            var now = new Date();
            var totalMonths = Math.ceil((repayEnd - loanStart) / (1000 * 60 * 60 * 24 * 30));
            var elapsedMonths = Math.ceil((now - loanStart) / (1000 * 60 * 60 * 24 * 30));
            remainingMonths = Math.max(0, totalMonths - elapsedMonths);
            progress = totalMonths > 0 ? Math.min((elapsedMonths / totalMonths) * 100, 100) : 0;
          }
          
          return '<div class="border rounded-xl p-4 bg-gradient-to-r from-red-50 to-orange-50 mb-3">' +
            '<div class="flex justify-between items-start mb-3">' +
              '<div class="flex-1">' +
                '<div class="flex items-center gap-2 mb-1">' +
                  '<span class="font-bold text-gray-800">' + loan.name + '</span>' +
                  '<span class="text-xs px-2 py-0.5 rounded ' + lenderColor + '">' + lenderLabel + '</span>' +
                '</div>' +
                '<div class="text-xs text-gray-500">ëŒ€ì¶œì¼: ' + loan.loanDate + (loan.repayDate ? ' ~ ' + loan.repayDate : '') + '</div>' +
              '</div>' +
              '<div class="flex gap-1">' +
                '<button onclick="editLoan(' + loan.id + ')" class="text-blue-500 text-xs px-2 py-1 hover:bg-blue-50 rounded">ìˆ˜ì •</button>' +
                '<button onclick="deleteLoan(' + loan.id + ')" class="text-red-500 text-xs px-2 py-1 hover:bg-red-50 rounded">ì‚­ì œ</button>' +
              '</div>' +
            '</div>' +
            '<div class="grid grid-cols-2 gap-2 mb-3">' +
              '<div class="bg-white p-2 rounded-lg">' +
                '<div class="text-xs text-gray-500">ëŒ€ì¶œ ì”ì•¡</div>' +
                '<div class="font-bold text-red-600">' + formatNumber(loan.amount) + 'ì›</div>' +
              '</div>' +
              '<div class="bg-white p-2 rounded-lg">' +
                '<div class="text-xs text-gray-500">ì›” ìƒí™˜ê¸ˆ</div>' +
                '<div class="font-bold text-orange-600">' + formatNumber(loan.monthlyPayment) + 'ì›</div>' +
              '</div>' +
            '</div>' +
            '<div class="grid grid-cols-3 gap-2 mb-3">' +
              '<div class="bg-white p-2 rounded-lg text-center">' +
                '<div class="text-xs text-gray-500">ì—°ì´ìœ¨</div>' +
                '<div class="font-bold text-sm text-purple-600">' + loan.rate + '%</div>' +
                '<span class="text-xs px-1 rounded ' + rateTypeColor + '">' + rateTypeLabel + '</span>' +
              '</div>' +
              '<div class="bg-white p-2 rounded-lg text-center">' +
                '<div class="text-xs text-gray-500">ìƒí™˜ì¼</div>' +
                '<div class="font-bold text-sm text-gray-700">ë§¤ì›” ' + loan.payDay + 'ì¼</div>' +
              '</div>' +
              '<div class="bg-white p-2 rounded-lg text-center">' +
                '<div class="text-xs text-gray-500">ë‚¨ì€ ê¸°ê°„</div>' +
                '<div class="font-bold text-sm text-blue-600">' + remainingMonths + 'ê°œì›”</div>' +
              '</div>' +
            '</div>' +
            (loan.repayDate ? '<div class="mb-2">' +
              '<div class="flex justify-between text-xs text-gray-600 mb-1">' +
                '<span>ìƒí™˜ ì§„í–‰ë¥ </span>' +
                '<span>' + progress.toFixed(1) + '%</span>' +
              '</div>' +
              '<div class="w-full bg-gray-200 rounded-full h-3">' +
                '<div class="bg-gradient-to-r from-green-400 to-green-500 h-3 rounded-full transition-all" style="width: ' + progress + '%"></div>' +
              '</div>' +
            '</div>' : '') +
          '</div>';
        }).join('');
      }
      
      // Check this month's repayment status
      var today = new Date();
      var currentYear = today.getFullYear();
      var currentMonth = today.getMonth();
      
      var repaymentStatus = state.loans.map(function(loan) {
        if (!loan.monthlyPayment || loan.monthlyPayment <= 0) return null;
        
        var repaymentDate = new Date(currentYear, currentMonth, loan.payDay || 1);
        var dateString = repaymentDate.toISOString().split('T')[0];
        
        var existingTransaction = state.transactions.find(function(t) {
          return t.type === 'expense' && 
                 t.category === 'ëŒ€ì¶œìƒí™˜' && 
                 t.date === dateString && 
                 t.memo && t.memo.indexOf(loan.name) >= 0;
        });
        
        return {
          loanId: loan.id,
          loanName: loan.name,
          isPaid: !!existingTransaction,
          payDay: loan.payDay,
          amount: loan.monthlyPayment
        };
      }).filter(function(s) { return s !== null; });
      
      var paidCount = repaymentStatus.filter(function(s) { return s.isPaid; }).length;
      var totalCount = repaymentStatus.length;

      return '<div class="bg-white rounded-xl shadow-lg p-4">' +
        '<div class="flex justify-between items-center mb-4">' +
          '<h3 class="font-bold flex items-center gap-2">ğŸ’³ ì€í–‰/ì¹´ë“œ/ë³´í—˜ë³„ ëŒ€ì¶œì”ê³ </h3>' +
          '<button onclick="triggerAutoLoanRepayments()" class="bg-blue-500 text-white px-3 py-1 rounded-lg text-xs font-medium hover:bg-blue-600 transition flex items-center gap-1">' +
            '<i data-lucide="refresh-cw" class="w-3 h-3"></i> ìë™ìƒí™˜ ì²´í¬' +
          '</button>' +
        '</div>' +
        '<div class="grid grid-cols-2 gap-3 mb-3">' +
          '<div class="bg-gradient-to-r from-red-100 to-red-200 p-4 rounded-xl">' +
            '<div class="text-sm text-red-600 font-medium">ì´ ëŒ€ì¶œ ì”ì•¡</div>' +
            '<div class="text-2xl font-bold text-red-700">' + formatNumber(totalLoan) + 'ì›</div>' +
          '</div>' +
          '<div class="bg-gradient-to-r from-orange-100 to-orange-200 p-4 rounded-xl">' +
            '<div class="text-sm text-orange-600 font-medium">ì›” ì´ ìƒí™˜ê¸ˆ</div>' +
            '<div class="text-2xl font-bold text-orange-700">' + formatNumber(totalMonthlyPayment) + 'ì›</div>' +
          '</div>' +
        '</div>' +
        (totalCount > 0 ? '<div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">' +
          '<div class="flex justify-between items-center">' +
            '<span class="text-sm font-medium text-blue-700">ğŸ“… ì´ë²ˆ ë‹¬ ìƒí™˜ í˜„í™©</span>' +
            '<span class="text-sm font-bold ' + (paidCount === totalCount ? 'text-green-600' : 'text-orange-600') + '">' + 
              paidCount + '/' + totalCount + 'ê±´ ì™„ë£Œ' +
            '</span>' +
          '</div>' +
          '<div class="mt-2 space-y-1">' +
            repaymentStatus.map(function(s) {
              return '<div class="flex justify-between items-center text-xs">' +
                '<span class="text-gray-600">' + s.loanName + ' (ë§¤ì›” ' + s.payDay + 'ì¼)</span>' +
                '<span class="' + (s.isPaid ? 'text-green-600 font-bold' : 'text-red-600') + '">' +
                  (s.isPaid ? 'âœ… ìƒí™˜ì™„ë£Œ' : 'â³ ëŒ€ê¸°ì¤‘ (' + formatNumber(s.amount) + 'ì›)') +
                '</span>' +
              '</div>';
            }).join('') +
          '</div>' +
        '</div>' : '') +
        '<div class="mb-4">' + loanListHtml + '</div>' +
        '<div class="border-t pt-4">' +
          '<h4 class="font-bold text-sm mb-3 text-gray-700">â• ìƒˆ ëŒ€ì¶œ ì¶”ê°€</h4>' +
          '<div class="space-y-2">' +
            '<div class="grid grid-cols-2 gap-2">' +
              '<div>' +
                '<label class="block text-xs text-gray-600 mb-1">ëŒ€ì¶œì²˜ ìœ í˜•</label>' +
                '<select id="loanLenderType" class="w-full p-2 border rounded-lg text-sm">' +
                  '<option value="bank">ğŸ¦ ì€í–‰</option>' +
                  '<option value="card">ğŸ’³ ì¹´ë“œ</option>' +
                  '<option value="insurance">ğŸ›¡ï¸ ë³´í—˜</option>' +
                  '<option value="other">ğŸ“„ ê¸°íƒ€</option>' +
                '</select>' +
              '</div>' +
              '<div>' +
                '<label class="block text-xs text-gray-600 mb-1">ëŒ€ì¶œëª…</label>' +
                '<input type="text" id="loanName" class="w-full p-2 border rounded-lg text-sm" placeholder="ì˜ˆ: ì£¼íƒë‹´ë³´ëŒ€ì¶œ">' +
              '</div>' +
            '</div>' +
            '<div class="grid grid-cols-2 gap-2">' +
              '<div>' +
                '<label class="block text-xs text-gray-600 mb-1">ëŒ€ì¶œê¸ˆ</label>' +
                '<input type="number" id="loanAmount" class="w-full p-2 border rounded-lg text-sm" placeholder="0">' +
              '</div>' +
              '<div>' +
                '<label class="block text-xs text-gray-600 mb-1">ì›” ìƒí™˜ê¸ˆ</label>' +
                '<input type="number" id="loanMonthlyPayment" class="w-full p-2 border rounded-lg text-sm" placeholder="0">' +
              '</div>' +
            '</div>' +
            '<div class="grid grid-cols-2 gap-2">' +
              '<div>' +
                '<label class="block text-xs text-gray-600 mb-1">ëŒ€ì¶œë‚ ì§œ</label>' +
                '<input type="date" id="loanDate" class="w-full p-2 border rounded-lg text-sm">' +
              '</div>' +
              '<div>' +
                '<label class="block text-xs text-gray-600 mb-1">ìƒí™˜ì™„ë£Œ ì˜ˆì •ì¼</label>' +
                '<input type="date" id="loanRepayDate" class="w-full p-2 border rounded-lg text-sm">' +
              '</div>' +
            '</div>' +
            '<div class="grid grid-cols-3 gap-2">' +
              '<div>' +
                '<label class="block text-xs text-gray-600 mb-1">ì—°ì´ìœ¨ (%)</label>' +
                '<input type="number" id="loanRate" step="0.01" class="w-full p-2 border rounded-lg text-sm" placeholder="0">' +
              '</div>' +
              '<div>' +
                '<label class="block text-xs text-gray-600 mb-1">ê¸ˆë¦¬ìœ í˜•</label>' +
                '<select id="loanRateType" class="w-full p-2 border rounded-lg text-sm">' +
                  '<option value="fixed">ê³ ì •ê¸ˆë¦¬</option>' +
                  '<option value="variable">ë³€ë™ê¸ˆë¦¬</option>' +
                '</select>' +
              '</div>' +
              '<div>' +
                '<label class="block text-xs text-gray-600 mb-1">ìƒí™˜ì¼</label>' +
                '<select id="loanPayDay" class="w-full p-2 border rounded-lg text-sm">' +
                  Array.from({length: 28}, function(_, i) { return '<option value="' + (i + 1) + '">' + (i + 1) + 'ì¼</option>'; }).join('') +
                '</select>' +
              '</div>' +
            '</div>' +
            '<button onclick="addLoan()" class="w-full bg-gradient-to-r from-red-500 to-orange-500 text-white py-2 rounded-lg font-medium mt-2">ëŒ€ì¶œ ì¶”ê°€</button>' +
          '</div>' +
        '</div>' +
      '</div>';
    }

    // Exchange Screen
    function renderExchangeScreen() {
      var phases = state.exchangeTab === 'USD' ? state.usdPhases : state.jpyPhases;
      var currentRate = state.exchangeTab === 'USD' ? state.usdRate : state.jpyRate;
      var sym = state.exchangeTab === 'USD' ? '$' : 'Â¥';

      // Calculate totals
      var totalUsd = state.usdPhases.filter(function(p) { return p.completed && !p.sold; }).reduce(function(s, p) { return s + (p.amount / p.buyRate); }, 0);
      var totalJpy = state.jpyPhases.filter(function(p) { return p.completed && !p.sold; }).reduce(function(s, p) { return s + (p.amount / p.buyRate); }, 0);
      var invested = phases.filter(function(p) { return p.completed && !p.sold; }).reduce(function(s, p) { return s + p.amount; }, 0);
      var foreign = phases.filter(function(p) { return p.completed && !p.sold; }).reduce(function(s, p) { return s + (p.amount / p.buyRate); }, 0);
      var avgRate = foreign > 0 ? (invested / foreign).toFixed(2) : 0;
      var unrealized = phases.filter(function(p) { return p.completed && !p.sold; }).reduce(function(s, p) { return s + ((p.amount / p.buyRate) * currentRate - p.amount); }, 0);
      var profit = phases.filter(function(p) { return p.sold; }).reduce(function(s, p) { return s + ((p.amount / p.buyRate) * p.sellRate - p.amount); }, 0);
      var cumInvested = state.usdPhases.concat(state.jpyPhases).reduce(function(s, p) { return s + p.amount; }, 0);
      var initialBudget = state.exchangeTab === 'USD' ? state.usdInitialBudget : state.jpyInitialBudget;
      var currentBudget = initialBudget + profit;
      var pendingAmount = phases.filter(function(p) { return !p.completed && !p.sold; }).reduce(function(s, p) { return s + p.amount; }, 0);
      var totalNeeded = invested + pendingAmount;
      var canAddMore = totalNeeded < currentBudget;

      // Calculate grade
      var allSold = state.usdPhases.concat(state.jpyPhases).filter(function(p) { return p.sold; });
      var totalSoldInv = allSold.reduce(function(s, p) { return s + p.amount; }, 0);
      var totalSoldProf = allSold.reduce(function(s, p) { return s + ((p.amount / p.buyRate) * p.sellRate - p.amount); }, 0);
      var gradeInfo = getInvestGrade(totalSoldProf, totalSoldInv);

      var active = phases.filter(function(p) { return !p.sold; });
      var sold = phases.filter(function(p) { return p.sold; });

      var activeHtml = active.map(function(p, i) {
        var f = p.amount / p.buyRate;
        var cp = (f * currentRate) - p.amount;
        var isExpanded = state.expandedPhase === p.id;
        
        return '<div class="bg-white rounded-xl shadow-md">' +
          '<div onclick="toggleExpandPhase(' + p.id + ')" class="p-4 cursor-pointer ' + (p.completed ? 'bg-green-50' : 'bg-blue-50') + ' rounded-t-xl">' +
            '<div class="flex justify-between items-start">' +
              '<div class="flex-1">' +
                '<p class="font-bold text-gray-800">' + (i + 1) + 'ì°¨ ë§¤ìˆ˜</p>' +
                '<p class="text-xs text-gray-600 mt-0.5">' + (p.completed ? 'ë§¤ìˆ˜ì¼: ' + p.date : 'ë§¤ìˆ˜ëŒ€ê¸°') + '</p>' +
                (p.completed ? '<p class="text-xs font-bold mt-2 ' + (cp >= 0 ? 'text-red-600' : 'text-blue-600') + '">í˜„ì¬: ' + (cp >= 0 ? '+' : '') + (cp / 10000).toFixed(1) + 'ë§Œì›</p>' : '') +
              '</div>' +
              '<i data-lucide="' + (isExpanded ? 'chevron-up' : 'chevron-down') + '" class="w-5 h-5"></i>' +
            '</div>' +
          '</div>' +
          (isExpanded ? '<div class="p-4 space-y-3">' +
            '<div><label class="text-xs text-gray-600 block mb-1">íˆ¬ìê¸ˆì•¡</label><input type="number" id="phase-amount-' + p.id + '" value="' + p.amount + '" class="w-full px-3 py-2 border rounded" ' + (p.completed ? 'disabled' : '') + '></div>' +
            '<div><label class="text-xs text-gray-600 block mb-1">ë§¤ìˆ˜í™˜ìœ¨</label><input type="number" id="phase-buyRate-' + p.id + '" value="' + p.buyRate + '" class="w-full px-3 py-2 border rounded" ' + (p.completed ? 'disabled' : '') + ' step="0.01"></div>' +
            '<div><label class="text-xs text-gray-600 block mb-1">ëª©í‘œ ë§¤ë„í™˜ìœ¨</label><input type="number" id="phase-sellRate-' + p.id + '" value="' + p.sellRate + '" class="w-full px-3 py-2 border rounded" step="0.01"></div>' +
            '<div class="bg-gray-50 rounded p-3 text-sm"><p>ğŸ’µ ' + sym + (state.exchangeTab === 'USD' ? f.toFixed(2) : f.toFixed(0)) + '</p><p>ğŸ“ˆ ì§€ê¸ˆ ë§¤ë„ì‹œ: ' + (cp >= 0 ? '+' : '') + cp.toLocaleString() + 'ì›</p></div>' +
            '<div class="flex gap-2">' +
              (!p.completed ? '<button onclick="completeExchangePhase(' + p.id + ')" class="flex-1 bg-green-500 text-white py-2 rounded font-bold">ë§¤ìˆ˜ì™„ë£Œ</button>' : '') +
              (p.completed ? '<button onclick="sellExchangePhase(' + p.id + ')" class="flex-1 bg-purple-500 text-white py-2 rounded font-bold">ë§¤ë„</button>' : '') +
              '<button onclick="saveExchangePhase(' + p.id + ')" class="px-4 bg-blue-500 text-white rounded">ì €ì¥</button>' +
              '<button onclick="deleteExchangePhase(' + p.id + ')" class="px-4 bg-red-500 text-white rounded">ì‚­ì œ</button>' +
            '</div>' +
          '</div>' : '') +
        '</div>';
      }).join('');

      var soldHtml = '';
      if (sold.length > 0) {
        var visibleSold = sold.slice(0, state.soldItemsVisible);
        soldHtml = '<div class="mt-4">' +
          '<h3 class="font-bold text-gray-700 mb-3 text-sm">âœ… ë§¤ë„ ì™„ë£Œ (' + sold.length + 'ê±´)</h3>' +
          visibleSold.map(function(p) {
            var f = p.amount / p.buyRate;
            var pr = (f * p.sellRate) - p.amount;
            var isExpanded = state.expandedPhase === p.id;
            
            return '<div class="bg-white rounded-xl shadow-md mb-3 opacity-70">' +
              '<div onclick="toggleExpandPhase(' + p.id + ')" class="bg-gray-100 p-4 cursor-pointer rounded-t-xl">' +
                '<div class="flex justify-between items-start">' +
                  '<div class="flex-1">' +
                    '<p class="font-bold text-gray-800">ë§¤ë„ì™„ë£Œ ' + p.id + 'ì°¨</p>' +
                    '<p class="text-xs text-gray-600">ë§¤ë„ì¼: ' + p.sellDate + '</p>' +
                    '<p class="text-sm font-bold mt-1 ' + (pr >= 0 ? 'text-red-600' : 'text-blue-600') + '">' +
                      'ì‹¤í˜„: ' + (pr >= 0 ? '+' : '') + (pr / 10000).toFixed(1) + 'ë§Œì› (' + ((pr / p.amount) * 100).toFixed(2) + '%)' +
                    '</p>' +
                  '</div>' +
                  '<i data-lucide="' + (isExpanded ? 'chevron-up' : 'chevron-down') + '" class="w-5 h-5"></i>' +
                '</div>' +
              '</div>' +
              (isExpanded ? '<div class="p-4 bg-gray-50 space-y-3 rounded-b-xl">' +
                '<input type="number" id="phase-amount-' + p.id + '" value="' + p.amount + '" class="w-full px-3 py-2 border rounded" placeholder="ë§¤ìˆ˜ê¸ˆì•¡">' +
                '<input type="number" id="phase-buyRate-' + p.id + '" value="' + p.buyRate + '" class="w-full px-3 py-2 border rounded" step="0.01" placeholder="ë§¤ìˆ˜í™˜ìœ¨">' +
                '<input type="number" id="phase-sellRate-' + p.id + '" value="' + p.sellRate + '" class="w-full px-3 py-2 border rounded" step="0.01" placeholder="ë§¤ë„í™˜ìœ¨">' +
                '<input type="date" id="phase-date-' + p.id + '" value="' + p.date + '" class="w-full px-3 py-2 border rounded" placeholder="ë§¤ìˆ˜ì¼">' +
                '<input type="date" id="phase-sellDate-' + p.id + '" value="' + p.sellDate + '" class="w-full px-3 py-2 border rounded" placeholder="ë§¤ë„ì¼">' +
                '<button onclick="deleteExchangePhase(' + p.id + ')" class="w-full bg-red-500 text-white py-2 rounded flex items-center justify-center gap-2">' +
                  '<i data-lucide="trash-2" class="w-4 h-4"></i> ì‚­ì œ' +
                '</button>' +
              '</div>' : '') +
            '</div>';
          }).join('') +
          (sold.length > state.soldItemsVisible ? 
            '<button onclick="state.soldItemsVisible+=10;render()" class="w-full bg-gray-200 text-gray-700 py-2 rounded-lg font-medium">ë”ë³´ê¸° (' + (sold.length - state.soldItemsVisible) + 'ê±´)</button>' : '') +
        '</div>';
      }

      // Stats section
      var statsHtml = '';
      if (state.showExchangeStats) {
        var soldForStats = phases.filter(function(p) { return p.sold && p.sellDate; });
        if (state.exchangeStatsStartDate || state.exchangeStatsEndDate) {
          soldForStats = soldForStats.filter(function(p) {
            var sellDate = new Date(p.sellDate);
            var start = state.exchangeStatsStartDate ? new Date(state.exchangeStatsStartDate) : new Date('1900-01-01');
            var end = state.exchangeStatsEndDate ? new Date(state.exchangeStatsEndDate) : new Date('2100-12-31');
            return sellDate >= start && sellDate <= end;
          });
        }

        var grouped = {};
        soldForStats.forEach(function(p) {
          var d = new Date(p.sellDate);
          var key;
          if (state.exchangeStatsPeriod === 'daily') key = p.sellDate;
          else if (state.exchangeStatsPeriod === 'weekly') key = d.getFullYear() + '-W' + Math.ceil(((d - new Date(d.getFullYear(), 0, 1)) / 86400000 + new Date(d.getFullYear(), 0, 1).getDay() + 1) / 7);
          else if (state.exchangeStatsPeriod === 'monthly') key = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
          else key = String(d.getFullYear());
          
          if (!grouped[key]) grouped[key] = { period: key, count: 0, inv: 0, prof: 0 };
          var f = p.amount / p.buyRate;
          grouped[key].count += 1;
          grouped[key].inv += p.amount;
          grouped[key].prof += f * p.sellRate - p.amount;
        });

        var statsData = Object.values(grouped).sort(function(a, b) { return a.period.localeCompare(b.period); });
        var cumInv = 0, cumProf = 0;
        statsData = statsData.map(function(item) {
          cumInv += item.inv;
          cumProf += item.prof;
          return {
            period: item.period,
            count: item.count,
            inv: item.inv,
            prof: item.prof,
            rate: ((item.prof / item.inv) * 100).toFixed(2),
            cumInv: cumInv,
            cumProf: cumProf,
            cumRate: ((cumProf / cumInv) * 100).toFixed(2)
          };
        }).reverse();

        var statsItemsHtml = '';
        if (statsData.length === 0) {
          statsItemsHtml = '<div class="text-center py-8"><p class="text-sm text-gray-500">ì„ íƒí•œ ê¸°ê°„ì— ë§¤ë„ ì™„ë£Œëœ ê±°ë˜ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';
        } else {
          statsItemsHtml = statsData.map(function(s) {
            return '<div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-3 border">' +
              '<div class="flex justify-between items-start mb-2">' +
                '<div><p class="font-bold text-sm">' + s.period + '</p><p class="text-xs text-gray-600">ë§¤ë„ ' + s.count + 'ê±´</p></div>' +
                '<div class="px-2 py-1 rounded-lg ' + (parseFloat(s.rate) >= 0 ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700') + '">' +
                  '<p class="text-xs font-bold">' + (parseFloat(s.rate) >= 0 ? '+' : '') + s.rate + '%</p>' +
                '</div>' +
              '</div>' +
              '<div class="grid grid-cols-2 gap-2 mb-2">' +
                '<div class="bg-white rounded p-2"><p class="text-xs text-gray-600">íˆ¬ìê¸ˆ</p><p class="font-bold text-sm text-blue-600">' + (s.inv / 10000).toFixed(0) + 'ë§Œ</p></div>' +
                '<div class="bg-white rounded p-2"><p class="text-xs text-gray-600">ì‹¤í˜„ìˆ˜ìµ</p><p class="font-bold text-sm ' + (s.prof >= 0 ? 'text-red-600' : 'text-blue-600') + '">' + (s.prof >= 0 ? '+' : '') + (s.prof / 10000).toFixed(1) + 'ë§Œ</p></div>' +
              '</div>' +
              '<div class="border-t pt-2">' +
                '<p class="text-xs font-semibold text-gray-700 mb-1">ëˆ„ì  í˜„í™©</p>' +
                '<div class="grid grid-cols-3 gap-2">' +
                  '<div class="bg-indigo-50 rounded p-1.5"><p class="text-xs text-gray-600">ëˆ„ì íˆ¬ì</p><p class="font-bold text-xs text-indigo-600">' + (s.cumInv / 10000).toFixed(0) + 'ë§Œ</p></div>' +
                  '<div class="bg-pink-50 rounded p-1.5"><p class="text-xs text-gray-600">ëˆ„ì ìˆ˜ìµ</p><p class="font-bold text-xs ' + (s.cumProf >= 0 ? 'text-pink-600' : 'text-blue-600') + '">' + (s.cumProf >= 0 ? '+' : '') + (s.cumProf / 10000).toFixed(1) + 'ë§Œ</p></div>' +
                  '<div class="bg-amber-50 rounded p-1.5"><p class="text-xs text-gray-600">ëˆ„ì ë¥ </p><p class="font-bold text-xs ' + (s.cumProf >= 0 ? 'text-amber-600' : 'text-blue-600') + '">' + (parseFloat(s.cumRate) >= 0 ? '+' : '') + s.cumRate + '%</p></div>' +
                '</div>' +
              '</div>' +
            '</div>';
          }).join('');
        }

        statsHtml = '<div class="bg-white rounded-xl shadow-lg p-4 mb-3">' +
          '<div class="mb-4">' +
            '<div class="flex justify-between items-center mb-3">' +
              '<h3 class="font-bold text-gray-800 text-sm">ğŸ“Š ê¸°ê°„ë³„ íˆ¬ì í†µê³„</h3>' +
              '<div class="flex gap-1">' +
                '<button onclick="setExchangeStatsPeriod(\'daily\')" class="px-2 py-1 rounded text-xs ' + (state.exchangeStatsPeriod === 'daily' ? 'bg-emerald-500 text-white' : 'bg-gray-200 text-gray-700') + '">ì¼</button>' +
                '<button onclick="setExchangeStatsPeriod(\'weekly\')" class="px-2 py-1 rounded text-xs ' + (state.exchangeStatsPeriod === 'weekly' ? 'bg-emerald-500 text-white' : 'bg-gray-200 text-gray-700') + '">ì£¼</button>' +
                '<button onclick="setExchangeStatsPeriod(\'monthly\')" class="px-2 py-1 rounded text-xs ' + (state.exchangeStatsPeriod === 'monthly' ? 'bg-emerald-500 text-white' : 'bg-gray-200 text-gray-700') + '">ì›”</button>' +
                '<button onclick="setExchangeStatsPeriod(\'yearly\')" class="px-2 py-1 rounded text-xs ' + (state.exchangeStatsPeriod === 'yearly' ? 'bg-emerald-500 text-white' : 'bg-gray-200 text-gray-700') + '">ë…„</button>' +
              '</div>' +
            '</div>' +
            '<div class="mb-3 p-3 bg-gray-50 rounded-lg">' +
              '<p class="text-xs font-semibold text-gray-700 mb-2">ğŸ“… ê¸°ê°„ ê²€ìƒ‰</p>' +
              '<div class="grid grid-cols-2 gap-2">' +
                '<div><label class="text-xs text-gray-600 block mb-1">ì‹œì‘ì¼</label><input type="date" id="exchangeStatsStartDate" value="' + state.exchangeStatsStartDate + '" onchange="state.exchangeStatsStartDate=this.value;render()" class="w-full px-2 py-1 border rounded text-xs"></div>' +
                '<div><label class="text-xs text-gray-600 block mb-1">ì¢…ë£Œì¼</label><input type="date" id="exchangeStatsEndDate" value="' + state.exchangeStatsEndDate + '" onchange="state.exchangeStatsEndDate=this.value;render()" class="w-full px-2 py-1 border rounded text-xs"></div>' +
              '</div>' +
              ((state.exchangeStatsStartDate || state.exchangeStatsEndDate) ? 
                '<button onclick="state.exchangeStatsStartDate=\'\';state.exchangeStatsEndDate=\'\';render()" class="mt-2 w-full bg-gray-300 text-gray-700 py-1 rounded text-xs font-medium">ê¸°ê°„ ì´ˆê¸°í™”</button>' : '') +
            '</div>' +
          '</div>' +
          '<div class="space-y-3">' + statsItemsHtml + '</div>' +
        '</div>';
      }

      return '<div class="p-3 space-y-3">' +
        '<div class="bg-white rounded-2xl shadow-lg p-2 flex gap-2">' +
          '<button onclick="setExchangeTab(\'USD\')" class="flex-1 py-3 rounded-xl font-bold transition ' + (state.exchangeTab === 'USD' ? 'bg-gradient-to-r from-green-500 to-emerald-500 text-white' : 'bg-gray-100 text-gray-600') + '">ğŸ‡ºğŸ‡¸ USD</button>' +
          '<button onclick="setExchangeTab(\'JPY\')" class="flex-1 py-3 rounded-xl font-bold transition ' + (state.exchangeTab === 'JPY' ? 'bg-gradient-to-r from-red-500 to-pink-500 text-white' : 'bg-gray-100 text-gray-600') + '">ğŸ‡¯ğŸ‡µ JPY</button>' +
        '</div>' +

        '<div class="bg-white rounded-2xl shadow-lg p-4">' +
          '<div class="text-sm text-gray-500 mb-1 text-center">' + (state.exchangeTab === 'USD' ? '1ë‹¬ëŸ¬ë‹¹' : '100ì—”ë‹¹') + '</div>' +
          '<div class="flex items-center justify-center gap-3">' +
            '<span class="text-4xl font-bold text-blue-600">' + currentRate.toFixed(2) + '</span>' +
            '<span class="text-2xl font-bold text-gray-600">ì›</span>' +
            '<button onclick="editExchangeRate()" class="text-blue-600 p-2"><i data-lucide="edit-2" class="w-6 h-6"></i></button>' +
            '<button onclick="fetchExchangeRate()" class="text-green-600 p-2" id="refreshRateBtn"><i data-lucide="refresh-cw" class="w-6 h-6"></i></button>' +
          '</div>' +
        '</div>' +

        '<div class="bg-white rounded-xl shadow-lg p-4">' +
          '<div class="flex items-center justify-between mb-3">' +
            '<div class="flex items-center gap-2">' +
              '<i data-lucide="dollar-sign" class="w-7 h-7 text-green-600"></i>' +
              '<div><h1 class="text-lg font-bold text-gray-800">' + state.exchangeTab + ' ë¶„í• ë§¤ìˆ˜</h1><p class="text-xs text-gray-500">íˆ¬ì í¬íŠ¸í´ë¦¬ì˜¤</p></div>' +
            '</div>' +
          '</div>' +
          '<div class="grid grid-cols-2 gap-2 mb-2">' +
            '<div onclick="editInitialBudget()" class="bg-blue-50 rounded-lg p-2.5 cursor-pointer hover:bg-blue-100 transition"><p class="text-xs text-gray-600 mb-1">ì´ˆê¸°ì˜ˆì‚° âœï¸</p><p class="font-bold text-sm text-blue-600">' + (initialBudget / 10000).toFixed(0) + 'ë§Œì›</p></div>' +
            '<div class="bg-purple-50 rounded-lg p-2.5"><p class="text-xs text-gray-600 mb-1">í˜„ì¬ì˜ˆì‚°</p><p class="font-bold text-sm text-purple-600">' + ((initialBudget + profit) / 10000).toFixed(0) + 'ë§Œì›</p></div>' +
          '</div>' +
          '<div class="grid grid-cols-3 gap-2">' +
            '<div class="bg-indigo-50 rounded-lg p-2.5"><p class="text-xs text-gray-600 mb-1">ëˆ„ì íˆ¬ì</p><p class="font-bold text-sm text-indigo-600">' + (cumInvested / 10000).toFixed(0) + 'ë§Œì›</p></div>' +
            '<div class="bg-green-50 rounded-lg p-2.5"><p class="text-xs text-gray-600 mb-1">ëˆ„ì ë‹¬ëŸ¬</p><p class="font-bold text-sm text-green-600">$' + totalUsd.toFixed(2) + '</p></div>' +
            '<div class="bg-red-50 rounded-lg p-2.5"><p class="text-xs text-gray-600 mb-1">ëˆ„ì ì—”í™”</p><p class="font-bold text-sm text-red-600">Â¥' + totalJpy.toFixed(0) + '</p></div>' +
          '</div>' +
        '</div>' +

        '<div class="' + gradeInfo.bg + ' rounded-xl shadow-lg p-4">' +
          '<div class="flex flex-col items-center">' +
            '<div class="flex items-center justify-center gap-2 mb-3">' +
              '<i data-lucide="trophy" class="w-6 h-6 ' + gradeInfo.color + '"></i>' +
              '<h3 class="text-xl font-bold ' + gradeInfo.color + '">íˆ¬ì ë“±ê¸‰: ' + gradeInfo.grade + '</h3>' +
            '</div>' +
            '<div class="w-full bg-white bg-opacity-50 rounded-lg p-3">' +
              '<div class="text-center">' +
                '<p class="text-xs text-gray-600 mb-1">ëˆ„ì  ì‹¤í˜„ìˆ˜ìµ (ë§¤ë„ì™„ë£Œ)</p>' +
                '<p class="text-2xl font-bold ' + (totalSoldProf >= 0 ? 'text-red-600' : 'text-blue-600') + '">' + (totalSoldProf >= 0 ? '+' : '') + Math.round(totalSoldProf).toLocaleString() + 'ì›</p>' +
                '<p class="text-sm font-semibold mt-1 ' + (totalSoldProf >= 0 ? 'text-red-500' : 'text-blue-500') + '">' + (totalSoldProf >= 0 ? '+' : '') + (totalSoldInv > 0 ? ((totalSoldProf / totalSoldInv) * 100).toFixed(2) : 0) + '%</p>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>' +

        '<div class="bg-white rounded-xl shadow-lg p-4">' +
          '<h3 class="font-bold text-gray-800 mb-3 text-sm">ğŸ“Š íˆ¬ì í˜„í™©</h3>' +
          '<div class="grid grid-cols-2 gap-3">' +
            '<div class="bg-blue-50 rounded p-3"><p class="text-xs text-gray-600 mb-1">ì´ íˆ¬ìê¸ˆ</p><p class="font-bold text-blue-600">' + (invested / 10000).toFixed(0) + 'ë§Œì›</p></div>' +
            '<div class="bg-green-50 rounded p-3"><p class="text-xs text-gray-600 mb-1">ë³´ìœ  ' + state.exchangeTab + '</p><p class="font-bold text-green-600">' + sym + (state.exchangeTab === 'USD' ? foreign.toFixed(2) : foreign.toFixed(0)) + '</p></div>' +
            '<div class="bg-purple-50 rounded p-3"><p class="text-xs text-gray-600 mb-1">í‰ê·  ë§¤ìˆ˜ê°€</p><p class="font-bold text-purple-600">' + avgRate + 'ì›</p></div>' +
            '<div class="bg-orange-50 rounded p-3"><p class="text-xs text-gray-600 mb-1">í‰ê°€ì†ìµ</p><p class="font-bold ' + (unrealized >= 0 ? 'text-red-600' : 'text-blue-600') + '">' + (unrealized >= 0 ? '+' : '') + (unrealized / 10000).toFixed(1) + 'ë§Œì›</p></div>' +
          '</div>' +
        '</div>' +

        '<button onclick="state.showExchangeStats=!state.showExchangeStats;render()" class="w-full bg-gradient-to-r from-emerald-500 to-teal-500 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg">' +
          '<i data-lucide="bar-chart-3" class="w-5 h-5"></i>' +
          (state.showExchangeStats ? 'í†µê³„ ìˆ¨ê¸°ê¸°' : 'ê¸°ê°„ë³„ í†µê³„ ë³´ê¸°') +
        '</button>' +

        statsHtml +

        '<button onclick="addExchangePhase()" class="w-full bg-gradient-to-r from-blue-500 to-purple-500 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg">' +
          '<i data-lucide="plus" class="w-5 h-5"></i> ìƒˆ ë§¤ìˆ˜ ì¶”ê°€' +
        '</button>' +

        '<div class="space-y-3">' + activeHtml + '</div>' +
        soldHtml +
      '</div>';
    }

    function setExchangeTab(tab) {
      state.exchangeTab = tab;
      state.expandedPhase = null;
      render();
    }

    function setExchangeStatsPeriod(period) {
      state.exchangeStatsPeriod = period;
      render();
    }

    function editExchangeRate() {
      var currentRate = state.exchangeTab === 'USD' ? state.usdRate : state.jpyRate;
      var newRate = prompt('í™˜ìœ¨ì„ ì…ë ¥í•˜ì„¸ìš”:', currentRate);
      if (newRate === null) return;
      var rate = parseFloat(newRate);
      if (isNaN(rate) || rate <= 0) { alert('ì˜¬ë°”ë¥¸ í™˜ìœ¨ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
      if (state.exchangeTab === 'USD') state.usdRate = rate;
      else state.jpyRate = rate;
      saveData();
      render();
      showToast('í™˜ìœ¨ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function fetchExchangeRate() {
      var btn = document.getElementById('refreshRateBtn');
      if (btn) btn.innerHTML = '<i data-lucide="refresh-cw" class="w-6 h-6 animate-spin"></i>';
      
      fetch('https://api.exchangerate-api.com/v4/latest/KRW')
        .then(function(res) { return res.json(); })
        .then(function(data) {
          if (data.rates.USD && data.rates.JPY) {
            state.usdRate = Math.round((1 / data.rates.USD) * 10) / 10;
            state.jpyRate = Math.round((100 / data.rates.JPY) * 100) / 100;
            saveData();
            render();
            showToast('í™˜ìœ¨ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤');
          }
        })
        .catch(function(e) {
          showToast('í™˜ìœ¨ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
        });
    }

    function addExchangePhase() {
      var currentRate = state.exchangeTab === 'USD' ? state.usdRate : state.jpyRate;
      var phases = state.exchangeTab === 'USD' ? state.usdPhases : state.jpyPhases;
      var initialBudget = state.exchangeTab === 'USD' ? state.usdInitialBudget : state.jpyInitialBudget;
      
      // Calculate current budget (initial + realized profits)
      var profit = phases.filter(function(p) { return p.sold; }).reduce(function(s, p) { 
        return s + ((p.amount / p.buyRate) * p.sellRate - p.amount); 
      }, 0);
      var currentBudget = initialBudget + profit;
      
      // Calculate total invested (completed but not sold) + pending (not completed)
      var invested = phases.filter(function(p) { return p.completed && !p.sold; }).reduce(function(s, p) { return s + p.amount; }, 0);
      var pending = phases.filter(function(p) { return !p.completed && !p.sold; }).reduce(function(s, p) { return s + p.amount; }, 0);
      var totalNeeded = invested + pending + 1000000; // Adding new 1,000,000 purchase
      
      // Check if total investment would exceed current budget
      if (totalNeeded > currentBudget) {
        var available = currentBudget - invested - pending;
        alert('ì˜ˆì‚° ì´ˆê³¼!\n\ní˜„ì¬ ì˜ˆì‚°: ' + Math.round(currentBudget).toLocaleString() + 'ì›\nì´ë¯¸ íˆ¬ìì¤‘: ' + (invested + pending).toLocaleString() + 'ì›\nì‚¬ìš© ê°€ëŠ¥: ' + Math.round(available).toLocaleString() + 'ì›\n\në§¤ìˆ˜ë¥¼ ì¶”ê°€í•˜ë ¤ë©´ ì´ˆê¸°ì˜ˆì‚°ì„ ëŠ˜ë¦¬ê±°ë‚˜ ê¸°ì¡´ ë§¤ìˆ˜ë¥¼ ë§¤ë„í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      var newPhase = {
        id: state.exchangeTab === 'USD' ? state.usdNextId : state.jpyNextId,
        amount: 1000000,
        buyRate: currentRate,
        sellRate: currentRate + 1.5,
        completed: false,
        sold: false,
        date: '',
        sellDate: ''
      };
      
      if (state.exchangeTab === 'USD') {
        state.usdPhases.push(newPhase);
        state.usdNextId++;
      } else {
        state.jpyPhases.push(newPhase);
        state.jpyNextId++;
      }
      
      state.expandedPhase = newPhase.id;
      saveData();
      render();
      showToast('ìƒˆ ë§¤ìˆ˜ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function toggleExpandPhase(id) {
      state.expandedPhase = state.expandedPhase === id ? null : id;
      render();
    }

    function saveExchangePhase(id) {
      var phases = state.exchangeTab === 'USD' ? state.usdPhases : state.jpyPhases;
      var phase = phases.find(function(p) { return p.id === id; });
      if (!phase) return;
      
      var amountEl = document.getElementById('phase-amount-' + id);
      var buyRateEl = document.getElementById('phase-buyRate-' + id);
      var sellRateEl = document.getElementById('phase-sellRate-' + id);
      
      if (amountEl) phase.amount = parseFloat(amountEl.value) || phase.amount;
      if (buyRateEl) phase.buyRate = parseFloat(buyRateEl.value) || phase.buyRate;
      if (sellRateEl) phase.sellRate = parseFloat(sellRateEl.value) || phase.sellRate;
      
      saveData();
      render();
      showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function completeExchangePhase(id) {
      var phases = state.exchangeTab === 'USD' ? state.usdPhases : state.jpyPhases;
      var phase = phases.find(function(p) { return p.id === id; });
      if (!phase) return;
      
      // Save phase data first
      saveExchangePhase(id);
      
      // Check budget before completing
      var initialBudget = state.exchangeTab === 'USD' ? state.usdInitialBudget : state.jpyInitialBudget;
      var profit = phases.filter(function(p) { return p.sold; }).reduce(function(s, p) { 
        return s + ((p.amount / p.buyRate) * p.sellRate - p.amount); 
      }, 0);
      var currentBudget = initialBudget + profit;
      
      // Calculate total that would be invested after completing this phase
      var invested = phases.filter(function(p) { return p.completed && !p.sold; }).reduce(function(s, p) { return s + p.amount; }, 0);
      var totalAfterComplete = invested + phase.amount;
      
      if (totalAfterComplete > currentBudget) {
        var available = currentBudget - invested;
        alert('ì˜ˆì‚° ì´ˆê³¼!\n\ní˜„ì¬ ì˜ˆì‚°: ' + Math.round(currentBudget).toLocaleString() + 'ì›\nì´ë¯¸ íˆ¬ìì¤‘: ' + invested.toLocaleString() + 'ì›\nì‚¬ìš© ê°€ëŠ¥: ' + Math.round(available).toLocaleString() + 'ì›\nì´ ë§¤ìˆ˜ ê¸ˆì•¡: ' + phase.amount.toLocaleString() + 'ì›\n\në§¤ìˆ˜ë¥¼ ì™„ë£Œí•˜ë ¤ë©´ ì´ˆê¸°ì˜ˆì‚°ì„ ëŠ˜ë¦¬ê±°ë‚˜ ë§¤ìˆ˜ ê¸ˆì•¡ì„ ì¤„ì—¬ì£¼ì„¸ìš”.');
        return;
      }
      
      phase.completed = true;
      phase.date = new Date().toISOString().split('T')[0];
      
      saveData();
      render();
      showToast('ë§¤ìˆ˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function sellExchangePhase(id) {
      var phases = state.exchangeTab === 'USD' ? state.usdPhases : state.jpyPhases;
      var phase = phases.find(function(p) { return p.id === id; });
      if (!phase || !phase.completed) { alert('ë§¤ìˆ˜ë¥¼ ë¨¼ì € ì™„ë£Œí•´ì£¼ì„¸ìš”!'); return; }
      
      var currentRate = state.exchangeTab === 'USD' ? state.usdRate : state.jpyRate;
      phase.sold = true;
      phase.sellDate = new Date().toISOString().split('T')[0];
      phase.sellRate = currentRate;
      
      saveData();
      render();
      showToast('ë§¤ë„ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function deleteExchangePhase(id) {
      if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      
      if (state.exchangeTab === 'USD') {
        state.usdPhases = state.usdPhases.filter(function(p) { return p.id !== id; });
      } else {
        state.jpyPhases = state.jpyPhases.filter(function(p) { return p.id !== id; });
      }
      
      saveData();
      render();
      showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function editInitialBudget() {
      var currentBudget = state.exchangeTab === 'USD' ? state.usdInitialBudget : state.jpyInitialBudget;
      var newBudget = prompt('ì´ˆê¸°ì˜ˆì‚°ì„ ì…ë ¥í•˜ì„¸ìš” (ì›):', currentBudget);
      if (newBudget === null) return;
      var budget = parseInt(newBudget);
      if (isNaN(budget) || budget <= 0) { 
        alert('ì˜¬ë°”ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); 
        return; 
      }
      if (state.exchangeTab === 'USD') {
        state.usdInitialBudget = budget;
      } else {
        state.jpyInitialBudget = budget;
      }
      saveData();
      render();
      showToast('ì´ˆê¸°ì˜ˆì‚°ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    // Add Transaction Modal
    function renderAddTransactionModal() {
      return '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="if(event.target===this){state.showAddTransaction=false;render();}">' +
        '<div class="bg-white rounded-xl w-full max-w-md max-h-[90vh] overflow-y-auto shadow-2xl">' +
          '<div class="p-4 border-b"><h2 class="text-xl font-bold">ê±°ë˜ ì¶”ê°€</h2></div>' +
          '<div class="p-4 space-y-4">' +
            '<div class="flex gap-2">' +
              '<button id="btn-expense" onclick="setTxType(\'expense\')" class="flex-1 py-2 rounded-lg bg-red-500 text-white">ì§€ì¶œ</button>' +
              '<button id="btn-income" onclick="setTxType(\'income\')" class="flex-1 py-2 rounded-lg bg-gray-200">ìˆ˜ì…</button>' +
            '</div>' +
            '<input type="hidden" id="txType" value="expense">' +
            '<div id="fixed-expense-toggle" class="flex items-center gap-3 p-3 bg-purple-50 rounded-lg border border-purple-200">' +
              '<input type="checkbox" id="isFixedExpense" onchange="toggleFixedExpenseMode()" class="w-5 h-5 text-purple-600">' +
              '<label for="isFixedExpense" class="font-medium text-purple-700 cursor-pointer">ğŸ“… ê³ ì •ë¹„ (ë§¤ì›” ìë™ ì…ë ¥)</label>' +
            '</div>' +
            '<div id="regular-expense-form">' +
              '<div class="mb-4"><label class="block text-sm font-medium mb-1">ë‚ ì§œ</label><input type="date" id="txDate" value="' + new Date().toISOString().split('T')[0] + '" class="w-full p-2 border rounded-lg"></div>' +
              '<div class="mb-4"><label class="block text-sm font-medium mb-1">ê¸ˆì•¡</label><input type="text" id="txAmount" class="w-full p-2 border rounded-lg" placeholder="ê¸ˆì•¡ ì…ë ¥" oninput="formatAmountInput(this);updateInstallmentInfo()"></div>' +
            '</div>' +
            '<div id="fixed-expense-form" class="hidden space-y-3">' +
              '<div class="grid grid-cols-2 gap-2">' +
                '<div><label class="block text-sm font-medium mb-1">ì‹œì‘ë‚ ì§œ</label><input type="date" id="feStartDate" value="' + new Date().toISOString().split('T')[0] + '" class="w-full p-2 border rounded-lg"></div>' +
                '<div><label class="block text-sm font-medium mb-1">ì¢…ë£Œë‚ ì§œ</label><input type="date" id="feEndDate" class="w-full p-2 border rounded-lg"></div>' +
              '</div>' +
              '<div class="grid grid-cols-2 gap-2">' +
                '<div><label class="block text-sm font-medium mb-1">ë§¤ì›” ì¶œê¸ˆì¼</label><select id="fePayDay" class="w-full p-2 border rounded-lg">' +
                  Array.from({length: 28}, function(_, i) { return '<option value="' + (i + 1) + '">' + (i + 1) + 'ì¼</option>'; }).join('') +
                '</select></div>' +
                '<div><label class="block text-sm font-medium mb-1">ë§¤ì›” ê¸ˆì•¡</label><input type="text" id="feAmount" class="w-full p-2 border rounded-lg" placeholder="ê¸ˆì•¡" oninput="formatAmountInput(this)"></div>' +
              '</div>' +
              '<div><label class="block text-sm font-medium mb-1">ê²°ì œìˆ˜ë‹¨</label><select id="fePaymentMethod" class="w-full p-2 border rounded-lg"><option value="card">ì¹´ë“œ</option><option value="cash">í˜„ê¸ˆ</option><option value="other">ê¸°íƒ€ì§€ë¶ˆ</option></select></div>' +
              '<div><label class="block text-sm font-medium mb-1">ì¹´í…Œê³ ë¦¬</label><select id="feCategory" class="w-full p-2 border rounded-lg">' +
                '<option value="">ì„ íƒí•˜ì„¸ìš”</option>' +
                state.categories.expense.map(function(c) { return '<option value="' + c + '">' + c + '</option>'; }).join('') +
              '</select></div>' +
              '<div><label class="block text-sm font-medium mb-1">ë©”ëª¨</label><input type="text" id="feMemo" class="w-full p-2 border rounded-lg" placeholder="ë©”ëª¨ ì…ë ¥"></div>' +
              '<div class="bg-purple-100 p-3 rounded-lg text-sm text-purple-700">' +
                'ğŸ’¡ ê³ ì •ë¹„ëŠ” ì‹œì‘ë‚ ì§œë¶€í„° ì¢…ë£Œë‚ ì§œê¹Œì§€ ë§¤ì›” ì¶œê¸ˆì¼ì— ìë™ìœ¼ë¡œ ì§€ì¶œì´ ì…ë ¥ë©ë‹ˆë‹¤.' +
              '</div>' +
            '</div>' +
            '<div id="expense-options">' +
              '<div><label class="block text-sm font-medium mb-1">ê²°ì œìˆ˜ë‹¨</label><select id="txPayment" onchange="toggleInstallment()" class="w-full p-2 border rounded-lg"><option value="card">ì¹´ë“œ</option><option value="cash">í˜„ê¸ˆ</option><option value="other">ê¸°íƒ€ì§€ë¶ˆ</option></select></div>' +
              '<div id="installment-div" class="mt-4"><label class="block text-sm font-medium mb-1">í• ë¶€</label><select id="txInstallment" onchange="updateInstallmentInfo()" class="w-full p-2 border rounded-lg"><option value="0">ì¼ì‹œë¶ˆ</option><option value="2">2ê°œì›”</option><option value="3">3ê°œì›”</option><option value="4">4ê°œì›”</option><option value="5">5ê°œì›”</option><option value="6">6ê°œì›”</option><option value="7">7ê°œì›”</option><option value="8">8ê°œì›”</option><option value="9">9ê°œì›”</option><option value="10">10ê°œì›”</option><option value="11">11ê°œì›”</option><option value="12">12ê°œì›”</option><option value="24">24ê°œì›”</option><option value="36">36ê°œì›”</option><option value="48">48ê°œì›”</option><option value="60">60ê°œì›”</option><option value="72">72ê°œì›”</option></select><div id="installment-info" class="mt-2 p-2 bg-blue-50 rounded-lg text-xs text-blue-700 hidden"></div></div>' +
              '<div class="mt-4"><label class="block text-sm font-medium mb-1">ì§€ì¶œ ìœ í˜•</label>' +
                '<div class="flex gap-2">' +
                  '<button id="btn-necessary" onclick="setNecessary(true)" class="flex-1 py-2 rounded-lg bg-blue-500 text-white">í•„ìš”ì§€ì¶œ</button>' +
                  '<button id="btn-unnecessary" onclick="setNecessary(false)" class="flex-1 py-2 rounded-lg bg-gray-200">ë¶ˆí•„ìš”ì§€ì¶œ</button>' +
                '</div>' +
                '<input type="hidden" id="txNecessary" value="true">' +
              '</div>' +
            '</div>' +
            '<div><label class="block text-sm font-medium mb-1">ì¹´í…Œê³ ë¦¬</label><select id="txCategory" class="w-full p-2 border rounded-lg"><option value="">ì„ íƒí•˜ì„¸ìš”</option>' + state.categories.expense.map(function(c) { return '<option value="' + c + '">' + c + '</option>'; }).join('') + '</select></div>' +
            '<div><label class="block text-sm font-medium mb-1">ë©”ëª¨</label><textarea id="txMemo" class="w-full p-2 border rounded-lg" rows="3" placeholder="ë©”ëª¨ ì…ë ¥"></textarea></div>' +
            '<div class="flex gap-2 pt-4">' +
              '<button onclick="submitTransaction()" class="flex-1 bg-blue-500 text-white py-3 rounded-lg font-medium">ì €ì¥</button>' +
              '<button onclick="state.showAddTransaction=false;render()" class="flex-1 bg-gray-300 py-3 rounded-lg font-medium">ì·¨ì†Œ</button>' +
            '</div>' +
          '</div>' +
        '</div>' +
      '</div>';
    }

    var currentTxType = 'expense';
    var isNecessary = true;
    var isFixedExpenseMode = false;

    function toggleFixedExpenseMode() {
      isFixedExpenseMode = document.getElementById('isFixedExpense').checked;
      var regularForm = document.getElementById('regular-expense-form');
      var fixedForm = document.getElementById('fixed-expense-form');
      var expenseOptions = document.getElementById('expense-options');
      var categoryDiv = document.querySelector('#txCategory').parentElement;
      var memoDiv = document.querySelector('#txMemo').parentElement;
      
      if (isFixedExpenseMode) {
        regularForm.classList.add('hidden');
        fixedForm.classList.remove('hidden');
        expenseOptions.classList.add('hidden');
        categoryDiv.classList.add('hidden');
        memoDiv.classList.add('hidden');
      } else {
        regularForm.classList.remove('hidden');
        fixedForm.classList.add('hidden');
        expenseOptions.classList.remove('hidden');
        categoryDiv.classList.remove('hidden');
        memoDiv.classList.remove('hidden');
      }
    }

    function submitFixedExpense() {
      var startDate = document.getElementById('feStartDate').value;
      var endDate = document.getElementById('feEndDate').value;
      var payDay = parseInt(document.getElementById('fePayDay').value);
      var amount = getAmountValue('feAmount');
      var paymentMethod = document.getElementById('fePaymentMethod').value;
      var category = document.getElementById('feCategory').value;
      var memo = document.getElementById('feMemo').value;

      if (!startDate) { alert('ì‹œì‘ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”'); return false; }
      if (!amount || amount <= 0) { alert('ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return false; }
      if (!category) { alert('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”'); return false; }

      var newFixedExpense = {
        id: Date.now(),
        startDate: startDate,
        endDate: endDate || null,
        payDay: payDay,
        amount: amount,
        paymentMethod: paymentMethod,
        category: category,
        memo: memo,
        active: true,
        createdAt: new Date().toISOString()
      };

      state.fixedExpenses.push(newFixedExpense);
      saveData();
      
      // ì¦‰ì‹œ ìë™ ì…ë ¥ ì‹¤í–‰
      checkAutoFixedExpenses();
      
      return true;
    }

    function editFixedExpense(id) {
      var fe = state.fixedExpenses.find(function(f) { return f.id === id; });
      if (!fe) return;
      
      var newAmount = prompt('ë§¤ì›” ê¸ˆì•¡:', fe.amount.toLocaleString());
      if (newAmount === null) return;
      
      var newEndDate = prompt('ì¢…ë£Œë‚ ì§œ (YYYY-MM-DD, ë¹„ì›Œë‘ë©´ ë¬´ê¸°í•œ):', fe.endDate || '');
      if (newEndDate === null) return;
      
      fe.amount = parseInt(newAmount.replace(/[^\d]/g, ''), 10) || fe.amount;
      fe.endDate = newEndDate || null;
      
      saveData();
      render();
      showToast('ê³ ì •ë¹„ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function deleteFixedExpense(id) {
      if (confirm('ì´ ê³ ì •ë¹„ë¥¼ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        var fe = state.fixedExpenses.find(function(f) { return f.id === id; });
        if (fe) {
          fe.active = false;
          fe.endDate = new Date().toISOString().split('T')[0];
        }
        saveData();
        render();
        showToast('ê³ ì •ë¹„ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    }

    function permanentDeleteFixedExpense(id) {
      if (confirm('ì´ ê³ ì •ë¹„ë¥¼ ì™„ì „íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ê´€ë ¨ ê±°ë˜ ë‚´ì—­ì€ ìœ ì§€ë©ë‹ˆë‹¤)')) {
        state.fixedExpenses = state.fixedExpenses.filter(function(f) { return f.id !== id; });
        saveData();
        render();
        showToast('ê³ ì •ë¹„ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    }

    function setTxType(type) {
      currentTxType = type;
      document.getElementById('txType').value = type;
      document.getElementById('btn-expense').className = type === 'expense' ? 'flex-1 py-2 rounded-lg bg-red-500 text-white' : 'flex-1 py-2 rounded-lg bg-gray-200';
      document.getElementById('btn-income').className = type === 'income' ? 'flex-1 py-2 rounded-lg bg-green-500 text-white' : 'flex-1 py-2 rounded-lg bg-gray-200';
      document.getElementById('expense-options').style.display = type === 'expense' ? 'block' : 'none';
      
      // ê³ ì •ë¹„ í† ê¸€ í‘œì‹œ/ìˆ¨ê¹€
      var fixedExpenseToggle = document.getElementById('fixed-expense-toggle');
      if (fixedExpenseToggle) {
        fixedExpenseToggle.style.display = type === 'expense' ? 'flex' : 'none';
      }
      
      // ìˆ˜ì… ì„ íƒì‹œ ê³ ì •ë¹„ ëª¨ë“œ í•´ì œ
      if (type === 'income') {
        var checkbox = document.getElementById('isFixedExpense');
        if (checkbox && checkbox.checked) {
          checkbox.checked = false;
          isFixedExpenseMode = false;
          document.getElementById('regular-expense-form').classList.remove('hidden');
          document.getElementById('fixed-expense-form').classList.add('hidden');
        }
      }
      
      var catSelect = document.getElementById('txCategory');
      catSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>' + state.categories[type].map(function(c) { return '<option value="' + c + '">' + c + '</option>'; }).join('');
    }

    function setNecessary(val) {
      isNecessary = val;
      document.getElementById('txNecessary').value = val;
      document.getElementById('btn-necessary').className = val ? 'flex-1 py-2 rounded-lg bg-blue-500 text-white' : 'flex-1 py-2 rounded-lg bg-gray-200';
      document.getElementById('btn-unnecessary').className = !val ? 'flex-1 py-2 rounded-lg bg-gray-500 text-white' : 'flex-1 py-2 rounded-lg bg-gray-200';
    }

    function toggleInstallment() {
      var payment = document.getElementById('txPayment').value;
      document.getElementById('installment-div').style.display = payment === 'card' ? 'block' : 'none';
      // ì¹´ë“œê°€ ì•„ë‹Œ ê²½ìš° í• ë¶€ ì„ íƒ ì´ˆê¸°í™”
      if (payment !== 'card') {
        var installmentSelect = document.getElementById('txInstallment');
        if (installmentSelect) installmentSelect.value = '0';
        var installmentInfo = document.getElementById('installment-info');
        if (installmentInfo) installmentInfo.classList.add('hidden');
      }
      updateInstallmentInfo();
    }

    function updateInstallmentInfo() {
      var installmentSelect = document.getElementById('txInstallment');
      var dateInput = document.getElementById('txDate');
      var infoDiv = document.getElementById('installment-info');
      
      if (!installmentSelect || !infoDiv) return;
      
      var installment = Number(installmentSelect.value);
      var amount = getAmountValue('txAmount');
      var date = dateInput ? dateInput.value : '';
      
      if (installment > 1 && amount > 0) {
        var monthlyAmount = Math.round(amount / installment);
        var startDate = date ? new Date(date) : new Date();
        var endDate = new Date(startDate.getFullYear(), startDate.getMonth() + installment - 1, startDate.getDate());
        var endDateStr = endDate.getFullYear() + 'ë…„ ' + (endDate.getMonth() + 1) + 'ì›”';
        
        infoDiv.innerHTML = 'ğŸ’³ <strong>' + installment + 'ê°œì›” í• ë¶€</strong>: ì›” ' + monthlyAmount.toLocaleString() + 'ì›ì”© ìë™ ë¶„í•  ì…ë ¥ë©ë‹ˆë‹¤.<br>' +
                           'ğŸ“… ' + (startDate.getMonth() + 1) + 'ì›”ë¶€í„° ' + endDateStr + 'ê¹Œì§€ ë§¤ì›” ìë™ ë“±ë¡';
        infoDiv.classList.remove('hidden');
      } else {
        infoDiv.classList.add('hidden');
      }
    }

    function submitTransaction() {
      // ê³ ì •ë¹„ ëª¨ë“œì¸ ê²½ìš°
      if (isFixedExpenseMode) {
        if (submitFixedExpense()) {
          state.showAddTransaction = false;
          isFixedExpenseMode = false;
          render();
          showToast('ê³ ì •ë¹„ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
        }
        return;
      }
      
      var type = document.getElementById('txType').value;
      var date = document.getElementById('txDate').value;
      var amount = getAmountValue('txAmount');
      var category = document.getElementById('txCategory').value;
      var memo = document.getElementById('txMemo').value;
      
      if (!category) { alert('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”'); return; }
      if (!amount || amount <= 0) { alert('ì˜¬ë°”ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }

      var paymentMethod = type === 'expense' ? document.getElementById('txPayment').value : 'cash';
      var installment = type === 'expense' && paymentMethod === 'card' ? Number(document.getElementById('txInstallment').value) : 0;
      var isNecessary = type === 'expense' ? document.getElementById('txNecessary').value === 'true' : true;

      // í• ë¶€ì¸ ê²½ìš° ì²« ë‹¬ë§Œ ì…ë ¥í•˜ê³  ë‚˜ë¨¸ì§€ëŠ” ë§¤ì›” ìë™ ì…ë ¥
      if (installment > 1) {
        var monthlyAmount = Math.round(amount / installment);
        var startDate = new Date(date);
        var startYear = startDate.getFullYear();
        var startMonth = startDate.getMonth();
        var startDay = startDate.getDate();
        
        var today = new Date();
        var currentYear = today.getFullYear();
        var currentMonth = today.getMonth();
        
        // ì‹œì‘ì›”ë¶€í„° í˜„ì¬ì›”ê¹Œì§€ ëª‡ ê°œì›” ê²½ê³¼í–ˆëŠ”ì§€ ê³„ì‚°
        var monthsPassed = (currentYear - startYear) * 12 + (currentMonth - startMonth);
        
        // í˜„ì¬ ë‹¬ê¹Œì§€ ì…ë ¥í•´ì•¼ í•  íšŒì°¨ (ìµœëŒ€ totalê¹Œì§€)
        var shouldHaveInstallments = Math.min(monthsPassed + 1, installment);
        
        // 1íšŒì°¨ë¶€í„° í˜„ì¬ê¹Œì§€ ëª¨ë‘ ì…ë ¥
        for (var i = 1; i <= shouldHaveInstallments; i++) {
          var installmentDate = new Date(startYear, startMonth + (i - 1), startDay);
          var dateStr = installmentDate.getFullYear() + '-' + 
                        String(installmentDate.getMonth() + 1).padStart(2, '0') + '-' + 
                        String(installmentDate.getDate()).padStart(2, '0');
          
          state.transactions.push({
            id: Date.now() + Math.random() + i,
            type: type,
            date: dateStr,
            amount: monthlyAmount,
            category: category,
            memo: memo ? memo + ' (' + i + '/' + installment + 'íšŒì°¨)' : 'í• ë¶€ ' + i + '/' + installment + 'íšŒì°¨',
            paymentMethod: paymentMethod,
            installment: installment,
            installmentInfo: { 
              current: i, 
              total: installment, 
              originalAmount: amount,
              startDate: date,
              monthlyAmount: monthlyAmount,
              originalMemo: memo || '',
              originalCategory: category
            },
            isNecessary: isNecessary
          });
        }
        
        if (shouldHaveInstallments < installment) {
          showToast(installment + 'ê°œì›” í• ë¶€ ì¤‘ ' + shouldHaveInstallments + 'íšŒì°¨ê¹Œì§€ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ë‹¬ë¶€í„° ìë™ ì…ë ¥ë©ë‹ˆë‹¤.');
        } else {
          showToast(installment + 'ê°œì›” í• ë¶€ ì „ì²´ê°€ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
      } else {
        state.transactions.push({
          id: Date.now(),
          type: type,
          date: date,
          amount: amount,
          category: category,
          memo: memo,
          paymentMethod: paymentMethod,
          installment: 0,
          isNecessary: isNecessary
        });
        
        showToast('ê±°ë˜ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
      }

      state.showAddTransaction = false;
      saveData();
      render();
    }

    // Add Dividend Modal
    function renderAddDividendModal() {
      var stockOptions = state.investments.map(function(inv) {
        return '<option value="' + inv.name + '">' + inv.name + '</option>';
      }).join('');

      return '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="if(event.target===this){state.showAddDividend=false;render();}">' +
        '<div class="bg-white rounded-xl w-full max-w-md shadow-2xl">' +
          '<div class="p-4 border-b bg-green-50 rounded-t-xl"><h2 class="text-xl font-bold text-green-700">ğŸ’° ë°°ë‹¹ ì¶”ê°€</h2></div>' +
          '<div class="p-4 space-y-4">' +
            '<div>' +
              '<label class="block text-sm font-medium mb-1 text-gray-700">ì¢…ëª©ëª…</label>' +
              '<input type="text" id="divStockName" class="w-full p-3 border rounded-lg" placeholder="ì¢…ëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">' +
              (stockOptions ? '<div class="mt-2"><select onchange="document.getElementById(\'divStockName\').value=this.value" class="w-full p-2 border rounded-lg text-sm bg-gray-50"><option value="">-- ë³´ìœ ì¢…ëª©ì—ì„œ ì„ íƒ --</option>' + stockOptions + '</select></div>' : '') +
            '</div>' +
            '<div>' +
              '<label class="block text-sm font-medium mb-1 text-gray-700">ë°°ë‹¹ì¼</label>' +
              '<input type="date" id="divDate" value="' + new Date().toISOString().split('T')[0] + '" class="w-full p-3 border rounded-lg">' +
            '</div>' +
            '<div>' +
              '<label class="block text-sm font-medium mb-1 text-gray-700">ë°°ë‹¹ê¸ˆ</label>' +
              '<div class="relative">' +
                '<input type="text" id="divAmount" class="w-full p-3 pr-12 border rounded-lg" placeholder="0" oninput="formatAmountInput(this)">' +
                '<span class="absolute right-3 top-3 text-gray-500">ì›</span>' +
              '</div>' +
            '</div>' +
            '<div class="flex gap-2 pt-2">' +
              '<button onclick="addDividend()" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg font-bold transition">ë°°ë‹¹ ì¶”ê°€</button>' +
              '<button onclick="state.showAddDividend=false;render()" class="flex-1 bg-gray-200 hover:bg-gray-300 py-3 rounded-lg font-medium transition">ì·¨ì†Œ</button>' +
            '</div>' +
          '</div>' +
        '</div>' +
      '</div>';
    }

    // Add Journal Modal
    function renderAddJournalModal() {
      return '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="if(event.target===this){state.showAddJournal=false;render();}">' +
        '<div class="bg-white rounded-xl w-full max-w-md max-h-[90vh] overflow-y-auto shadow-2xl">' +
          '<div class="p-4 border-b"><h2 class="text-xl font-bold">ğŸ“ íˆ¬ìì¼ì§€ ì‘ì„±</h2></div>' +
          '<div class="p-4 space-y-4">' +
            '<div><label class="block text-sm font-medium mb-1">ë‚ ì§œ</label><input type="date" id="journalDate" value="' + new Date().toISOString().split('T')[0] + '" class="w-full p-2 border rounded-lg"></div>' +
            '<div><label class="block text-sm font-medium mb-1">ë‚´ìš©</label><textarea id="journalContent" class="w-full p-2 border rounded-lg" rows="6" placeholder="ì˜¤ëŠ˜ì˜ íˆ¬ì ìƒê°, ë§¤ë§¤ ì´ìœ , ì‹œì¥ ë¶„ì„ ë“±ì„ ê¸°ë¡í•˜ì„¸ìš”..."></textarea></div>' +
            '<div class="flex gap-2 pt-4">' +
              '<button onclick="addJournal()" class="flex-1 bg-yellow-500 text-white py-3 rounded-lg font-medium">ì €ì¥</button>' +
              '<button onclick="state.showAddJournal=false;render()" class="flex-1 bg-gray-300 py-3 rounded-lg font-medium">ì·¨ì†Œ</button>' +
            '</div>' +
          '</div>' +
        '</div>' +
      '</div>';
    }

    // Add Investment Modal
    function renderAddInvestmentModal() {
      return '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="if(event.target===this){state.showAddInvestment=false;render();}">' +
        '<div class="bg-white rounded-xl w-full max-w-md max-h-[90vh] overflow-y-auto shadow-2xl">' +
          '<div class="p-4 border-b"><h2 class="text-xl font-bold">ğŸ“ˆ íˆ¬ì ì¢…ëª© ì¶”ê°€</h2></div>' +
          '<div class="p-4 space-y-4">' +
            '<div><label class="block text-sm font-medium mb-1">ì¢…ëª©ëª…</label><input type="text" id="invName" class="w-full p-2 border rounded-lg" placeholder="ì˜ˆ: ì‚¼ì„±ì „ì"></div>' +
            '<div><label class="block text-sm font-medium mb-1">íˆ¬ì ìœ í˜•</label><select id="invType" class="w-full p-2 border rounded-lg"><option value="stock">ğŸ“Š ì£¼ì‹</option><option value="etf">ğŸ“¦ ETF</option><option value="fund">ğŸ’¼ í€ë“œ</option><option value="crypto">ğŸª™ ì•”í˜¸í™”í</option><option value="gold">ğŸ¥‡ ê¸ˆ</option><option value="realestate">ğŸ  ë¶€ë™ì‚°</option><option value="bond">ğŸ“ƒ ì±„ê¶Œ</option><option value="other">ğŸ“„ ê¸°íƒ€</option></select></div>' +
            '<div><label class="block text-sm font-medium mb-1">ë³´ìœ  ìˆ˜ëŸ‰</label><input type="text" id="invQuantity" class="w-full p-2 border rounded-lg" placeholder="0 (ì†Œìˆ˜ì  ê°€ëŠ¥)" oninput="formatQuantityInput(this)"></div>' +
            '<div><label class="block text-sm font-medium mb-1">ë§¤ì…ê°€ (1ì£¼ë‹¹)</label><input type="text" id="invBuyPrice" class="w-full p-2 border rounded-lg" placeholder="0" oninput="formatAmountInput(this)"></div>' +
            '<div><label class="block text-sm font-medium mb-1">í˜„ì¬ê°€ (1ì£¼ë‹¹)</label><input type="text" id="invCurrentPrice" class="w-full p-2 border rounded-lg" placeholder="ë§¤ì…ê°€ì™€ ë™ì¼ì‹œ ë¹„ì›Œë‘ì„¸ìš”" oninput="formatAmountInput(this)"></div>' +
            '<div class="flex gap-2 pt-4">' +
              '<button onclick="addInvestment()" class="flex-1 bg-indigo-500 text-white py-3 rounded-lg font-medium">ì¶”ê°€</button>' +
              '<button onclick="state.showAddInvestment=false;render()" class="flex-1 bg-gray-300 py-3 rounded-lg font-medium">ì·¨ì†Œ</button>' +
            '</div>' +
          '</div>' +
        '</div>' +
      '</div>';
    }

    // Iframe Calculator Modal
    function renderIframeModal() {
      return '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="if(event.target===this){state.showIframeModal=false;render();}">' +
        '<div class="bg-white rounded-2xl w-full max-w-4xl max-h-[95vh] overflow-hidden shadow-2xl">' +
          '<div class="bg-gradient-to-r from-blue-600 to-blue-700 p-4 rounded-t-2xl">' +
            '<div class="flex justify-between items-center">' +
              '<div class="flex items-center gap-3">' +
                '<div class="bg-white bg-opacity-20 p-2 rounded-lg"><span class="text-2xl">ğŸ§®</span></div>' +
                '<div><h2 class="text-xl font-bold text-white">ê³„ì‚°ê¸°</h2><p class="text-blue-200 text-xs">ë‹¤ì–‘í•œ ê¸ˆìœµ ê³„ì‚° ë„êµ¬</p></div>' +
              '</div>' +
              '<button onclick="state.showIframeModal=false;render()" class="text-white text-2xl hover:bg-white hover:bg-opacity-20 rounded-full w-8 h-8 flex items-center justify-center transition">âœ•</button>' +
            '</div>' +
          '</div>' +
          '<div class="w-full" style="height: calc(95vh - 80px);">' +
            '<iframe src="https://parodyextra-dotcom.github.io/an-absolute-strongman7/" class="w-full h-full border-0"></iframe>' +
          '</div>' +
        '</div>' +
      '</div>';
    }

    // Compound Calculator Modal
    function renderCompoundCalc() {
      return '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="if(event.target===this){state.showCompoundCalc=false;render();}">' +
        '<div class="bg-white rounded-2xl w-full max-w-lg max-h-[95vh] overflow-y-auto shadow-2xl">' +
          '<div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-5 rounded-t-2xl">' +
            '<div class="flex justify-between items-center">' +
              '<div class="flex items-center gap-3">' +
                '<div class="bg-white bg-opacity-20 p-2 rounded-lg"><span class="text-2xl">ğŸ’°</span></div>' +
                '<div><h2 class="text-xl font-bold text-white">ì ë¦½ì‹ ë³µë¦¬ê³„ì‚°ê¸°</h2><p class="text-indigo-200 text-xs">ë³µë¦¬ì˜ ë§ˆë²•ì„ ê²½í—˜í•˜ì„¸ìš”</p></div>' +
              '</div>' +
              '<button onclick="state.showCompoundCalc=false;render()" class="text-white text-2xl hover:bg-white hover:bg-opacity-20 rounded-full w-8 h-8 flex items-center justify-center transition">âœ•</button>' +
            '</div>' +
          '</div>' +
          '<div class="p-5 space-y-4">' +
            '<div class="grid grid-cols-2 gap-3">' +
              '<div class="bg-gray-50 p-3 rounded-xl">' +
                '<label class="block text-xs font-medium text-gray-500 mb-1">ğŸ’µ ì´ˆê¸° íˆ¬ìê¸ˆ</label>' +
                '<input type="text" id="calcInitial" class="w-full p-2 border-2 border-gray-200 rounded-lg font-bold text-lg focus:border-indigo-500 focus:outline-none transition" placeholder="0" oninput="formatAmountInput(this)">' +
              '</div>' +
              '<div class="bg-gray-50 p-3 rounded-xl">' +
                '<label class="block text-xs font-medium text-gray-500 mb-1">ğŸ“… ì›” ì ë¦½ê¸ˆ</label>' +
                '<input type="text" id="calcMonthly" class="w-full p-2 border-2 border-gray-200 rounded-lg font-bold text-lg focus:border-indigo-500 focus:outline-none transition" placeholder="0" oninput="formatAmountInput(this)">' +
              '</div>' +
            '</div>' +
            '<div class="grid grid-cols-2 gap-3">' +
              '<div class="bg-gray-50 p-3 rounded-xl">' +
                '<label class="block text-xs font-medium text-gray-500 mb-1">â±ï¸ íˆ¬ì ê¸°ê°„</label>' +
                '<div class="flex items-center gap-2">' +
                  '<input type="number" id="calcYears" class="w-full p-2 border-2 border-gray-200 rounded-lg font-bold text-lg focus:border-indigo-500 focus:outline-none transition" placeholder="0">' +
                  '<span class="text-gray-500 font-medium">ë…„</span>' +
                '</div>' +
              '</div>' +
              '<div class="bg-gray-50 p-3 rounded-xl">' +
                '<label class="block text-xs font-medium text-gray-500 mb-1">ğŸ“ˆ ì—° ìˆ˜ìµë¥ </label>' +
                '<div class="flex items-center gap-2">' +
                  '<input type="number" step="0.1" id="calcRate" class="w-full p-2 border-2 border-gray-200 rounded-lg font-bold text-lg focus:border-indigo-500 focus:outline-none transition" placeholder="0">' +
                  '<span class="text-gray-500 font-medium">%</span>' +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="flex gap-2">' +
              '<button onclick="calculateCompound()" class="flex-1 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white py-3 rounded-xl font-bold shadow-lg transform hover:scale-[1.02] transition flex items-center justify-center gap-2">' +
                '<i data-lucide="calculator" class="w-5 h-5"></i> ê³„ì‚°í•˜ê¸°' +
              '</button>' +
              '<button onclick="resetCompoundCalc()" class="px-4 bg-gray-200 hover:bg-gray-300 text-gray-700 py-3 rounded-xl font-medium transition">' +
                '<i data-lucide="refresh-cw" class="w-5 h-5"></i>' +
              '</button>' +
            '</div>' +
            '<div id="calc-result"></div>' +
          '</div>' +
        '</div>' +
      '</div>';
    }

    function resetCompoundCalc() {
      document.getElementById('calcInitial').value = '';
      document.getElementById('calcMonthly').value = '';
      document.getElementById('calcYears').value = '';
      document.getElementById('calcRate').value = '';
      document.getElementById('calc-result').innerHTML = '';
    }

    function calculateCompound() {
      var initial = getAmountValue('calcInitial');
      var monthly = getAmountValue('calcMonthly');
      var years = Number(document.getElementById('calcYears').value) || 0;
      var rate = Number(document.getElementById('calcRate').value) / 100 || 0;

      if (years === 0) { alert('íˆ¬ì ê¸°ê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
      if (initial === 0 && monthly === 0) { alert('ì´ˆê¸° íˆ¬ìê¸ˆ ë˜ëŠ” ì›” ì ë¦½ê¸ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }

      // ì—°ë„ë³„ ë°ì´í„° ê³„ì‚°
      var yearlyData = [];
      var currentAmount = initial;
      var totalDeposit = initial;
      
      // 0ë…„ì°¨ (ì´ˆê¸°)
      yearlyData.push({
        year: 0,
        totalAmount: initial,
        deposit: initial,
        interest: 0,
        yearlyInterest: 0
      });

      for (var year = 1; year <= years; year++) {
        var yearStartAmount = currentAmount;
        for (var month = 1; month <= 12; month++) {
          currentAmount += monthly;
          currentAmount = currentAmount * (1 + rate / 12);
        }
        totalDeposit += monthly * 12;
        var totalInterest = currentAmount - totalDeposit;
        var yearlyInterest = currentAmount - yearStartAmount - (monthly * 12);
        
        yearlyData.push({
          year: year,
          totalAmount: Math.round(currentAmount),
          deposit: totalDeposit,
          interest: Math.round(totalInterest),
          yearlyInterest: Math.round(yearlyInterest)
        });
      }

      var finalAmount = Math.round(currentAmount);
      var finalDeposit = totalDeposit;
      var totalInterest = finalAmount - finalDeposit;
      var profitRate = finalDeposit > 0 ? ((totalInterest / finalDeposit) * 100).toFixed(1) : 0;
      var maxAmount = finalAmount;

      // ê·¸ë˜í”„ ë°” ìƒì„±
      var chartBarsHtml = yearlyData.map(function(d, idx) {
        var depositHeight = maxAmount > 0 ? (d.deposit / maxAmount * 100) : 0;
        var interestHeight = maxAmount > 0 ? (d.interest / maxAmount * 100) : 0;
        var totalHeight = depositHeight + interestHeight;
        var isLast = idx === yearlyData.length - 1;
        
        return '<div class="flex flex-col items-center flex-1 min-w-[30px]">' +
          '<div class="h-32 w-full flex flex-col justify-end items-center relative">' +
            '<div class="w-full max-w-[24px] rounded-t-md overflow-hidden flex flex-col justify-end" style="height: ' + totalHeight + '%">' +
              (d.interest > 0 ? '<div class="bg-gradient-to-t from-green-400 to-emerald-400 w-full" style="height: ' + (interestHeight / (totalHeight || 1) * 100) + '%"></div>' : '') +
              '<div class="bg-gradient-to-t from-indigo-500 to-purple-500 w-full" style="height: ' + (depositHeight / (totalHeight || 1) * 100) + '%"></div>' +
            '</div>' +
            (isLast ? '<div class="absolute -top-6 text-xs font-bold text-purple-600">' + (d.totalAmount / 10000).toFixed(0) + 'ë§Œ</div>' : '') +
          '</div>' +
          '<div class="text-xs text-gray-500 mt-1 font-medium">' + d.year + 'ë…„</div>' +
        '</div>';
      }).join('');

      // ì—°ë„ë³„ ìƒì„¸ í…Œì´ë¸” (ì „ì²´ í¼ì¹¨)
      var yearlyTableHtml = '<div class="overflow-x-auto">' +
        '<table class="w-full text-sm">' +
          '<thead class="bg-indigo-100">' +
            '<tr>' +
              '<th class="py-2.5 px-2 text-left text-indigo-800 font-bold">ë…„ì°¨</th>' +
              '<th class="py-2.5 px-2 text-right text-indigo-800 font-bold">ì´ ê¸ˆì•¡</th>' +
              '<th class="py-2.5 px-2 text-right text-indigo-800 font-bold">ë‚©ì…ê¸ˆ</th>' +
              '<th class="py-2.5 px-2 text-right text-indigo-800 font-bold">ëˆ„ì  ì´ì</th>' +
              '<th class="py-2.5 px-2 text-right text-indigo-800 font-bold">ì—° ì´ì</th>' +
            '</tr>' +
          '</thead>' +
          '<tbody>' +
            yearlyData.slice(1).map(function(d, idx) {
              var isEven = idx % 2 === 0;
              var isMilestone = d.year % 5 === 0;
              return '<tr class="' + (isMilestone ? 'bg-purple-50 border-l-4 border-purple-400' : (isEven ? 'bg-white' : 'bg-gray-50')) + ' border-b border-gray-200">' +
                '<td class="py-2.5 px-2 font-bold ' + (isMilestone ? 'text-purple-700' : 'text-indigo-700') + '">' + d.year + 'ë…„' + (isMilestone ? ' ğŸ¯' : '') + '</td>' +
                '<td class="py-2.5 px-2 text-right font-bold text-gray-800">' + formatNumber(d.totalAmount) + 'ì›</td>' +
                '<td class="py-2.5 px-2 text-right text-blue-700 font-medium">' + formatNumber(d.deposit) + 'ì›</td>' +
                '<td class="py-2.5 px-2 text-right text-green-700 font-bold">+' + formatNumber(d.interest) + 'ì›</td>' +
                '<td class="py-2.5 px-2 text-right text-emerald-600 font-medium">+' + formatNumber(d.yearlyInterest) + 'ì›</td>' +
              '</tr>';
            }).join('') +
          '</tbody>' +
        '</table>' +
      '</div>';

      // ê²°ê³¼ HTML
      document.getElementById('calc-result').innerHTML = 
        // ìµœì¢… ê²°ê³¼ ì¹´ë“œ
        '<div class="bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-500 p-5 rounded-2xl shadow-xl mt-4 text-white">' +
          '<div class="text-center mb-4">' +
            '<div class="text-indigo-200 text-sm font-medium mb-1">ğŸ¯ ' + years + 'ë…„ í›„ ì˜ˆìƒ ìì‚°</div>' +
            '<div class="text-4xl font-bold">' + formatNumber(finalAmount) + '<span class="text-xl ml-1">ì›</span></div>' +
            '<div class="text-indigo-200 text-sm mt-1">ìˆ˜ìµë¥  +' + profitRate + '%</div>' +
          '</div>' +
          '<div class="grid grid-cols-3 gap-2">' +
            '<div class="bg-white rounded-xl p-3 text-center shadow-md">' +
              '<div class="text-gray-500 text-xs font-medium mb-1">ì´ ë‚©ì…ê¸ˆ</div>' +
              '<div class="font-bold text-xl text-blue-600">' + (finalDeposit / 10000).toFixed(0) + 'ë§Œ</div>' +
            '</div>' +
            '<div class="bg-white rounded-xl p-3 text-center shadow-md">' +
              '<div class="text-gray-500 text-xs font-medium mb-1">ì´ ì´ì</div>' +
              '<div class="font-bold text-xl text-green-600">+' + (totalInterest / 10000).toFixed(0) + 'ë§Œ</div>' +
            '</div>' +
            '<div class="bg-white rounded-xl p-3 text-center shadow-md">' +
              '<div class="text-gray-500 text-xs font-medium mb-1">ì´ì ë¹„ìœ¨</div>' +
              '<div class="font-bold text-xl text-orange-500">' + (finalAmount > 0 ? (totalInterest / finalAmount * 100).toFixed(0) : 0) + '%</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
        
        // ìì‚° ì„±ì¥ ê·¸ë˜í”„
        '<div class="bg-white border border-gray-200 rounded-2xl p-4 mt-4 shadow-sm">' +
          '<div class="flex justify-between items-center mb-3">' +
            '<h4 class="font-bold text-gray-800 flex items-center gap-2"><span>ğŸ“Š</span> ìì‚° ì„±ì¥ ê·¸ë˜í”„</h4>' +
            '<div class="flex items-center gap-3 text-xs">' +
              '<div class="flex items-center gap-1"><div class="w-3 h-3 rounded bg-gradient-to-r from-indigo-500 to-purple-500"></div><span class="text-gray-600">ë‚©ì…ê¸ˆ</span></div>' +
              '<div class="flex items-center gap-1"><div class="w-3 h-3 rounded bg-gradient-to-r from-green-400 to-emerald-400"></div><span class="text-gray-600">ì´ì</span></div>' +
            '</div>' +
          '</div>' +
          '<div class="flex items-end gap-1 px-2 border-b border-gray-200 pb-2">' +
            chartBarsHtml +
          '</div>' +
        '</div>' +
        
        // ì—°ë„ë³„ ìƒì„¸ ë‚´ì—­
        '<div class="bg-white border border-gray-200 rounded-2xl p-4 mt-4 shadow-sm">' +
          '<h4 class="font-bold text-gray-800 flex items-center gap-2 mb-3"><span>ğŸ“‹</span> ì—°ë„ë³„ ìƒì„¸ ë‚´ì—­</h4>' +
          yearlyTableHtml +
        '</div>' +
        
        // ë³µë¦¬ íš¨ê³¼ ì„¤ëª…
        '<div class="bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200 rounded-2xl p-4 mt-4">' +
          '<h4 class="font-bold text-amber-700 flex items-center gap-2 mb-2"><span>ğŸ’¡</span> ë³µë¦¬ì˜ í˜</h4>' +
          '<div class="text-sm text-amber-800 space-y-1">' +
            '<p>â€¢ ë§¤ì›” <strong>' + formatNumber(monthly) + 'ì›</strong>ì”© <strong>' + years + 'ë…„</strong>ê°„ ì ë¦½</p>' +
            '<p>â€¢ ì—° <strong>' + (rate * 100).toFixed(1) + '%</strong> ìˆ˜ìµë¥ ë¡œ ë³µë¦¬ ì ìš©</p>' +
            '<p>â€¢ ë³µë¦¬ íš¨ê³¼ë¡œ <strong>' + formatNumber(totalInterest) + 'ì›</strong>ì˜ ì¶”ê°€ ìˆ˜ìµ ë°œìƒ!</p>' +
            (totalInterest > finalDeposit ? '<p class="text-orange-600 font-bold">ğŸ”¥ ì´ìê°€ ë‚©ì…ê¸ˆì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤!</p>' : '') +
          '</div>' +
        '</div>';

      lucide.createIcons();
    }

    // Settings Modal
    function renderSettings() {
      var categoryListHtml = state.categories[currentCatType].map(function(c, i) {
        return '<div class="flex justify-between items-center p-2 border rounded bg-gray-50">' +
          '<span>' + c + '</span>' +
          '<button onclick="deleteCategory(\'' + currentCatType + '\',' + i + ')" class="text-red-500 text-sm px-2">ì‚­ì œ</button>' +
        '</div>';
      }).join('');
      
      var fixedCategoryListHtml = (state.categories.fixedExpense || []).map(function(c, i) {
        return '<div class="flex justify-between items-center p-2 border rounded bg-purple-50">' +
          '<span>' + c + '</span>' +
          '<button onclick="deleteFixedCategory(' + i + ')" class="text-red-500 text-sm px-2">ì‚­ì œ</button>' +
        '</div>';
      }).join('');

      return '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="if(event.target===this){state.showSettings=false;render();}">' +
        '<div class="bg-white rounded-xl w-full max-w-md max-h-[90vh] overflow-y-auto shadow-2xl">' +
          '<div class="p-4 border-b flex justify-between items-center"><h2 class="text-xl font-bold">âš™ï¸ ì„¤ì •</h2><button onclick="state.showSettings=false;render()" class="text-gray-500 text-2xl">âœ•</button></div>' +
          '<div class="p-4 space-y-6">' +
            '<div class="bg-white rounded-xl border shadow-sm p-4">' +
              '<h3 class="font-bold mb-4">ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</h3>' +
              '<div class="flex gap-2 mb-4">' +
                '<button id="cat-expense-btn" onclick="setCatType(\'expense\')" class="flex-1 py-2 rounded-lg bg-red-500 text-white">ì§€ì¶œ</button>' +
                '<button id="cat-income-btn" onclick="setCatType(\'income\')" class="flex-1 py-2 rounded-lg bg-gray-200">ìˆ˜ì…</button>' +
              '</div>' +
              '<div class="space-y-2 mb-4 max-h-48 overflow-y-auto" id="category-list">' + categoryListHtml + '</div>' +
              '<div class="flex gap-2">' +
                '<input type="text" id="newCatName" class="flex-1 p-2 border rounded-lg" placeholder="ìƒˆ ì¹´í…Œê³ ë¦¬ ì´ë¦„">' +
                '<button onclick="addCategory()" class="bg-blue-500 text-white px-4 py-2 rounded-lg">ì¶”ê°€</button>' +
              '</div>' +
            '</div>' +
            '<div class="bg-white rounded-xl border shadow-sm p-4">' +
              '<h3 class="font-bold mb-4">ë°ì´í„° ê´€ë¦¬</h3>' +
              '<div class="space-y-3">' +
                '<button onclick="exportData()" class="w-full bg-blue-500 text-white py-3 rounded-lg font-medium">ë°ì´í„° ë°±ì—… (JSON)</button>' +
                '<button onclick="exportToCSV()" class="w-full bg-green-500 text-white py-3 rounded-lg font-medium">ê±°ë˜ë‚´ì—­ ë‚´ë³´ë‚´ê¸° (CSV)</button>' +
                '<input type="file" id="importFile" accept=".json" onchange="importData(event)" class="hidden">' +
                '<button onclick="document.getElementById(\'importFile\').click()" class="w-full bg-purple-500 text-white py-3 rounded-lg font-medium">ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (JSON)</button>' +
                '<button onclick="resetAllData()" class="w-full bg-red-500 text-white py-3 rounded-lg font-medium">ëª¨ë“  ë°ì´í„° ì‚­ì œ</button>' +
              '</div>' +
            '</div>' +
            '<div class="bg-white rounded-xl border shadow-sm p-4">' +
              '<h3 class="font-bold mb-2">ì•± ì •ë³´</h3>' +
              '<div class="text-sm text-gray-600 space-y-1">' +
                '<p>ë²„ì „: 2.0</p>' +
                '<p>ì´ ê±°ë˜: ' + state.transactions.length + 'ê±´</p>' +
                '<p>ì´ íˆ¬ì: ' + state.investments.length + 'ê°œ</p>' +
                '<p>ì´ ëŒ€ì¶œ: ' + state.loans.length + 'ê±´</p>' +
                '<p>USD ê±°ë˜: ' + state.usdPhases.length + 'ê±´</p>' +
                '<p>JPY ê±°ë˜: ' + state.jpyPhases.length + 'ê±´</p>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
      '</div>';
    }

    var currentCatType = 'expense';

    function setCatType(type) {
      currentCatType = type;
      var expBtn = document.getElementById('cat-expense-btn');
      var incBtn = document.getElementById('cat-income-btn');
      if (expBtn) expBtn.className = type === 'expense' ? 'flex-1 py-2 rounded-lg bg-red-500 text-white' : 'flex-1 py-2 rounded-lg bg-gray-200';
      if (incBtn) incBtn.className = type === 'income' ? 'flex-1 py-2 rounded-lg bg-green-500 text-white' : 'flex-1 py-2 rounded-lg bg-gray-200';
      updateCategoryList();
    }

    function updateCategoryList() {
      var listEl = document.getElementById('category-list');
      if (!listEl) return;
      listEl.innerHTML = state.categories[currentCatType].map(function(c, i) {
        return '<div class="flex justify-between items-center p-2 border rounded bg-gray-50">' +
          '<span>' + c + '</span>' +
          '<button onclick="deleteCategory(\'' + currentCatType + '\',' + i + ')" class="text-red-500 text-sm px-2">ì‚­ì œ</button>' +
        '</div>';
      }).join('');
    }

    function addCategory() {
      var nameEl = document.getElementById('newCatName');
      var name = nameEl ? nameEl.value.trim() : '';
      if (!name) { alert('ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
      state.categories[currentCatType].push(name);
      saveData();
      nameEl.value = '';
      updateCategoryList();
      showToast('ì¹´í…Œê³ ë¦¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function deleteCategory(type, index) {
      if (confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        state.categories[type].splice(index, 1);
        saveData();
        updateCategoryList();
        showToast('ì¹´í…Œê³ ë¦¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    }

    function resetAllData() {
      if (confirm('ì •ë§ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?') && confirm('ë‹¤ì‹œ í•œë²ˆ í™•ì¸í•©ë‹ˆë‹¤.')) {
        state.transactions = [];
        state.memos = [];
        state.events = [];
        state.bankBalances = [];
        state.investments = [];
        state.dividends = [];
        state.investmentJournals = [];
        state.loans = [];
        state.goals = { year7: '', year5: '', year3: '', thisYear: '' };
        state.undoStack = [];
        state.usdPhases = [];
        state.jpyPhases = [];
        state.usdNextId = 1;
        state.jpyNextId = 1;
        saveData();
        state.showSettings = false;
        render();
        showToast('ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    }

    // Render Navbar
    function renderNavbar() {
      var tabs = [
        { id: 'home', icon: 'home', label: 'í™ˆ' },
        { id: 'history', icon: 'file-text', label: 'ë‚´ì—­' },
        { id: 'stats', icon: 'bar-chart-3', label: 'í†µê³„' },
        { id: 'add', icon: 'plus', label: '' },
        { id: 'goal', icon: 'target', label: 'ëª©í‘œ' },
        { id: 'invest', icon: 'trending-up', label: 'íˆ¬ì' },
        { id: 'exchange', icon: 'coins', label: 'í™˜ì „' }
      ];

      var tabsHtml = tabs.map(function(t) {
        if (t.id === 'add') {
          return '<button onclick="state.showAddTransaction=true;render()" class="flex flex-col items-center p-2 -mt-8">' +
            '<div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-full p-4 shadow-2xl hover:scale-110 transition transform">' +
              '<i data-lucide="plus" class="w-7 h-7" style="stroke-width: 3"></i>' +
            '</div>' +
          '</button>';
        }
        return '<button onclick="setActiveTab(\'' + t.id + '\')" class="flex flex-col items-center p-2 rounded-lg transition ' + (state.activeTab === t.id ? 'text-blue-600 bg-blue-50' : 'text-gray-400') + '">' +
          '<i data-lucide="' + t.icon + '" class="w-5 h-5"></i>' +
          '<span class="text-xs mt-1 font-medium">' + t.label + '</span>' +
        '</button>';
      }).join('');

      return '<div class="fixed bottom-0 left-0 right-0 bg-white border-t shadow-2xl max-w-md mx-auto">' +
        '<div class="flex justify-around items-center p-2">' + tabsHtml + '</div>' +
      '</div>';
    }

    function setActiveTab(tab) {
      state.activeTab = tab;
      render();
    }

    // Update date/time display function
    function updateDateTime() {
      var dateTimeEl = document.getElementById('current-datetime');
      if (!dateTimeEl) return;
      
      var now = new Date();
      var dayNames = ['ì¼ìš”ì¼', 'ì›”ìš”ì¼', 'í™”ìš”ì¼', 'ìˆ˜ìš”ì¼', 'ëª©ìš”ì¼', 'ê¸ˆìš”ì¼', 'í† ìš”ì¼'];
      var year = now.getFullYear();
      var month = String(now.getMonth() + 1).padStart(2, '0');
      var day = String(now.getDate()).padStart(2, '0');
      var dayName = dayNames[now.getDay()];
      var hours = String(now.getHours()).padStart(2, '0');
      var minutes = String(now.getMinutes()).padStart(2, '0');
      var seconds = String(now.getSeconds()).padStart(2, '0');
      
      dateTimeEl.textContent = year + 'ë…„ ' + month + 'ì›” ' + day + 'ì¼ ' + dayName + ' ' + hours + ':' + minutes + ':' + seconds;
    }

    // Start clock update interval
    setInterval(updateDateTime, 1000);

    // Main render function
    function render() {
      var app = document.getElementById('app');
      
      if (state.isLoading) {
        app.innerHTML = '<div class="flex items-center justify-center min-h-screen">' +
          '<div class="text-center">' +
            '<div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>' +
            '<div class="text-gray-600">ë°ì´í„° ë¡œë”© ì¤‘...</div>' +
          '</div>' +
        '</div>';
        return;
      }

      var content = '';
      if (state.activeTab === 'home') content = renderHomeScreen();
      else if (state.activeTab === 'history') content = renderHistoryScreen();
      else if (state.activeTab === 'stats') content = renderStatsScreen();
      else if (state.activeTab === 'goal') content = renderGoalScreen();
      else if (state.activeTab === 'invest') content = renderInvestmentScreen();
      else if (state.activeTab === 'exchange') content = renderExchangeScreen();

      var modals = '';
      if (state.showAddTransaction) modals += renderAddTransactionModal();
      if (state.showCompoundCalc) modals += renderCompoundCalc();
      if (state.showSettings) modals += renderSettings();
      if (state.showAddInvestment) modals += renderAddInvestmentModal();
      if (state.showAddDividend) modals += renderAddDividendModal();
      if (state.showAddJournal) modals += renderAddJournalModal();
      if (state.showRankInfo) modals += renderRankInfoModal();
      if (state.showIframeModal) modals += renderIframeModal();

      app.innerHTML = renderHeader() + '<div class="pb-4">' + content + '</div>' + renderNavbar() + modals;

      lucide.createIcons();

      // Update current date/time display
      updateDateTime();

      // Post-render updates
      setTimeout(function() {
        if (state.activeTab === 'history') {
          updateHistoryList();
          var startDate = document.getElementById('startDate');
          var endDate = document.getElementById('endDate');
          var searchKeyword = document.getElementById('searchKeyword');
          if (startDate) startDate.addEventListener('change', updateHistoryList);
          if (endDate) endDate.addEventListener('change', updateHistoryList);
          if (searchKeyword) searchKeyword.addEventListener('input', updateHistoryList);
        }
        if (state.activeTab === 'stats') updateStatsContent();
      }, 0);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      loadData();
    });
  </script>
</body>
</html>
